<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Parceria - Empire Marques Hotel & HUB Transfer</title>
    
    <!-- Google Maps API com callback e tratamento de erros -->
    <script>
        function initMap() {
            // Callback quando o Maps carrega
            console.log('✅ Google Maps carregado com sucesso!');
            if (typeof initializeAutocomplete === 'function') {
                initializeAutocomplete();
            }
        }
        
        // Tratamento de erro do Google Maps
        window.gm_authFailure = function() {
            console.error('❌ Erro de autenticação do Google Maps');
            console.log('Usando sistema de sugestões local');
            // Usar fallback sem Google Maps
            if (typeof initializeAutocompleteWithoutGoogle === 'function') {
                initializeAutocompleteWithoutGoogle();
            }
        };
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBe4UwnVYRP5KAUOtHg3diD6kPTif3VN30&libraries=places&callback=initMap">
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .company-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-top: 20px;
        }

        .company-logo {
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .service-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-service {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-service:hover {
            border-color: #3498db;
            background: #e7f3ff;
            transform: translateY(-2px);
        }

        .btn-service.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .tour-selector {
            display: none;
            margin-bottom: 15px;
        }

        .tour-selector.show {
            display: block;
        }

        .price-calculation-box {
            background: linear-gradient(135deg, #e7f3ff 0%, #cce5ff 100%);
            border: 2px solid #3498db;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .price-calculation-box.show {
            display: block;
        }

        .calculation-header {
            color: #2c3e50;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .calculation-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .calculation-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .calculation-row:last-child {
            border-bottom: none;
        }

        .calculation-label {
            color: #6c757d;
            font-weight: 600;
        }

        .calculation-value {
            color: #2c3e50;
            font-weight: 700;
        }

        .calculation-total {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .admin-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #6c757d;
            color: white;
            padding: 10px 15px;
            border-radius: 50px;
            cursor: pointer;
            z-index: 1000;
            font-size: 0.9rem;
            display: none;
        }

        .admin-fields {
            display: none;
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .admin-fields.show {
            display: block;
        }

        .config-section {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 25px;
            border: 3px solid #f39c12;
            border-radius: 15px;
            margin: 20px;
            display: none;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        .config-section.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .config-title {
            color: #d35400;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.4rem;
            text-align: center;
        }

        .config-form {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .config-input {
            flex: 1;
            min-width: 300px;
        }

        .config-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #d35400;
            font-size: 1rem;
        }

        .config-input input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #f39c12;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .config-input input:focus {
            outline: none;
            border-color: #e67e22;
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
        }

        .status-message {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .quick-add {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-bottom: 3px solid #3498db;
        }

        .quick-add h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        input, select, textarea {
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .btn-export {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-export:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
        }

        .btn-clear {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        .btn-clear:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(149, 165, 166, 0.3);
        }

        .btn-config {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            font-size: 0.9rem;
            padding: 12px 20px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .date-buttons, .time-buttons, .location-buttons, 
        .price-buttons, .payment-buttons, .payment-to-buttons, .obs-buttons,
        .people-buttons, .baggage-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .btn-date, .btn-time, .btn-location, 
        .btn-price, .btn-payment, .btn-payment-to, .btn-obs,
        .btn-people, .btn-baggage {
            padding: 10px 14px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: white;
            color: #495057;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .btn-date:hover, .btn-time:hover, 
        .btn-location:hover, .btn-price:hover, .btn-payment:hover, 
        .btn-payment-to:hover, .btn-obs:hover,
        .btn-people:hover, .btn-baggage:hover {
            border-color: #3498db;
            background: #e7f3ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.2);
        }

        .btn-date.active, .btn-time.active, 
        .btn-location.active, .btn-price.active, .btn-payment.active, 
        .btn-payment-to.active, .btn-obs.active,
        .btn-people.active, .btn-baggage.active {
            background: #3498db;
            color: white;
            border-color: #2980b9;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .btn-people {
            min-width: 50px;
            font-size: 1.1rem;
            border-color: #9b59b6;
            color: #9b59b6;
        }

        .btn-people:hover, .btn-people.active {
            background: #9b59b6;
            color: white;
            border-color: #8e44ad;
        }

        .btn-baggage {
            min-width: 50px;
            font-size: 1.1rem;
            border-color: #e67e22;
            color: #e67e22;
        }

        .btn-baggage:hover, .btn-baggage.active {
            background: #e67e22;
            color: white;
            border-color: #d35400;
        }

        .btn-location {
            min-width: 160px;
            text-align: center;
        }

        .origem-btn {
            border-left: 4px solid #e74c3c;
        }

        .destino-btn {
            border-left: 4px solid #27ae60;
        }

        .btn-payment {
            min-width: 130px;
            font-size: 1rem;
        }

        .btn-payment-to {
            min-width: 140px;
            font-size: 1rem;
        }

        .btn-price {
            font-weight: 700;
            color: #27ae60;
            border-color: #27ae60;
        }

        .btn-price:hover, .btn-price.active {
            background: #27ae60;
            color: white;
        }

        .btn-obs {
            font-size: 0.85rem;
            background: #f8f9fa;
        }

        .summary-section {
            padding: 30px;
            background: #f8f9fa;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .summary-label {
            color: #7f8c8d;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .financial-summary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
        }

        .financial-item {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
        }

        .financial-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .financial-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .services-section {
            padding: 30px;
        }

        .services-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .services-title {
            color: #2c3e50;
            font-size: 2rem;
            font-weight: 700;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 140px;
        }

        .filter-group label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .services-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px 15px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.95rem;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-solicitado {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmado {
            background: #d4edda;
            color: #155724;
        }

        .status-finalizado {
            background: #cce5ff;
            color: #004085;
        }

        .status-cancelado {
            background: #f8d7da;
            color: #721c24;
        }

        .payment-method {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .payment-cash {
            background: #d4edda;
            color: #155724;
        }

        .payment-card {
            background: #cce5ff;
            color: #004085;
        }

        .payment-transfer {
            background: #fff3cd;
            color: #856404;
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 0.75rem;
            border-radius: 6px;
            min-width: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .btn-sheets {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border: none;
        }

        .btn-sheets:hover {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
        }

        .btn-sheets:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .client-info {
            font-weight: 600;
            color: #2c3e50;
        }

        .value-highlight {
            font-weight: 700;
            color: #27ae60;
            font-size: 1.1rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .pago-para {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .pago-recepcao {
            background: #e7f3ff;
            color: #004085;
        }

        .pago-motorista {
            background: #d4edda;
            color: #155724;
        }

        .pac-container {
            z-index: 9999;
        }

        .phone-container {
            position: relative;
        }

        .iti {
            width: 100%;
        }

        .iti__country-list {
            z-index: 9999;
        }

        .iti__selected-flag {
            padding: 14px 12px;
        }

        .iti__flag-container {
            padding: 0;
        }

        #contacto {
            padding-left: 60px;
        }

        .clear-data-section {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            padding: 25px;
            margin: 20px;
            border-radius: 15px;
            border: 3px solid #f44336;
            display: none;
        }

        .clear-data-section.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .clear-data-title {
            color: #c62828;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.4rem;
            text-align: center;
        }

        .clear-data-warning {
            background: #ffebee;
            border: 2px solid #f44336;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #c62828;
            font-weight: 600;
            text-align: center;
        }

        .clear-data-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .financial-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .services-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .company-logos {
                flex-direction: column;
                gap: 15px;
            }

            .config-form {
                flex-direction: column;
            }

            .config-input {
                min-width: 100%;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .btn-danger.pulse {
            animation: pulse 1s infinite;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>🤝 Sistema de Parceria</h1>
            <p>Gestão de Transfers - Colaboração Empresarial</p>
            <div class="company-logos">
                <div class="company-logo">🏨 Empire Marques Hotel</div>
                <div class="company-logo">🚐 HUB Transfer</div>
            </div>
        </div>

        <!-- Seção de Configuração -->
        <div class="config-section" id="configSection">
            <div class="config-title">🔗 Configuração do Google Sheets</div>
            <div class="config-form">
                <div class="config-input">
                    <label for="webappUrl">URL do Google Apps Script:</label>
                    <!-- FUSÃO: Mantendo URL funcional do código antigo -->
                    <input type="url" id="webappUrl" value="https://script.google.com/macros/s/AKfycbyLR-ExtSDDPAPYZDovF61O36IRk4SpIzQhc2W533PC5pwfdXxDKDcLsuku4eYodAyJGg/exec" placeholder="https://script.google.com/macros/s/...">
                </div>
                <button type="button" class="btn btn-success" onclick="testConnection()" id="testBtn">
                    🔗 Testar Conexão
                </button>
                <button type="button" class="btn btn-export" onclick="toggleConfig()">
                    🔒 Fechar
                </button>
            </div>
            <div id="connectionStatus" class="status-message"></div>
        </div>

        <!-- Seção de Limpeza de Dados -->
        <div class="clear-data-section" id="clearDataSection">
            <div class="clear-data-title">🗑️ Limpeza de Dados</div>
            <div class="clear-data-warning">
                ⚠️ ATENÇÃO: Esta operação irá remover PERMANENTEMENTE todos os registros de transfers do sistema!
                <br>Esta ação não pode ser desfeita.
            </div>
            <div class="clear-data-actions">
                <button type="button" class="btn btn-danger" onclick="clearAllData()" id="clearDataBtn">
                    🗑️ Limpar Todos os Dados
                </button>
                <button type="button" class="btn btn-warning" onclick="clearTestData()" id="clearTestBtn">
                    🧹 Limpar Apenas Testes
                </button>
                <button type="button" class="btn btn-clear" onclick="toggleClearData()">
                    🔒 Fechar
                </button>
            </div>
        </div>

        <div class="quick-add">
            <h2>➕ Solicitar Novo Transfer</h2>
            
            <form id="transferForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nomeCliente">Nome do Cliente *</label>
                        <input type="text" id="nomeCliente" required placeholder="Ex: João Silva">
                    </div>
                    
                    <!-- Tipo de Serviço - FUNCIONALIDADE DO CÓDIGO NOVO -->
                    <div class="form-group">
                        <label for="tipoServico">Tipo de Serviço</label>
                        <div class="service-buttons">
                            <button type="button" class="btn-service" onclick="setServiceType('transfer')">
                                🚕 Transfer
                            </button>
                            <button type="button" class="btn-service" onclick="setServiceType('tour')">
                                🚐 Tour Regular
                            </button>
                            <button type="button" class="btn-service" onclick="setServiceType('private')">
                                🚗 Private Tour
                            </button>
                        </div>
                    </div>
                    
                    <!-- Seletor de Tours - FUNCIONALIDADE DO CÓDIGO NOVO -->
                    <div class="form-group tour-selector" id="tourSelector">
                        <label for="tourSelecionado">Selecione o Tour</label>
                        <select id="tourSelecionado" onchange="updateTourPrice()">
                            <option value="">Escolha o tour...</option>
                            <optgroup label="Tours Regulares (Por Pessoa)">
                                <option value="tour-sintra-cascais" data-price="67" data-type="regular">
                                    Sintra e Cascais (8h) - €67/pessoa
                                </option>
                                <option value="tour-fatima-obidos" data-price="83" data-type="regular">
                                    Fátima e Óbidos (8h) - €83/pessoa
                                </option>
                                <option value="tour-combo-2dias" data-price="138" data-type="regular">
                                    Combo 2 Dias (16h) - €138/pessoa
                                </option>
                            </optgroup>
                            <optgroup label="Private Tours (Por Grupo)">
                                <option value="private-sintra-palaces" data-price-small="347" data-price-large="492" data-type="private">
                                    Palaces of Sintra - €347 (1-3) / €492 (4-8)
                                </option>
                                <option value="private-evora" data-price-small="347" data-price-large="492" data-type="private">
                                    Évora City - €347 (1-3) / €492 (4-8)
                                </option>
                                <option value="private-templars" data-price-small="347" data-price-large="492" data-type="private">
                                    Templars - €347 (1-3) / €492 (4-8)
                                </option>
                                <option value="private-arrabida" data-price-small="347" data-price-large="492" data-type="private">
                                    Arrábida - €347 (1-3) / €492 (4-8)
                                </option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="numeroPessoas">Número de Pessoas *</label>
                        <div class="people-buttons">
                            <button type="button" class="btn-people" onclick="setPeople(1)">1</button>
                            <button type="button" class="btn-people" onclick="setPeople(2)">2</button>
                            <button type="button" class="btn-people" onclick="setPeople(3)">3</button>
                            <button type="button" class="btn-people" onclick="setPeople(4)">4</button>
                            <button type="button" class="btn-people" onclick="setPeople(5)">5</button>
                            <button type="button" class="btn-people" onclick="setPeople(6)">6</button>
                            <button type="button" class="btn-people" onclick="setPeople(7)">7</button>
                            <button type="button" class="btn-people" onclick="setPeople(8)">8+</button>
                        </div>
                        <input type="number" id="numeroPessoas" min="1" max="20" required style="display: none;" onchange="updateCalculation()">
                    </div>
                    
                    <div class="form-group">
                        <label for="numeroBagagens">Número de Bagagens</label>
                        <div class="baggage-buttons">
                            <button type="button" class="btn-baggage" onclick="setBaggage(0)">0</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(1)">1</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(2)">2</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(3)">3</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(4)">4</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(5)">5</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(6)">6+</button>
                        </div>
                        <input type="number" id="numeroBagagens" min="0" max="20" value="0" style="display: none;">
                    </div>
                    
                    <div class="form-group">
                        <label for="data">Data do Transfer *</label>
                        <div class="date-buttons">
                            <button type="button" class="btn-date" onclick="setDate('today')">Hoje</button>
                            <button type="button" class="btn-date" onclick="setDate('tomorrow')">Amanhã</button>
                        </div>
                        <input type="date" id="data" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="horaPickup">Hora de Pick-up *</label>
                        <div class="time-buttons">
                            <button type="button" class="btn-time" onclick="setTime('06:00')">06:00</button>
                            <button type="button" class="btn-time" onclick="setTime('07:00')">07:00</button>
                            <button type="button" class="btn-time" onclick="setTime('08:00')">08:00</button>
                            <button type="button" class="btn-time" onclick="setTime('09:00')">09:00</button>
                            <button type="button" class="btn-time" onclick="setTime('10:00')">10:00</button>
                            <button type="button" class="btn-time" onclick="setTime('11:00')">11:00</button>
                        </div>
                        <div class="time-buttons" style="margin-top: 10px;">
                            <button type="button" class="btn-time" onclick="setTime('12:00')">12:00</button>
                            <button type="button" class="btn-time" onclick="setTime('13:00')">13:00</button>
                            <button type="button" class="btn-time" onclick="setTime('14:00')">14:00</button>
                            <button type="button" class="btn-time" onclick="setTime('15:00')">15:00</button>
                            <button type="button" class="btn-time" onclick="setTime('16:00')">16:00</button>
                            <button type="button" class="btn-time" onclick="setTime('17:00')">17:00</button>
                        </div>
                        <div class="time-buttons" style="margin-top: 10px;">
                            <button type="button" class="btn-time" onclick="setTime('18:00')">18:00</button>
                            <button type="button" class="btn-time" onclick="setTime('19:00')">19:00</button>
                            <button type="button" class="btn-time" onclick="setTime('20:00')">20:00</button>
                            <button type="button" class="btn-time" onclick="setTime('21:00')">21:00</button>
                            <button type="button" class="btn-time" onclick="setTime('22:00')">22:00</button>
                            <button type="button" class="btn-time" onclick="setTime('23:00')">23:00</button>
                        </div>
                        <input type="time" id="horaPickup" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="contacto">Contacto do Cliente *</label>
                        <div class="phone-container">
                            <input type="tel" id="contacto" required placeholder="Digite o número...">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="numeroVoo">Número do Voo</label>
                        <input type="text" id="numeroVoo" placeholder="Ex: TP1234">
                    </div>
                    
                    <div class="form-group">
                        <label for="origem">Local de Origem *</label>
                        <div class="location-buttons">
                            <button type="button" class="btn-location origem-btn" onclick="setOrigin('Aeroporto de Lisboa')">
                                ✈️ Aeroporto de Lisboa
                            </button>
                            <!-- FUSÃO: Usando nome do hotel do código NOVO -->
                            <button type="button" class="btn-location origem-btn" onclick="setOrigin('Empire Marques Hotel')">
                                🏨 Empire Marques Hotel
                            </button>
                        </div>
                        <input type="text" id="origem" required placeholder="Digite ou escolha o endereço...">
                    </div>
                    
                    <div class="form-group">
                        <label for="destino">Local de Destino *</label>
                        <div class="location-buttons">
                            <!-- FUSÃO: Usando nome do hotel do código NOVO -->
                            <button type="button" class="btn-location destino-btn" onclick="setDestination('Empire Marques Hotel')">
                                🏨 Empire Marques Hotel
                            </button>
                            <button type="button" class="btn-location destino-btn" onclick="setDestination('Aeroporto de Lisboa')">
                                ✈️ Aeroporto de Lisboa
                            </button>
                        </div>
                        <input type="text" id="destino" required placeholder="Digite ou escolha o endereço...">
                    </div>
                    
                    <div class="form-group">
                        <label for="valorTotal">Valor do Serviço (€) *</label>
                        <div class="price-buttons">
                            <button type="button" class="btn-price" onclick="setPrice(25)">€25</button>
                            <button type="button" class="btn-price" onclick="setPrice(35)">€35</button>
                            <button type="button" class="btn-price" onclick="setPrice(45)">€45</button>
                            <button type="button" class="btn-price" onclick="setPrice(60)">€60</button>
                            <button type="button" class="btn-price" onclick="setPrice(75)">€75</button>
                            <button type="button" class="btn-price" onclick="setPrice(100)">€100</button>
                        </div>
                        <input type="number" id="valorTotal" step="0.01" required placeholder="Ou digite valor...">
                    </div>
                    
                    <div class="form-group">
                        <label for="modoPagamento">Forma de Pagamento *</label>
                        <div class="payment-buttons">
                            <button type="button" class="btn-payment" onclick="setPayment('Dinheiro')">
                                💵 Dinheiro
                            </button>
                            <button type="button" class="btn-payment" onclick="setPayment('Cartão')">
                                💳 Cartão
                            </button>
                            <button type="button" class="btn-payment" onclick="setPayment('Transferência')">
                                🏦 Transferência
                            </button>
                        </div>
                        <select id="modoPagamento" required style="display: none;">
                            <option value="">Selecionar...</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cartão">Cartão</option>
                            <option value="Transferência">Transferência Bancária</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="pagoParaQuem">Pago Para *</label>
                        <div class="payment-to-buttons">
                            <button type="button" class="btn-payment-to" onclick="setPaymentTo('Recepção')">
                                🏨 Recepção
                            </button>
                            <button type="button" class="btn-payment-to" onclick="setPaymentTo('Motorista')">
                                🚐 Motorista
                            </button>
                        </div>
                        <select id="pagoParaQuem" required style="display: none;">
                            <option value="">Selecionar...</option>
                            <option value="Recepção">Recepção</option>
                            <option value="Motorista">Motorista</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="observacoes">Observações</label>
                        <div class="obs-buttons">
                            <button type="button" class="btn-obs" onclick="addObservation('Bagagem extra')">Bagagem Extra</button>
                            <button type="button" class="btn-obs" onclick="addObservation('Transfer urgente')">Urgente</button>
                            <button type="button" class="btn-obs" onclick="addObservation('Cliente VIP')">VIP</button>
                            <button type="button" class="btn-obs" onclick="addObservation('Com criança')">Com Criança</button>
                        </div>
                        <textarea id="observacoes" rows="3" placeholder="Informações adicionais..."></textarea>
                    </div>
                </div>

                <!-- Box de Cálculo de Preço - FUNCIONALIDADE DO CÓDIGO NOVO -->
                <div class="price-calculation-box" id="priceCalculationBox">
                    <div class="calculation-header">💰 Cálculo do Valor Total</div>
                    <div class="calculation-details">
                        <div class="calculation-row">
                            <span class="calculation-label">Tipo de Serviço:</span>
                            <span class="calculation-value" id="calcTipoServico">-</span>
                        </div>
                        <div class="calculation-row">
                            <span class="calculation-label">Preço Unitário:</span>
                            <span class="calculation-value" id="calcPrecoUnitario">€0</span>
                        </div>
                        <div class="calculation-row">
                            <span class="calculation-label">Quantidade de Pessoas:</span>
                            <span class="calculation-value" id="calcPessoas">0</span>
                        </div>
                    </div>
                    <div class="calculation-total">
                        VALOR TOTAL: €<span id="calcTotal">0</span>
                    </div>
                    
                    <!-- Campos Admin (ocultos por padrão) -->
                    <div class="admin-fields" id="adminFields">
                        <div class="calculation-row">
                            <span class="calculation-label">Valor Empire Marques Hotel (30%):</span>
                            <span class="calculation-value" id="calcHotel">€0</span>
                        </div>
                        <div class="calculation-row">
                            <span class="calculation-label">Valor HUB Transfer:</span>
                            <span class="calculation-value" id="calcHUB">€0</span>
                        </div>
                        <div class="calculation-row">
                            <span class="calculation-label">Comissão Recepção:</span>
                            <span class="calculation-value" id="calcRecepcao">€0</span>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">✅ Solicitar Transfer</button>
                    <button type="button" class="btn btn-clear" onclick="clearForm()">🔄 Limpar</button>
                    <button type="button" class="btn btn-export" onclick="exportToCSV()">📊 Exportar CSV</button>
                    <button type="button" class="btn btn-success" onclick="syncWithServer()" id="syncBtn">
    📤 Atualizar Dados
</button>                        📤 Sincronizar Tudo
                    </button>
                    <button type="button" class="btn btn-config" onclick="toggleConfig()">⚙️ Configurar</button>
                    <button type="button" class="btn btn-danger" onclick="toggleClearData()">🗑️ Limpar Dados</button>
                </div>
            </form>
        </div>

        <div class="summary-section">
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-number" id="totalServices">0</div>
                    <div class="summary-label">Total de Serviços</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="pendingServices">0</div>
                    <div class="summary-label">Solicitados</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="confirmedServices">0</div>
                    <div class="summary-label">Confirmados</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="completedServices">0</div>
                    <div class="summary-label">Finalizados</div>
                </div>
            </div>

            <div class="financial-summary">
                <h3 style="text-align: center; margin-bottom: 25px; font-size: 1.8rem;">💰 Resumo Financeiro</h3>
                <div class="financial-grid">
                    <div class="financial-item">
                        <div class="financial-value" id="totalRevenue">€0.00</div>
                        <div class="financial-label">Receita Total</div>
                    </div>
                    <div class="financial-item">
                        <div class="financial-value" id="pendingRevenue">€0.00</div>
                        <div class="financial-label">Valor Pendente</div>
                    </div>
                    <div class="financial-item">
                        <div class="financial-value" id="confirmedRevenue">€0.00</div>
                        <div class="financial-label">Valor Confirmado</div>
                    </div>
                    <div class="financial-item">
                        <div class="financial-value" id="completedRevenue">€0.00</div>
                        <div class="financial-label">Valor Finalizado</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="services-section">
            <div class="services-header">
                <h2 class="services-title">📋 Serviços de Transfer</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filterStatus">Status:</label>
                        <select id="filterStatus" onchange="filterTable()">
                            <option value="">Todos</option>
                            <option value="Solicitado">Solicitado</option>
                            <option value="Confirmado">Confirmado</option>
                            <option value="Finalizado">Finalizado</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterData">Data:</label>
                        <input type="date" id="filterData" onchange="filterTable()">
                    </div>
                    <div class="filter-group">
                        <label for="searchClient">Cliente:</label>
                        <input type="text" id="searchClient" placeholder="Buscar..." onkeyup="filterTable()">
                    </div>
                </div>
            </div>

            <div class="services-table">
                <table id="servicesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Tipo</th>
                            <th>Pessoas</th>
                            <th>Bagagens</th>
                            <th>Data</th>
                            <th>Hora Pick-up</th>
                            <th>Contacto</th>
                            <th>Voo</th>
                            <th>Rota</th>
                            <th>Valor Total</th>
                            <th class="admin-column" style="display: none;">Valor Hotel</th>
                            <th class="admin-column" style="display: none;">Valor HUB</th>
                            <th class="admin-column" style="display: none;">Comissão Recepção</th>
                            <th>Pagamento</th>
                            <th>Pago Para</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="servicesTableBody">
                        <tr>
                            <td colspan="18" class="empty-state">
                                <h3>Nenhum serviço cadastrado</h3>
                                <p>Adicione o primeiro transfer usando o formulário acima</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Botão Admin - FUNCIONALIDADE DO CÓDIGO NOVO -->
    <div class="admin-toggle" id="adminToggle" onclick="toggleAdminMode()">🔐 Admin</div>

    <script>
        // =====================================================
        // VARIÁVEIS GLOBAIS - FUSÃO DOS DOIS CÓDIGOS
        // =====================================================
        let services = [];
        let editingId = null;
        let phoneInput = null;
        let isConnected = false;
        let isAdminMode = false; // Do código novo
        let currentServiceType = 'transfer'; // Do código novo
        let precoUnitarioAtual = 0; // Do código novo
        
// Adicionar APÓS as variáveis globais existentes
// ===================================================
// VARIÁVEIS DE SINCRONIZAÇÃO MULTI-DISPOSITIVO
// ===================================================
let syncInProgress = false;
let lastSyncTime = null;
let serverData = [];
let nextAvailableId = 1;
let syncConfig = {
    autoSync: false, // Sincronização manual apenas
    syncInterval: 300000, // 5 minutos se ativado
    retryAttempts: 3,
    retryDelay: 2000
};

// Configuração de filtros avançados
let activeFilters = {
    dateStart: null,
    dateEnd: null,
    status: '',
    cliente: '',
    quickPeriod: '',
    tipoServico: ''
};

// Cache de dados filtrados
let filteredData = [];
let isFiltering = false;

        // ATUALIZADO: Nova URL do Google Apps Script fornecida
        const SPREADSHEET_ID = '1ZfG_IXBWMbGQzCmn7nWNzFqUBbGkXCXWSnY7JYziHxI'; // ID do código novo
        const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbyLR-ExtSDDPAPYZDovF61O36IRk4SpIzQhc2W533PC5pwfdXxDKDcLsuku4eYodAyJGg/exec'; // URL ATUALIZADA
        const TEST_EMAIL = 'juniorgutierezbega@gmail.com'; // Email de teste configurado
        
        // Tours e Preços - FUNCIONALIDADE DO CÓDIGO NOVO
        const TOURS_DATA = {
            'tour-sintra-cascais': { name: 'Sintra e Cascais (8h)', price: 67, type: 'regular' },
            'tour-fatima-obidos': { name: 'Fátima e Óbidos (8h)', price: 83, type: 'regular' },
            'tour-combo-2dias': { name: 'Combo 2 Dias (16h)', price: 138, type: 'regular' },
            'private-sintra-palaces': { name: 'Private Palaces of Sintra', priceSmall: 347, priceLarge: 492, type: 'private' },
            'private-evora': { name: 'Private Évora City', priceSmall: 347, priceLarge: 492, type: 'private' },
            'private-templars': { name: 'Private Templars', priceSmall: 347, priceLarge: 492, type: 'private' },
            'private-arrabida': { name: 'Private Arrábida', priceSmall: 347, priceLarge: 492, type: 'private' }
        };

        // =====================================================
        // FUNÇÕES DE SERVIÇO - DO CÓDIGO NOVO
        // =====================================================
        function setServiceType(type) {
            currentServiceType = type;
            
            // Atualizar botões
            document.querySelectorAll('.btn-service').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Mostrar/ocultar seletor de tours
            const tourSelector = document.getElementById('tourSelector');
            if (type === 'tour' || type === 'private') {
                tourSelector.classList.add('show');
            } else {
                tourSelector.classList.remove('show');
                document.getElementById('tourSelecionado').value = '';
            }
            
            // Atualizar cálculo
            updateCalculation();
        }

        function updateTourPrice() {
            const tourSelect = document.getElementById('tourSelecionado');
            const selectedOption = tourSelect.options[tourSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                precoUnitarioAtual = 0;
                updateCalculation();
                return;
            }
            
            const tourData = TOURS_DATA[selectedOption.value];
            const pessoas = parseInt(document.getElementById('numeroPessoas').value) || 1;
            
            if (tourData.type === 'regular') {
                precoUnitarioAtual = tourData.price;
                const valorTotal = precoUnitarioAtual * pessoas;
                document.getElementById('valorTotal').value = valorTotal.toFixed(2);
            } else if (tourData.type === 'private') {
                precoUnitarioAtual = pessoas <= 3 ? tourData.priceSmall : tourData.priceLarge;
                document.getElementById('valorTotal').value = precoUnitarioAtual.toFixed(2);
            }
            
            updateCalculation();
        }

        function updateCalculation() {
            const pessoas = parseInt(document.getElementById('numeroPessoas').value) || 0;
            let valorTotal = 0;
            let valorHotel = 0;
            let valorHUB = 0;
            let comissaoRecepcao = 0;
            
            const calcBox = document.getElementById('priceCalculationBox');
            
            if (currentServiceType === 'tour' || currentServiceType === 'private') {
                calcBox.classList.add('show');
                
                document.getElementById('calcTipoServico').textContent = 
                    currentServiceType === 'tour' ? 'Tour Regular' : 'Private Tour';
                document.getElementById('calcPrecoUnitario').textContent = `€${precoUnitarioAtual}`;
                document.getElementById('calcPessoas').textContent = pessoas;
                
                if (currentServiceType === 'tour') {
                    valorTotal = precoUnitarioAtual * pessoas;
                    valorHotel = valorTotal * 0.30;
                    comissaoRecepcao = 5.00; // Comissão para tours do código novo
                } else if (currentServiceType === 'private') {
                    valorTotal = precoUnitarioAtual;
                    valorHotel = valorTotal * 0.30;
                    comissaoRecepcao = 5.00; // Comissão para tours do código novo
                }
            } else {
                calcBox.classList.remove('show');
                valorTotal = parseFloat(document.getElementById('valorTotal').value) || 0;
                valorHotel = valorTotal * 0.30;
                comissaoRecepcao = 2.00; // Comissão para transfers do código novo
            }
            
            valorHUB = valorTotal - valorHotel - comissaoRecepcao;
            
            document.getElementById('calcTotal').textContent = valorTotal.toFixed(2);
            document.getElementById('calcHotel').textContent = `€${valorHotel.toFixed(2)}`;
            document.getElementById('calcHUB').textContent = `€${valorHUB.toFixed(2)}`;
            document.getElementById('calcRecepcao').textContent = `€${comissaoRecepcao.toFixed(2)}`;
            
            if (currentServiceType !== 'transfer') {
                document.getElementById('valorTotal').value = valorTotal.toFixed(2);
            }
        }

        // Toggle modo admin - DO CÓDIGO NOVO
        function toggleAdminMode() {
            const senha = prompt('Digite a senha de administrador:');
            if (senha === 'admin2025') {
                isAdminMode = !isAdminMode;
                
                document.getElementById('adminFields').classList.toggle('show');
                
                document.querySelectorAll('.admin-column').forEach(col => {
                    col.style.display = isAdminMode ? 'table-cell' : 'none';
                });
                
                alert(isAdminMode ? 'Modo Admin Ativado' : 'Modo Admin Desativado');
            } else if (senha !== null) {
                alert('Senha incorreta!');
            }
        }

        // =====================================================
        // FUNÇÕES DE CONFIGURAÇÃO - FUSÃO
        // =====================================================
        
        // Auto-configurar URL - MELHORADO DO CÓDIGO ANTIGO
        function autoConfigureUrl() {
            const urlInput = document.getElementById('webappUrl');
            if (!urlInput.value.trim()) {
                urlInput.value = WEBAPP_URL;
                localStorage.setItem('webappUrl', WEBAPP_URL);
                isConnected = true;
                document.getElementById('syncBtn').style.display = 'inline-block';
                console.log('URL auto-configurada:', WEBAPP_URL);
            }
        }

        function toggleConfig() {
            const configSection = document.getElementById('configSection');
            configSection.classList.toggle('show');
        }

        function toggleClearData() {
            const clearSection = document.getElementById('clearDataSection');
            clearSection.classList.toggle('show');
        }

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function setButtonLoading(buttonId, loading = true) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.disabled = true;
                button.classList.add('loading');
                button.textContent = '';
            } else {
                button.disabled = false;
                button.classList.remove('loading');
                if (buttonId === 'testBtn') {
                    button.textContent = '🔗 Testar Conexão';
                } else if (buttonId === 'submitBtn') {
                    button.textContent = '✅ Solicitar Transfer';
                } else if (buttonId === 'clearDataBtn') {
                    button.textContent = '🗑️ Limpar Todos os Dados';
                } else if (buttonId === 'clearTestBtn') {
                    button.textContent = '🧹 Limpar Apenas Testes';
                } else if (buttonId === 'syncBtn') {
                    button.textContent = '📤 Sincronizar Tudo';
                }
            }
        }

        // =====================================================
        // FUNÇÕES DE FORMULÁRIO
        // =====================================================
        
        function initializePhoneInput() {
            const phoneInputElement = document.getElementById('contacto');
            
            if (window.intlTelInput) {
                phoneInput = window.intlTelInput(phoneInputElement, {
                    initialCountry: "pt",
                    preferredCountries: ["pt", "es", "fr", "de", "br", "us", "gb"],
                    separateDialCode: true,
                    autoHideDialCode: false,
                    nationalMode: false,
                    formatOnDisplay: true,
                    utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"
                });

                phoneInputElement.addEventListener('input', function() {
                    const number = phoneInputElement.value;
                    if (number.startsWith('+')) {
                        const countryCode = detectCountryFromNumber(number);
                        if (countryCode) {
                            phoneInput.setCountry(countryCode);
                        }
                    }
                });

                phoneInputElement.addEventListener('blur', function() {
                    if (phoneInput.isValidNumber()) {
                        phoneInputElement.value = phoneInput.getNumber();
                    }
                });
            }
        }

        function detectCountryFromNumber(number) {
            const countryCodesMap = {
                '+351': 'pt', '+34': 'es', '+33': 'fr', '+49': 'de', '+55': 'br',
                '+1': 'us', '+44': 'gb', '+39': 'it', '+31': 'nl', '+32': 'be',
                '+41': 'ch', '+43': 'at', '+45': 'dk', '+46': 'se', '+47': 'no'
            };

            for (let i = 4; i >= 2; i--) {
                const code = number.substring(0, i);
                if (countryCodesMap[code]) {
                    return countryCodesMap[code];
                }
            }
            return null;
        }

        function getFormattedPhoneNumber() {
            if (phoneInput && phoneInput.isValidNumber()) {
                return phoneInput.getNumber();
            }
            return document.getElementById('contacto').value;
        }

        function setPeople(number) {
            document.getElementById('numeroPessoas').value = number;
            document.querySelectorAll('.btn-people').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateCalculation();
            updatePriceFromTour();
        }

        function updatePriceFromTour() {
            const tourSelect = document.getElementById('tourSelecionado');
            const selectedOption = tourSelect.options[tourSelect.selectedIndex];
            const pessoas = parseInt(document.getElementById('numeroPessoas').value) || 0;
            
            if (currentServiceType === 'tour' && selectedOption && selectedOption.value) {
                const tourData = TOURS_DATA[selectedOption.value];
                if (tourData && tourData.type === 'regular' && pessoas > 0) {
                    const valorTotal = tourData.price * pessoas;
                    document.getElementById('valorTotal').value = valorTotal.toFixed(2);
                    document.querySelectorAll('.btn-price').forEach(btn => btn.classList.remove('active'));
                }
            } else if (currentServiceType === 'private' && selectedOption && selectedOption.value) {
                const tourData = TOURS_DATA[selectedOption.value];
                if (tourData && tourData.type === 'private' && pessoas > 0) {
                    const valorTotal = pessoas <= 3 ? tourData.priceSmall : tourData.priceLarge;
                    document.getElementById('valorTotal').value = valorTotal.toFixed(2);
                    document.querySelectorAll('.btn-price').forEach(btn => btn.classList.remove('active'));
                }
            }
        }

        function setBaggage(number) {
            document.getElementById('numeroBagagens').value = number;
            document.querySelectorAll('.btn-baggage').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setDate(option) {
            const dateInput = document.getElementById('data');
            const today = new Date();
            
            document.querySelectorAll('.btn-date').forEach(btn => btn.classList.remove('active'));
            
            if (option === 'today') {
                dateInput.valueAsDate = today;
                event.target.classList.add('active');
            } else if (option === 'tomorrow') {
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                dateInput.valueAsDate = tomorrow;
                event.target.classList.add('active');
            }
        }

        function setTime(time) {
            document.getElementById('horaPickup').value = time;
            document.querySelectorAll('.btn-time').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setOrigin(location) {
            document.getElementById('origem').value = location;
            document.querySelectorAll('.origem-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setDestination(location) {
            document.getElementById('destino').value = location;
            document.querySelectorAll('.destino-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setPrice(price) {
            document.getElementById('valorTotal').value = price;
            document.querySelectorAll('.btn-price').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateCalculation();
        }

        function setPayment(method) {
            document.getElementById('modoPagamento').value = method;
            document.querySelectorAll('.btn-payment').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setPaymentTo(recipient) {
            document.getElementById('pagoParaQuem').value = recipient;
            document.querySelectorAll('.btn-payment-to').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function addObservation(text) {
            const obsInput = document.getElementById('observacoes');
            const currentText = obsInput.value;
            
            if (currentText === '') {
                obsInput.value = text;
            } else {
                obsInput.value = currentText + '; ' + text;
            }
            
            event.target.classList.add('active');
            setTimeout(() => {
                event.target.classList.remove('active');
            }, 1000);
        }

        // =====================================================
        // INTEGRAÇÃO COM GOOGLE SHEETS - FUSÃO MELHORADA
        // =====================================================
        
        async function testConnection() {
            const url = document.getElementById('webappUrl').value.trim() || WEBAPP_URL;
            
            if (!url) {
                showStatus('Por favor, insira a URL do Google Apps Script!', 'error');
                return;
            }
            
            setButtonLoading('testBtn', true);
            
            try {
                // Primeiro teste com GET
                const response = await fetch(url + '?action=test', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    isConnected = true;
                    showStatus('✅ Conexão funcionando!', 'success');
                    saveWebappUrl();
                    document.getElementById('syncBtn').style.display = 'inline-block';
                } else {
                    throw new Error('Resposta não OK');
                }
                
            } catch (error) {
                // Fallback: testar com POST no-cors
                try {
                    await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({ action: 'test' }),
                        mode: 'no-cors'
                    });
                    
                    isConnected = true;
                    showStatus('✅ Conexão estabelecida (modo limitado)', 'success');
                    saveWebappUrl();
                    document.getElementById('syncBtn').style.display = 'inline-block';
                    
                } catch (fallbackError) {
                    showStatus('❌ Erro ao conectar. Verifique a URL e o deploy', 'error');
                    isConnected = false;
                }
            } finally {
                setButtonLoading('testBtn', false);
            }
        }

        async function sendToSheets(serviceData) {
            const url = document.getElementById('webappUrl').value.trim() || localStorage.getItem('webappUrl') || WEBAPP_URL;
            
            if (!url) {
                console.log('URL não configurada');
                return false;
            }
            
            try {
                console.log('📤 Enviando dados para Sheets:', serviceData);
                
                // Adicionar email de destino aos dados
                const dataWithEmail = {
                    ...serviceData,
                    emailDestino: TEST_EMAIL // Email de teste configurado
                };
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(dataWithEmail),
                    mode: 'no-cors'
                });
                
                console.log('✅ Requisição enviada para:', TEST_EMAIL);
                
                // Verificar status
                try {
                    const checkResponse = await fetch(url + '?action=test', {
                        method: 'GET',
                        mode: 'cors'
                    });
                    
                    if (checkResponse.ok) {
                        const result = await checkResponse.json();
                        console.log('📨 Resposta do Sheets:', result);
                        return true;
                    }
                } catch (e) {
                    // Ignorar erro de verificação
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Erro ao enviar para Google Sheets:', error);
                showStatus('❌ Erro de conexão com Google Sheets', 'error');
                return false;
            }
        }

        async function syncToSheets() {
            const url = document.getElementById('webappUrl').value.trim() || localStorage.getItem('webappUrl') || WEBAPP_URL;
            
            if (!url) {
                showStatus('Configure a URL do Google Apps Script primeiro!', 'error');
                return;
            }
            
            if (services.length === 0) {
                showStatus('Não há dados para sincronizar!', 'warning');
                return;
            }
            
            setButtonLoading('syncBtn', true);
            let successCount = 0;
            
            try {
                for (const service of services) {
                    const success = await sendToSheets(service);
                    if (success) successCount++;
                    
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
                
                showStatus(`Sincronização concluída! ${successCount}/${services.length} registros enviados.`, 'success');
            } catch (error) {
                showStatus('Erro durante sincronização: ' + error.message, 'error');
            } finally {
                setButtonLoading('syncBtn', false);
            }
        }

        // =====================================================
        // GERENCIAMENTO DE DADOS
        // =====================================================
        
        async function clearAllData() {
            const confirmText = prompt('⚠️ ATENÇÃO: Esta ação irá apagar TODOS os dados!\n\nDigite "CONFIRMAR" para continuar:');
            
            if (confirmText !== 'CONFIRMAR') {
                showStatus('Operação cancelada pelo usuário.', 'warning');
                return;
            }

            setButtonLoading('clearDataBtn', true);
            
            try {
                const url = document.getElementById('webappUrl').value.trim() || localStorage.getItem('webappUrl') || WEBAPP_URL;
                
                if (url) {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'clearAllData',
                            timestamp: new Date().toISOString()
                        }),
                        mode: 'cors'
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        showStatus('✅ Dados limpos no Google Sheets com sucesso!', 'success');
                    } else {
                        showStatus('⚠️ Erro ao limpar dados no Google Sheets: ' + result.message, 'warning');
                    }
                } else {
                    showStatus('⚠️ URL não configurada - apenas dados locais serão limpos', 'warning');
                }
                
                services = [];
                localStorage.removeItem('partnershipTransferData');
                renderTable();
                updateSummary();
                
                showStatus('🗑️ Todos os dados foram limpos com sucesso!', 'success');
                
                setTimeout(() => {
                    toggleClearData();
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao limpar dados:', error);
                
                services = [];
                localStorage.removeItem('partnershipTransferData');
                renderTable();
                updateSummary();
                
                showStatus('🗑️ Dados locais limpos. Erro ao conectar com Google Sheets.', 'warning');
            } finally {
                setButtonLoading('clearDataBtn', false);
            }
        }

        async function clearTestData() {
            const confirmText = prompt('Limpar apenas registros de teste?\n\nDigite "TESTE" para confirmar:');
            
            if (confirmText !== 'TESTE') {
                showStatus('Operação cancelada pelo usuário.', 'warning');
                return;
            }

            setButtonLoading('clearTestBtn', true);
            
            try {
                const url = document.getElementById('webappUrl').value.trim() || localStorage.getItem('webappUrl') || WEBAPP_URL;
                
                if (url) {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'clearTestData',
                            timestamp: new Date().toISOString()
                        }),
                        mode: 'cors'
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        showStatus('✅ Dados de teste limpos no Google Sheets!', 'success');
                    } else {
                        showStatus('⚠️ Erro ao limpar dados de teste no Google Sheets: ' + result.message, 'warning');
                    }
                }
                
                const originalLength = services.length;
                services = services.filter(service => 
                    !service.nomeCliente.toUpperCase().includes('TESTE') &&
                    !service.nomeCliente.toUpperCase().includes('TEST')
                );
                
                const removedCount = originalLength - services.length;
                
                if (removedCount > 0) {
                    saveData();
                    renderTable();
                    updateSummary();
                    showStatus(`🧹 ${removedCount} registros de teste removidos!`, 'success');
                } else {
                    showStatus('ℹ️ Nenhum registro de teste encontrado.', 'warning');
                }
                
                setTimeout(() => {
                    toggleClearData();
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao limpar dados de teste:', error);
                showStatus('❌ Erro ao limpar dados de teste: ' + error.message, 'error');
            } finally {
                setButtonLoading('clearTestBtn', false);
            }
        }

        function saveWebappUrl() {
            const url = document.getElementById('webappUrl').value.trim() || WEBAPP_URL;
            if (url) {
                localStorage.setItem('webappUrl', url);
                document.getElementById('syncBtn').style.display = 'inline-block';
                isConnected = true;
            }
        }

        function loadData() {
            const savedData = localStorage.getItem('partnershipTransferData');
            const savedUrl = localStorage.getItem('webappUrl');
            
            if (savedData) {
                try {
                    services = JSON.parse(savedData);
                    console.log(`${services.length} transfers carregados do localStorage`);
                    renderTable();
                    updateSummary();
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    services = [];
                }
            }
            
            if (savedUrl) {
                document.getElementById('webappUrl').value = savedUrl;
                document.getElementById('syncBtn').style.display = 'inline-block';
                isConnected = true;
            } else {
                // Auto-configurar URL padrão
                document.getElementById('webappUrl').value = WEBAPP_URL;
                localStorage.setItem('webappUrl', WEBAPP_URL);
                document.getElementById('syncBtn').style.display = 'inline-block';
                isConnected = true;
            }
        }

        function saveData() {
            try {
                localStorage.setItem('partnershipTransferData', JSON.stringify(services));
                console.log('Dados salvos no localStorage');
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                showStatus('Erro ao salvar dados localmente', 'error');
            }
        }

        // =====================================================
        // RENDERIZAÇÃO E VISUALIZAÇÃO
        // =====================================================
        
        function renderTable() {
            const tbody = document.getElementById('servicesTableBody');
            tbody.innerHTML = '';

            if (services.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="18" class="empty-state">
                            <h3>Nenhum serviço cadastrado</h3>
                            <p>Adicione o primeiro transfer usando o formulário acima</p>
                        </td>
                    </tr>
                `;
                return;
            }

            const sortedServices = services.sort((a, b) => {
                const dateA = new Date(a.data + ' ' + a.horaPickup);
                const dateB = new Date(b.data + ' ' + b.horaPickup);
                return dateB - dateA;
            });

            sortedServices.forEach(service => {
                const row = document.createElement('tr');
                const paymentClass = service.modoPagamento.toLowerCase().includes('dinheiro') ? 'payment-cash' : 
                                service.modoPagamento.toLowerCase().includes('cartão') ? 'payment-card' : 'payment-transfer';
                
                const tipoServico = service.tipoServico || 'Transfer';
                const tipoLabel = tipoServico === 'tour' ? '🚐 Tour' : 
                                 tipoServico === 'private' ? '🚗 Private' : 
                                 '🚕 Transfer';
                
                row.innerHTML = `
                    <td><strong>#${service.id}</strong></td>
                    <td>
                        <div class="client-info">${service.nomeCliente}</div>
                        <div style="font-size: 0.8rem; color: #7f8c8d;">${service.contacto}</div>
                    </td>
                    <td>${tipoLabel}</td>
                    <td>
                        <span style="background: #9b59b6; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600;">
                            👥 ${service.numeroPessoas}
                        </span>
                    </td>
                    <td>
                        <span style="background: #e67e22; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600;">
                            🧳 ${service.numeroBagagens}
                        </span>
                    </td>
                    <td><strong>${formatDate(service.data)}</strong></td>
                    <td>
                        <div style="font-weight: 600; color: #2c3e50; font-size: 1.1rem;">
                            ${service.horaPickup}
                        </div>
                    </td>
                    <td>${service.contacto}</td>
                    <td>${service.numeroVoo || '-'}</td>
                    <td>
                        <div style="font-size: 0.9rem;">
                            <div><strong>De:</strong> ${service.origem}</div>
                            <div><strong>Para:</strong> ${service.destino}</div>
                        </div>
                    </td>
                    <td><span class="value-highlight">€${service.valorTotal.toFixed(2)}</span></td>
                    <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                        €${(service.valorHotel || 0).toFixed(2)}
                    </td>
                    <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                        €${(service.valorHUB || 0).toFixed(2)}
                    </td>
                    <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                        €${(service.comissaoRecepcao || 0).toFixed(2)}
                    </td>
                    <td><span class="payment-method ${paymentClass}">${service.modoPagamento}</span></td>
                    <td>
                        <span class="pago-para ${service.pagoParaQuem === 'Recepção' ? 'pago-recepcao' : 'pago-motorista'}">
                            ${service.pagoParaQuem}
                        </span>
                    </td>
                    <td><span class="status status-${service.status.toLowerCase()}">${service.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-small btn-primary" onclick="editService(${service.id})" title="Editar">✏️</button>
                            <button class="btn btn-small btn-success" onclick="changeStatus(${service.id})" title="Alterar Status">🔄</button>
                            <button class="btn btn-small btn-export" onclick="deleteService(${service.id})" title="Excluir">🗑️</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateSummary() {
            const total = services.length;
            const pending = services.filter(s => s.status === 'Solicitado').length;
            const confirmed = services.filter(s => s.status === 'Confirmado').length;
            const completed = services.filter(s => s.status === 'Finalizado').length;

            const totalRevenue = services.reduce((sum, s) => sum + (s.valorTotal || 0), 0);
            const pendingRevenue = services.filter(s => s.status === 'Solicitado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);
            const confirmedRevenue = services.filter(s => s.status === 'Confirmado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);
            const completedRevenue = services.filter(s => s.status === 'Finalizado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);

            document.getElementById('totalServices').textContent = total;
            document.getElementById('pendingServices').textContent = pending;
            document.getElementById('confirmedServices').textContent = confirmed;
            document.getElementById('completedServices').textContent = completed;

            document.getElementById('totalRevenue').textContent = `€${totalRevenue.toFixed(2)}`;
            document.getElementById('pendingRevenue').textContent = `€${pendingRevenue.toFixed(2)}`;
            document.getElementById('confirmedRevenue').textContent = `€${confirmedRevenue.toFixed(2)}`;
            document.getElementById('completedRevenue').textContent = `€${completedRevenue.toFixed(2)}`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-PT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // =====================================================
// SUBMISSÃO E VALIDAÇÃO DE FORMULÁRIO
// =====================================================

document.getElementById('transferForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    if (!validateForm()) {
        return;
    }

    setButtonLoading('submitBtn', true);

    // Calcular valores com base no tipo de serviço
    const pessoas = parseInt(document.getElementById('numeroPessoas').value);
    let valorTotal = parseFloat(document.getElementById('valorTotal').value);
    let valorHotel, valorHUB, comissaoRecepcao;
    
    if (currentServiceType === 'tour' || currentServiceType === 'private') {
        valorHotel = valorTotal * 0.30;
        comissaoRecepcao = 5.00;
    } else {
        valorHotel = valorTotal * 0.30;
        comissaoRecepcao = 2.00;
    }
    
    valorHUB = valorTotal - valorHotel - comissaoRecepcao;

    const formData = {
        nomeCliente: document.getElementById('nomeCliente').value.trim(),
        tipoServico: currentServiceType,
        tourSelecionado: document.getElementById('tourSelecionado').value,
        numeroPessoas: pessoas,
        numeroBagagens: parseInt(document.getElementById('numeroBagagens').value),
        data: document.getElementById('data').value,
        contacto: getFormattedPhoneNumber(),
        numeroVoo: document.getElementById('numeroVoo').value.trim(),
        origem: document.getElementById('origem').value.trim(),
        destino: document.getElementById('destino').value.trim(),
        horaPickup: document.getElementById('horaPickup').value,
        valorTotal: valorTotal,
        valorHotel: valorHotel,
        valorHUB: valorHUB,
        comissaoRecepcao: comissaoRecepcao,
        modoPagamento: document.getElementById('modoPagamento').value,
        pagoParaQuem: document.getElementById('pagoParaQuem').value,
        observacoes: document.getElementById('observacoes').value.trim(),
        status: 'Solicitado'
    };

    try {
        if (editingId) {
            const index = services.findIndex(s => s.id === editingId);
            if (index !== -1) {
                services[index] = { ...services[index], ...formData };
                
                if (isConnected) {
                    await sendToSheets(services[index]);
                }
                
                showStatus('Transfer atualizado com sucesso!', 'success');
            }
            editingId = null;
        } else {
            // 🔧 ATUALIZADO: Usar sistema de IDs sincronizados
            const newId = getNextSyncedId();
            const newService = {
                id: newId,
                ...formData,
                created: new Date().toISOString()
            };
            
            services.push(newService);
            
            if (isConnected) {
                const sheetSuccess = await sendToSheets(newService);
                if (sheetSuccess) {
                    console.log('✅ Transfer enviado para Google Sheets com sucesso!');
                    showStatus('Transfer adicionado com sucesso!', 'success');
                } else {
                    showStatus('⚠️ Transfer adicionado localmente. Erro ao enviar para Sheets.', 'warning');
                }
            } else {
                showStatus('Transfer adicionado localmente. Configure o Google Sheets para sincronizar.', 'warning');
            }
        }

        saveData();
        renderTable();
        updateSummary();
        clearForm();
        
        document.querySelector('.services-section').scrollIntoView({ 
            behavior: 'smooth',
            block: 'start'
        });
        
    } catch (error) {
        console.error('Erro ao processar transfer:', error);
        showStatus('Erro ao processar transfer: ' + error.message, 'error');
    } finally {
        setButtonLoading('submitBtn', false);
    }
});

        function validateForm() {
            const requiredFields = [
                'nomeCliente', 'numeroPessoas', 'data', 'contacto', 
                'origem', 'destino', 'horaPickup', 'valorTotal', 
                'modoPagamento', 'pagoParaQuem'
            ];

            for (let field of requiredFields) {
                const element = document.getElementById(field);
                if (!element.value || element.value.trim() === '') {
                    element.focus();
                    showStatus(`Campo obrigatório não preenchido: ${getFieldLabel(field)}`, 'error');
                    return false;
                }
            }

            const valor = parseFloat(document.getElementById('valorTotal').value);
            if (isNaN(valor) || valor <= 0) {
                document.getElementById('valorTotal').focus();
                showStatus('Valor deve ser um número positivo', 'error');
                return false;
            }

            const pessoas = parseInt(document.getElementById('numeroPessoas').value);
            if (isNaN(pessoas) || pessoas < 1) {
                showStatus('Número de pessoas deve ser pelo menos 1', 'error');
                return false;
            }

            return true;
        }

        function getFieldLabel(fieldId) {
            const labels = {
                'nomeCliente': 'Nome do Cliente',
                'numeroPessoas': 'Número de Pessoas',
                'data': 'Data do Transfer',
                'contacto': 'Contacto do Cliente',
                'origem': 'Local de Origem',
                'destino': 'Local de Destino',
                'horaPickup': 'Hora de Pick-up',
                'valorTotal': 'Valor do Serviço',
                'modoPagamento': 'Forma de Pagamento',
                'pagoParaQuem': 'Pago Para'
            };
            return labels[fieldId] || fieldId;
        }

        function clearForm() {
            try {
                document.getElementById('transferForm').reset();
                
                document.getElementById('numeroPessoas').value = '';
                document.getElementById('numeroBagagens').value = '0';
                document.getElementById('modoPagamento').value = '';
                document.getElementById('pagoParaQuem').value = '';
                document.getElementById('observacoes').value = '';
                document.getElementById('tourSelecionado').value = '';
                
                currentServiceType = 'transfer';
                precoUnitarioAtual = 0;
                
                document.querySelectorAll('.btn-people, .btn-baggage, .btn-date, .btn-time, .origem-btn, .destino-btn, .btn-price, .btn-payment, .btn-payment-to, .btn-obs, .btn-service').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById('tourSelector').classList.remove('show');
                document.getElementById('priceCalculationBox').classList.remove('show');
                
                editingId = null;
                document.getElementById('submitBtn').textContent = '✅ Solicitar Transfer';
                
                if (phoneInput) {
                    phoneInput.setNumber('');
                }
                
                document.getElementById('data').valueAsDate = new Date();
                
                console.log('Formulário limpo com sucesso');
                
            } catch (error) {
                console.error('Erro ao limpar formulário:', error);
                showStatus('Erro ao limpar formulário', 'error');
            }
        }

// ===================================================
// SISTEMA DE SINCRONIZAÇÃO MULTI-DISPOSITIVO
// Adicionar APÓS a função clearForm()
// ===================================================

/**
 * Sincroniza dados com o servidor (Google Sheets)
 * @param {boolean} showLoading - Se deve mostrar indicador de loading
 * @returns {Promise<boolean>} - Sucesso da sincronização
 */
async function syncWithServer(showLoading = true) {
    if (syncInProgress) {
        console.log('⏳ Sincronização já em andamento...');
        return false;
    }
    
    syncInProgress = true;
    
    if (showLoading) {
        showSyncLoading(true);
    }
    
    try {
        console.log('🔄 Iniciando sincronização com servidor...');
        
        // 1. Verificar conectividade
        const connectivityCheck = await fetch(getWebAppUrl() + '?action=checkSync', {
            method: 'GET',
            mode: 'cors'
        });
        
        if (!connectivityCheck.ok) {
            throw new Error('Servidor não está respondendo');
        }
        
        // 2. Obter próximo ID disponível
        const idResponse = await fetch(getWebAppUrl() + '?action=getLastId', {
            method: 'GET',
            mode: 'cors'
        });
        
        if (idResponse.ok) {
            const idData = await idResponse.json();
            nextAvailableId = idData.nextId || 1;
            console.log('📊 Próximo ID disponível:', nextAvailableId);
        }
        
        // 3. Baixar todos os dados
        const dataResponse = await fetch(getWebAppUrl() + '?action=getAllData', {
            method: 'GET',
            mode: 'cors'
        });
        
        if (!dataResponse.ok) {
            throw new Error(`Erro do servidor: ${dataResponse.status}`);
        }
        
        const syncData = await dataResponse.json();
        
        if (syncData.status === 'success') {
            // Atualizar dados globais com debug melhorado
            serverData = syncData.data || [];
            console.log('📊 Dados recebidos do servidor:', serverData.length, 'registros');

            if (serverData.length > 0) {
              console.log('📋 Exemplo de dados do servidor:', serverData[0]);
              console.log('📋 Headers disponíveis:', Object.keys(serverData[0]));
            }

            // Converter para formato local
            services = serverData.map((item, index) => {
              console.log(`🔄 Convertendo item ${index + 1}:`, item);
              const converted = convertServerDataToLocal(item);
              console.log(`✅ Resultado ${index + 1}:`, converted);
              return converted;
            });

            console.log('📊 Total convertido:', services.length, 'transfers');
            
            // Manter dados locais como backup
            saveData();
            
            // Atualizar interface
            applyCurrentFilters();
            updateSummary();
            
            // Registrar sincronização
            lastSyncTime = new Date();
            localStorage.setItem('lastSyncTime', lastSyncTime.toISOString());
            
            showSyncSuccess(serverData.length);
            
            console.log(`✅ Sincronização concluída: ${serverData.length} transfers baixados`);
            return true;
            
        } else {
            throw new Error(syncData.message || 'Erro desconhecido do servidor');
        }
        
    } catch (error) {
        console.error('❌ Erro na sincronização:', error);
        showSyncError(error.message);
        
        // Fallback para dados locais
        console.log('📱 Usando dados locais como fallback');
        loadData();
        
        return false;
        
    } finally {
        syncInProgress = false;
        if (showLoading) {
            showSyncLoading(false);
        }
    }
}

/**
 * Função de debug para verificar dados
 */
function debugSyncData() {
    console.log('=== DEBUG SYNC DATA ===');
    console.log('Services array:', services);
    console.log('Server data:', serverData);
    console.log('Filtered data:', filteredData);
    console.log('Active filters:', activeFilters);
    console.log('Next available ID:', nextAvailableId);
    console.log('Last sync time:', lastSyncTime);
    console.log('======================');
    
    // Testar conversão de um item
    if (serverData.length > 0) {
        console.log('Testando conversão do primeiro item:');
        console.log('Original:', serverData[0]);
        console.log('Convertido:', convertServerDataToLocal(serverData[0]));
    }
}

// Adicionar botão de debug temporário
function addDebugButton() {
    const debugBtn = document.createElement('button');
    debugBtn.textContent = 'Debug Sync';
    debugBtn.className = 'btn btn-warning';
    debugBtn.onclick = debugSyncData;
    debugBtn.style.margin = '10px';
    
    const formActions = document.querySelector('.form-actions');
    if (formActions) {
        formActions.appendChild(debugBtn);
    }
}

// Chamar na inicialização
setTimeout(addDebugButton, 3000);

/**
 * Converte dados do servidor para formato local - VERSÃO CORRIGIDA
 * @param {Object} serverItem - Item do servidor
 * @returns {Object} - Item no formato local
 */
function convertServerDataToLocal(serverItem) {
  // Debug detalhado
  console.log('🔍 Convertendo item do servidor:', serverItem);
  console.log('🔍 Chaves disponíveis:', Object.keys(serverItem));
  
  // Mapear headers EXATOS do Google Sheets
  const converted = {
    id: serverItem['ID'] || serverItem.id || 0,
    nomeCliente: serverItem['Cliente'] || serverItem.nomeCliente || 'Cliente não informado',
    tipoServico: serverItem['Tipo Serviço'] || serverItem.tipoServico || 'Transfer',
    numeroPessoas: parseInt(serverItem['Pessoas'] || serverItem.numeroPessoas) || 1,
    numeroBagagens: parseInt(serverItem['Bagagens'] || serverItem.numeroBagagens) || 0,
    data: serverItem['Data'] || serverItem.data || '',
    contacto: serverItem['Contacto'] || serverItem.contacto || '',
    numeroVoo: serverItem['Voo'] || serverItem.numeroVoo || '',
    origem: serverItem['Origem'] || serverItem.origem || '',
    destino: serverItem['Destino'] || serverItem.destino || '',
    horaPickup: serverItem['Hora Pick-up'] || serverItem.horaPickup || '',
    valorTotal: parseFloat(serverItem['Preço Cliente (€)'] || serverItem.valorTotal) || 0,
    valorHotel: parseFloat(serverItem['Valor Impire Marques Hotel (€)'] || serverItem.valorHotel) || 0,
    valorHUB: parseFloat(serverItem['Valor HUB Transfer (€)'] || serverItem.valorHUB) || 0,
    comissaoRecepcao: parseFloat(serverItem['Comissão Recepção (€)'] || serverItem.comissaoRecepcao) || 0,
    modoPagamento: serverItem['Forma Pagamento'] || serverItem.modoPagamento || 'Dinheiro',
    pagoParaQuem: serverItem['Pago Para'] || serverItem.pagoParaQuem || 'Recepção',
    status: serverItem['Status'] || serverItem.status || 'Solicitado',
    observacoes: serverItem['Observações'] || serverItem.observacoes || '',
    created: serverItem['Data Criação'] || serverItem.created || new Date().toISOString()
  };
  
  // Log do resultado
  console.log('✅ Item convertido:', {
    id: converted.id,
    cliente: converted.nomeCliente,
    status: converted.status
  });
  
  return converted;
}

/**
 * Obtém a URL do WebApp com fallback
 * @returns {string} - URL do WebApp
 */
function getWebAppUrl() {
    return document.getElementById('webappUrl')?.value || 
           localStorage.getItem('webappUrl') || 
           'https://script.google.com/macros/s/AKfycby4UE9kM_XMz4aPmbtHkwSEdsra2MYNKbpAat0p2Nyq8CsnbrEEN_U4iQKVd6-n6hK9dg/exec';
}

/**
 * Gera próximo ID sincronizado
 * @returns {number} - Próximo ID disponível
 */
function getNextSyncedId() {
    // Verificar IDs locais também
    const localIds = services.map(s => parseInt(s.id)).filter(id => !isNaN(id));
    const maxLocalId = localIds.length > 0 ? Math.max(...localIds) : 0;
    
    // Usar o maior entre servidor e local
    const finalId = Math.max(nextAvailableId, maxLocalId + 1);
    nextAvailableId = finalId + 1;
    
    return finalId;
}

/**
 * Interface para sincronização manual
 */
function showSyncLoading(show) {
    const button = document.getElementById('syncBtn');
    if (button) {
        if (show) {
            button.textContent = '🔄 Sincronizando...';
            button.disabled = true;
            button.classList.add('loading');
        } else {
            button.textContent = '📤 Atualizar Dados';
            button.disabled = false;
            button.classList.remove('loading');
        }
    }
    
    // Mostrar indicador global se necessário
    const indicator = document.getElementById('syncIndicator');
    if (indicator) {
        indicator.style.display = show ? 'block' : 'none';
    }
}

function showSyncSuccess(count) {
    showStatus(`✅ ${count} transfers sincronizados com sucesso!`, 'success');
    updateLastSyncDisplay();
}

function showSyncError(message) {
    showStatus(`❌ Erro na sincronização: ${message}`, 'error');
}

function updateLastSyncDisplay() {
    const display = document.getElementById('lastSyncDisplay');
    if (display && lastSyncTime) {
        const timeStr = lastSyncTime.toLocaleString('pt-PT');
        display.textContent = `Última sincronização: ${timeStr}`;
    }
}

// ===================================================
// SISTEMA DE FILTROS AVANÇADOS
// Adicionar APÓS as funções de sincronização
// ===================================================

/**
 * Inicializa sistema de filtros avançados
 */
function initializeAdvancedFilters() {
    console.log('🔍 Inicializando filtros avançados...');
    
    // Criar elementos de filtro se não existirem
    createFilterElements();
    
    // Configurar event listeners
    setupFilterEventListeners();
    
    // Configurar períodos rápidos
    setupQuickPeriods();
    
    // Aplicar filtros salvos
    loadSavedFilters();
    
    console.log('✅ Filtros avançados inicializados');
}

/**
 * Cria elementos de filtro na interface
 */
function createFilterElements() {
    const filtersContainer = document.querySelector('.filters');
    if (!filtersContainer) return;
    
    // Adicionar filtros de data personalizados
    const dateFiltersHtml = `
        <div class="filter-group">
            <label for="filterDateStart">Data Início:</label>
            <input type="date" id="filterDateStart" onchange="updateDateFilter()">
        </div>
        <div class="filter-group">
            <label for="filterDateEnd">Data Fim:</label>
            <input type="date" id="filterDateEnd" onchange="updateDateFilter()">
        </div>
        <div class="filter-group">
            <label>Períodos Rápidos:</label>
            <select id="quickPeriodSelect" onchange="applyQuickPeriod()">
                <option value="">Personalizado</option>
                <option value="today">Hoje</option>
                <option value="yesterday">Ontem</option>
                <option value="thisWeek">Esta Semana</option>
                <option value="lastWeek">Semana Passada</option>
                <option value="thisMonth">Este Mês</option>
                <option value="lastMonth">Mês Passado</option>
                <option value="last7days">Últimos 7 Dias</option>
                <option value="last30days">Últimos 30 Dias</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="filterTipoServico">Tipo Serviço:</label>
            <select id="filterTipoServico" onchange="updateServiceTypeFilter()">
                <option value="">Todos</option>
                <option value="Transfer">Transfer</option>
                <option value="Tour Regular">Tour Regular</option>
                <option value="Private Tour">Private Tour</option>
            </select>
        </div>
    `;
    
    // Inserir antes dos filtros existentes
    filtersContainer.insertAdjacentHTML('afterbegin', dateFiltersHtml);
    
    // Adicionar botões de ação
    const actionButtonsHtml = `
        <div class="filter-actions" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
            <button type="button" class="btn btn-primary" onclick="applyAllFilters()">
                🔍 Aplicar Filtros
            </button>
            <button type="button" class="btn btn-clear" onclick="clearAllFilters()">
                🔄 Limpar Filtros
            </button>
            <button type="button" class="btn btn-success" id="syncBtn" onclick="syncWithServer()" style="display: none;">
                📤 Atualizar Dados
            </button>
            <button type="button" class="btn btn-warning" onclick="debugSyncData()" style="margin-left: 10px;">
              🐛 Debug Sync
            </button>
            <span id="lastSyncDisplay" style="font-size: 12px; color: #666; margin-left: 10px;"></span>
        </div>
    `;
    
    filtersContainer.insertAdjacentHTML('beforeend', actionButtonsHtml);
}

/**
 * Configura event listeners para filtros
 */
function setupFilterEventListeners() {
    // Filtros existentes
    const statusFilter = document.getElementById('filterStatus');
    const clientFilter = document.getElementById('searchClient');
    
    if (statusFilter) {
        statusFilter.addEventListener('change', updateStatusFilter);
    }
    
    if (clientFilter) {
        clientFilter.addEventListener('input', debounce(updateClientFilter, 500));
    }
}

/**
 * Configura períodos rápidos
 */
function setupQuickPeriods() {
    // Os períodos já estão configurados no HTML
    console.log('📅 Períodos rápidos configurados');
}

/**
 * Aplica período rápido selecionado
 */
function applyQuickPeriod() {
    const select = document.getElementById('quickPeriodSelect');
    const period = select.value;
    
    if (!period) return;
    
    const today = new Date();
    let startDate, endDate;
    
    switch (period) {
        case 'today':
            startDate = endDate = today;
            break;
            
        case 'yesterday':
            startDate = endDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            break;
            
        case 'thisWeek':
            const dayOfWeek = today.getDay();
            const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            startDate = new Date(today.setDate(diff));
            endDate = new Date();
            break;
            
        case 'lastWeek':
            const lastWeekStart = new Date();
            lastWeekStart.setDate(today.getDate() - today.getDay() - 6);
            const lastWeekEnd = new Date();
            lastWeekEnd.setDate(today.getDate() - today.getDay());
            startDate = lastWeekStart;
            endDate = lastWeekEnd;
            break;
            
        case 'thisMonth':
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            endDate = new Date();
            break;
            
        case 'lastMonth':
            const lastMonth = new Date();
            lastMonth.setMonth(today.getMonth() - 1);
            startDate = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);
            endDate = new Date(today.getFullYear(), today.getMonth(), 0);
            break;
            
        case 'last7days':
            startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            endDate = new Date();
            break;
            
        case 'last30days':
            startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
            endDate = new Date();
            break;
    }
    
    // Atualizar campos de data
    if (startDate && endDate) {
        document.getElementById('filterDateStart').value = formatDateForInput(startDate);
        document.getElementById('filterDateEnd').value = formatDateForInput(endDate);
        
        // Aplicar filtros
        updateDateFilter();
    }
}

/**
 * Atualiza filtro de data
 */
function updateDateFilter() {
    const startDate = document.getElementById('filterDateStart').value;
    const endDate = document.getElementById('filterDateEnd').value;
    
    activeFilters.dateStart = startDate;
    activeFilters.dateEnd = endDate;
    
    // Limpar seleção de período rápido se data foi alterada manualmente
    const quickSelect = document.getElementById('quickPeriodSelect');
    if (quickSelect && (startDate || endDate)) {
        quickSelect.value = '';
    }
    
    saveFilters();
    applyCurrentFilters();
}

/**
 * Atualiza filtro de status
 */
function updateStatusFilter() {
    const statusFilter = document.getElementById('filterStatus');
    activeFilters.status = statusFilter ? statusFilter.value : '';
    
    saveFilters();
    applyCurrentFilters();
}

/**
 * Atualiza filtro de cliente
 */
function updateClientFilter() {
    const clientFilter = document.getElementById('searchClient');
    activeFilters.cliente = clientFilter ? clientFilter.value : '';
    
    saveFilters();
    applyCurrentFilters();
}

/**
 * Atualiza filtro de tipo de serviço
 */
function updateServiceTypeFilter() {
    const typeFilter = document.getElementById('filterTipoServico');
    activeFilters.tipoServico = typeFilter ? typeFilter.value : '';
    
    saveFilters();
    applyCurrentFilters();
}

/**
 * Aplica todos os filtros ativos
 */
function applyAllFilters() {
    console.log('🔍 Aplicando todos os filtros:', activeFilters);
    applyCurrentFilters();
}

/**
 * Aplica filtros atuais aos dados
 */
function applyCurrentFilters() {
    if (isFiltering) return;
    
    isFiltering = true;
    
    try {
        let filtered = [...services];
        
        // Filtro de data
        if (activeFilters.dateStart || activeFilters.dateEnd) {
            filtered = filtered.filter(service => {
                const serviceDate = parseServiceDate(service.data);
                if (!serviceDate) return true;
                
                let include = true;
                
                if (activeFilters.dateStart) {
                    const startDate = new Date(activeFilters.dateStart);
                    include = include && serviceDate >= startDate;
                }
                
                if (activeFilters.dateEnd) {
                    const endDate = new Date(activeFilters.dateEnd);
                    endDate.setHours(23, 59, 59, 999); // Incluir todo o dia
                    include = include && serviceDate <= endDate;
                }
                
                return include;
            });
        }
        
        // Filtro de status
        if (activeFilters.status) {
            filtered = filtered.filter(service => 
                service.status === activeFilters.status
            );
        }
        
        // Filtro de cliente
        if (activeFilters.cliente) {
            const searchTerm = activeFilters.cliente.toLowerCase();
            filtered = filtered.filter(service =>
                service.nomeCliente.toLowerCase().includes(searchTerm)
            );
        }
        
        // Filtro de tipo de serviço
        if (activeFilters.tipoServico) {
            filtered = filtered.filter(service =>
                service.tipoServico === activeFilters.tipoServico
            );
        }
        
        // Atualizar dados filtrados e interface
        filteredData = filtered;
        renderFilteredTable(filtered);
        updateFilteredSummary(filtered);
        
        console.log(`✅ Filtros aplicados: ${filtered.length} de ${services.length} transfers`);
        
    } finally {
        isFiltering = false;
    }
}

/**
 * Limpa todos os filtros
 */
function clearAllFilters() {
    // Limpar campos
    document.getElementById('filterDateStart').value = '';
    document.getElementById('filterDateEnd').value = '';
    document.getElementById('filterStatus').value = '';
    document.getElementById('searchClient').value = '';
    document.getElementById('filterTipoServico').value = '';
    document.getElementById('quickPeriodSelect').value = '';
    
    // Limpar filtros ativos
    activeFilters = {
        dateStart: null,
        dateEnd: null,
        status: '',
        cliente: '',
        quickPeriod: '',
        tipoServico: ''
    };
    
    // Salvar e aplicar
    saveFilters();
    renderTable(); // Volta para renderização normal
    updateSummary();
    
    console.log('🔄 Todos os filtros foram limpos');
}

/**
 * Renderiza tabela com dados filtrados
 */
function renderFilteredTable(filteredServices) {
    const tbody = document.getElementById('servicesTableBody');
    tbody.innerHTML = '';

    if (filteredServices.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="18" class="empty-state">
                    <h3>Nenhum transfer encontrado</h3>
                    <p>Tente ajustar os filtros ou sincronizar os dados</p>
                    <button class="btn btn-primary" onclick="clearAllFilters()">Limpar Filtros</button>
                </td>
            </tr>
        `;
        return;
    }

    // Usar a mesma lógica de renderização existente
    const sortedServices = filteredServices.sort((a, b) => {
        const dateA = new Date(a.data + ' ' + a.horaPickup);
        const dateB = new Date(b.data + ' ' + b.horaPickup);
        return dateB - dateA;
    });

    sortedServices.forEach(service => {
        // Usar o mesmo código de renderização da função renderTable() existente
        const row = document.createElement('tr');
        
        // CORREÇÃO: Adicionar verificação de null/undefined para modoPagamento
        const modoPagamento = service.modoPagamento || 'Não informado';
        const paymentClass = modoPagamento.toLowerCase().includes('dinheiro') ? 'payment-cash' : 
                        modoPagamento.toLowerCase().includes('cartão') ? 'payment-card' : 'payment-transfer';
        
        const tipoServico = service.tipoServico || 'Transfer';
        const tipoLabel = tipoServico === 'Tour Regular' ? '🚐 Tour' : 
                         tipoServico === 'Private Tour' ? '🚗 Private' : 
                         '🚕 Transfer';
        
        // HTML completo da linha da tabela - VERSÃO CORRIGIDA
        row.innerHTML = `
            <td><strong>#${service.id || 'N/A'}</strong></td>
            <td>
                <div class="client-info">${service.nomeCliente || 'Cliente não informado'}</div>
                <div style="font-size: 0.8rem; color: #7f8c8d;">${service.contacto || 'Sem contacto'}</div>
            </td>
            <td>${tipoLabel}</td>
            <td>
                <span style="background: #9b59b6; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600;">
                    👥 ${service.numeroPessoas || 0}
                </span>
            </td>
            <td>
                <span style="background: #e67e22; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600;">
                    🧳 ${service.numeroBagagens || 0}
                </span>
            </td>
            <td><strong>${service.data || 'Data não informada'}</strong></td>
            <td>
                <div style="font-weight: 600; color: #2c3e50; font-size: 1.1rem;">
                    ${service.horaPickup || 'Hora não informada'}
                </div>
            </td>
            <td>${service.contacto || 'Sem contacto'}</td>
            <td>${service.numeroVoo || '-'}</td>
            <td>
                <div style="font-size: 0.9rem;">
                    <div><strong>De:</strong> ${service.origem || 'Origem não informada'}</div>
                    <div><strong>Para:</strong> ${service.destino || 'Destino não informado'}</div>
                </div>
            </td>
            <td><span class="value-highlight">€${(service.valorTotal || 0).toFixed(2)}</span></td>
            <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                €${(service.valorHotel || 0).toFixed(2)}
            </td>
            <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                €${(service.valorHUB || 0).toFixed(2)}
            </td>
            <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                €${(service.comissaoRecepcao || 0).toFixed(2)}
            </td>
            <td><span class="payment-method ${paymentClass}">${modoPagamento}</span></td>
            <td>
                <span class="pago-para ${service.pagoParaQuem === 'Recepção' ? 'pago-recepcao' : 'pago-motorista'}">
                    ${service.pagoParaQuem || 'Não informado'}
                </span>
            </td>
            <td><span class="status status-${(service.status || 'solicitado').toLowerCase()}">${service.status || 'Solicitado'}</span></td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-small btn-primary" onclick="editService(${service.id})" title="Editar">✏️</button>
                    <button class="btn btn-small btn-success" onclick="changeStatus(${service.id})" title="Alterar Status">🔄</button>
                    <button class="btn btn-small btn-export" onclick="deleteService(${service.id})" title="Excluir">🗑️</button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

/**
 * Atualiza resumo com dados filtrados
 */
function updateFilteredSummary(filteredServices) {
    const total = filteredServices.length;
    const pending = filteredServices.filter(s => s.status === 'Solicitado').length;
    const confirmed = filteredServices.filter(s => s.status === 'Confirmado').length;
    const completed = filteredServices.filter(s => s.status === 'Finalizado').length;

    const totalRevenue = filteredServices.reduce((sum, s) => sum + (s.valorTotal || 0), 0);
    const pendingRevenue = filteredServices.filter(s => s.status === 'Solicitado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);
    const confirmedRevenue = filteredServices.filter(s => s.status === 'Confirmado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);
    const completedRevenue = filteredServices.filter(s => s.status === 'Finalizado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);

    // Atualizar elementos da interface
    document.getElementById('totalServices').textContent = total;
    document.getElementById('pendingServices').textContent = pending;
    document.getElementById('confirmedServices').textContent = confirmed;
    document.getElementById('completedServices').textContent = completed;

    document.getElementById('totalRevenue').textContent = `€${totalRevenue.toFixed(2)}`;
    document.getElementById('pendingRevenue').textContent = `€${pendingRevenue.toFixed(2)}`;
    document.getElementById('confirmedRevenue').textContent = `€${confirmedRevenue.toFixed(2)}`;
    document.getElementById('completedRevenue').textContent = `€${completedRevenue.toFixed(2)}`;
    
    // Adicionar indicador de filtro ativo
    updateFilterIndicator(total, services.length);
}

/**
 * Mostra indicador de filtros ativos
 */
function updateFilterIndicator(filteredCount, totalCount) {
    let indicator = document.getElementById('filterIndicator');
    
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'filterIndicator';
        indicator.style.cssText = `
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 0;
            text-align: center;
            display: none;
        `;
        
        const summarySection = document.querySelector('.summary-section');
        if (summarySection) {
            summarySection.insertBefore(indicator, summarySection.firstChild);
        }
    }
    
    if (filteredCount < totalCount) {
        indicator.textContent = `🔍 Mostrando ${filteredCount} de ${totalCount} transfers (filtros ativos)`;
        indicator.style.display = 'block';
    } else {
        indicator.style.display = 'none';
    }
}

/**
 * Salva filtros ativos no localStorage
 */
function saveFilters() {
    try {
        localStorage.setItem('activeFilters', JSON.stringify(activeFilters));
    } catch (error) {
        console.error('Erro ao salvar filtros:', error);
    }
}

/**
 * Carrega filtros salvos do localStorage
 */
function loadSavedFilters() {
    try {
        const savedFilters = localStorage.getItem('activeFilters');
        if (savedFilters) {
            activeFilters = { ...activeFilters, ...JSON.parse(savedFilters) };
            
            // Aplicar aos campos da interface
            if (activeFilters.dateStart) {
                const startField = document.getElementById('filterDateStart');
                if (startField) startField.value = activeFilters.dateStart;
            }
            
            if (activeFilters.dateEnd) {
                const endField = document.getElementById('filterDateEnd');
                if (endField) endField.value = activeFilters.dateEnd;
            }
            
            if (activeFilters.status) {
                const statusField = document.getElementById('filterStatus');
                if (statusField) statusField.value = activeFilters.status;
            }
            
            if (activeFilters.cliente) {
                const clientField = document.getElementById('searchClient');
                if (clientField) clientField.value = activeFilters.cliente;
            }
            
            if (activeFilters.tipoServico) {
                const typeField = document.getElementById('filterTipoServico');
                if (typeField) typeField.value = activeFilters.tipoServico;
            }
        }
    } catch (error) {
        console.error('Erro ao carregar filtros salvos:', error);
    }
}

/**
 * Converte data do serviço para objeto Date
 */
function parseServiceDate(dateStr) {
    if (!dateStr) return null;
    
    try {
        // Tentar diferentes formatos
        if (dateStr.includes('/')) {
            // Formato DD/MM/YYYY
            const [day, month, year] = dateStr.split('/');
            return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
        } else if (dateStr.includes('-')) {
            // Formato YYYY-MM-DD
            return new Date(dateStr);
        } else {
            return new Date(dateStr);
        }
    } catch (error) {
        console.error('Erro ao processar data:', dateStr, error);
        return null;
    }
}

/**
 * Formata data para input type="date"
 */
function formatDateForInput(date) {
    if (!(date instanceof Date)) return '';
    
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    
    return `${year}-${month}-${day}`;
}

/**
 * Função debounce para otimizar filtros
 */
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

        // =====================================================
        // EDIÇÃO E MANIPULAÇÃO DE SERVIÇOS
        // =====================================================
        
        function editService(id) {
            const service = services.find(s => s.id === id);
            if (!service) {
                showStatus('Serviço não encontrado', 'error');
                return;
            }

            try {
                document.getElementById('nomeCliente').value = service.nomeCliente;
                document.getElementById('numeroPessoas').value = service.numeroPessoas;
                document.getElementById('numeroBagagens').value = service.numeroBagagens;
                document.getElementById('data').value = service.data;
                document.getElementById('numeroVoo').value = service.numeroVoo || '';
                document.getElementById('origem').value = service.origem;
                document.getElementById('destino').value = service.destino;
                document.getElementById('horaPickup').value = service.horaPickup;
                document.getElementById('valorTotal').value = service.valorTotal;
                document.getElementById('modoPagamento').value = service.modoPagamento;
                document.getElementById('pagoParaQuem').value = service.pagoParaQuem;
                document.getElementById('observacoes').value = service.observacoes || '';
                
                // Restaurar tipo de serviço
                if (service.tipoServico) {
                    currentServiceType = service.tipoServico;
                    document.querySelectorAll('.btn-service').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.onclick.toString().includes(service.tipoServico)) {
                            btn.classList.add('active');
                        }
                    });
                    
                    if (service.tourSelecionado) {
                        document.getElementById('tourSelector').classList.add('show');
                        document.getElementById('tourSelecionado').value = service.tourSelecionado;
                    }
                }
                
                if (phoneInput) {
                    phoneInput.setNumber(service.contacto);
                } else {
                    document.getElementById('contacto').value = service.contacto;
                }
                
                updateActiveButtons(service);
                updateCalculation();
                
                editingId = id;
                document.getElementById('submitBtn').textContent = '✏️ Atualizar Transfer';
                
                document.querySelector('.quick-add').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
                showStatus('Editando transfer #' + id, 'success');
                
            } catch (error) {
                console.error('Erro ao editar serviço:', error);
                showStatus('Erro ao carregar dados para edição', 'error');
            }
        }

        function updateActiveButtons(service) {
            document.querySelectorAll('.btn-people').forEach(btn => {
                if (btn.textContent.includes(service.numeroPessoas.toString())) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.btn-baggage').forEach(btn => {
                if (btn.textContent.includes(service.numeroBagagens.toString())) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.btn-price').forEach(btn => {
                if (btn.textContent.includes(service.valorTotal.toString())) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.btn-payment').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(service.modoPagamento.toLowerCase())) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.btn-payment-to').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(service.pagoParaQuem.toLowerCase())) {
                    btn.classList.add('active');
                }
            });
        }

        async function changeStatus(id) {
            const service = services.find(s => s.id === id);
            if (!service) {
                showStatus('Serviço não encontrado', 'error');
                return;
            }

            const statuses = ['Solicitado', 'Confirmado', 'Finalizado', 'Cancelado'];
            const currentIndex = statuses.indexOf(service.status);
            const nextIndex = (currentIndex + 1) % statuses.length;
            
            service.status = statuses[nextIndex];
            
            try {
                saveData();
                renderTable();
                updateSummary();
                
                if (isConnected) {
                    await sendToSheets(service);
                    showStatus(`Status alterado para: ${service.status}`, 'success');
                } else {
                    showStatus(`Status alterado para: ${service.status} (apenas local)`, 'warning');
                }
                
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                showStatus('Erro ao alterar status', 'error');
            }
        }

        function deleteService(id) {
            if (!confirm('Tem certeza que deseja deletar este serviço?')) {
                return;
            }

            try {
                const originalLength = services.length;
                services = services.filter(s => s.id !== id);
                
                if (services.length < originalLength) {
                    saveData();
                    renderTable();
                    updateSummary();
                    showStatus('Transfer deletado com sucesso', 'success');
                } else {
                    showStatus('Transfer não encontrado', 'error');
                }
                
            } catch (error) {
                console.error('Erro ao deletar serviço:', error);
                showStatus('Erro ao deletar transfer', 'error');
            }
        }

        // =====================================================
        // FILTROS E EXPORTAÇÃO
        // =====================================================
        
        function filterTable() {
            const statusFilter = document.getElementById('filterStatus').value;
            const dataFilter = document.getElementById('filterData').value;
            const clientFilter = document.getElementById('searchClient').value.toLowerCase();

            const tbody = document.getElementById('servicesTableBody');
            const rows = tbody.getElementsByTagName('tr');

            let visibleCount = 0;

            for (let row of rows) {
                if (row.cells.length < 14) continue;
                
                let showRow = true;

                if (statusFilter && !row.textContent.includes(statusFilter)) {
                    showRow = false;
                }

                if (dataFilter) {
                    const rowDate = row.cells[5].textContent;
                    const filterDate = formatDate(dataFilter);
                    if (!rowDate.includes(filterDate)) {
                        showRow = false;
                    }
                }

                if (clientFilter && !row.cells[1].textContent.toLowerCase().includes(clientFilter)) {
                    showRow = false;
                }

                row.style.display = showRow ? '' : 'none';
                if (showRow) visibleCount++;
            }

            updateFilterResults(visibleCount);
        }

        function updateFilterResults(count) {
            let existingCounter = document.getElementById('filterCounter');
            if (!existingCounter) {
                existingCounter = document.createElement('div');
                existingCounter.id = 'filterCounter';
                existingCounter.style.cssText = 'text-align: center; padding: 10px; color: #7f8c8d; font-style: italic;';
                document.querySelector('.services-table').insertBefore(existingCounter, document.querySelector('table'));
            }
            
            if (count === services.length) {
                existingCounter.textContent = '';
            } else {
                existingCounter.textContent = `Mostrando ${count} de ${services.length} transfers`;
            }
        }

        function exportToCSV() {
            if (services.length === 0) {
                showStatus('Não há dados para exportar!', 'warning');
                return;
            }

            try {
                const headers = [
                    'ID', 'Cliente', 'Tipo Serviço', 'Tour Selecionado', 'Pessoas', 'Bagagens', 'Data', 'Contacto', 
                    'Voo', 'Origem', 'Destino', 'Hora Pick-up', 'Valor Total', 
                    'Valor Hotel', 'Valor HUB', 'Comissão Recepção',
                    'Pagamento', 'Pago Para', 'Status', 'Observações', 'Data Criação'
                ];
                
                let csvContent = headers.join(',') + '\n';
                
                services.forEach(service => {
                    const row = [
                        service.id,
                        `"${service.nomeCliente}"`,
                        `"${service.tipoServico || 'Transfer'}"`,
                        `"${service.tourSelecionado || ''}"`,
                        service.numeroPessoas,
                        service.numeroBagagens,
                        service.data,
                        `"${service.contacto}"`,
                        `"${service.numeroVoo || ''}"`,
                        `"${service.origem}"`,
                        `"${service.destino}"`,
                        service.horaPickup,
                        service.valorTotal,
                        service.valorHotel || 0,
                        service.valorHUB || 0,
                        service.comissaoRecepcao || 0,
                        `"${service.modoPagamento}"`,
                        `"${service.pagoParaQuem}"`,
                        service.status,
                        `"${service.observacoes || ''}"`,
                        `"${service.created || ''}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `transfers_Empire_marques_hub_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus(`${services.length} transfers exportados com sucesso!`, 'success');
                
            } catch (error) {
                console.error('Erro ao exportar CSV:', error);
                showStatus('Erro ao exportar dados', 'error');
            }
        }

        // =====================================================
// INICIALIZAÇÃO
// =====================================================

document.addEventListener('DOMContentLoaded', function() {
    try {
        console.log('🚀 Inicializando Sistema de Transfers Empire Marques Hotel v2.0 UNIFICADO...');
        console.log('📧 Email de teste configurado:', TEST_EMAIL);
        console.log('🔗 URL do WebApp:', WEBAPP_URL);
        
        // Mostrar botão admin
        document.getElementById('adminToggle').style.display = 'block';
        
        // Auto-configurar URL
        autoConfigureUrl();
        
        // Carregar dados salvos
        loadData();
        
        // 🆕 NOVO: Inicializar sistema de sincronização
        setTimeout(() => {
            console.log('🔄 Inicializando sincronização multi-dispositivo...');
            
            // Mostrar botão de sincronização
            const syncBtn = document.getElementById('syncBtn');
            if (syncBtn) {
                syncBtn.style.display = 'inline-block';
            }
            
            // Inicializar filtros avançados
            initializeAdvancedFilters();
            
            // Sincronização inicial opcional
            const lastSync = localStorage.getItem('lastSyncTime');
            if (!lastSync || (new Date() - new Date(lastSync)) > 300000) { // 5 minutos
                console.log('📥 Executando sincronização inicial...');
                syncWithServer(false);
            } else {
                console.log('📱 Usando dados locais (sincronização recente)');
                updateLastSyncDisplay();
            }
            
        }, 2000);
        
        // Definir data de hoje como padrão
        document.getElementById('data').valueAsDate = new Date();
        
        // Inicializar Google Maps Autocomplete
        initializeAutocomplete();
        
        // Inicializar campo de telefone após um delay
        setTimeout(initializePhoneInput, 1000);
        
        // Testar conexão automática
        setTimeout(() => {
            if (isConnected) {
                console.log('🔗 Testando conexão automática...');
                testConnection();
            }
        }, 2000);
        
        console.log('✅ Sistema inicializado com sucesso');
        console.log('📋 Funcionalidades preservadas do código antigo:');
        console.log('   - URL do webapp funcional');
        console.log('   - Auto-configuração melhorada');
        console.log('   - Conexão estável com Google Sheets');
        console.log('📋 Funcionalidades do código novo integradas:');
        console.log('   - Sistema de tours e private tours');
        console.log('   - Cálculo dinâmico de preços');
        console.log('   - Modo admin com controle de acesso');
        console.log('   - Branding Empire Marques Hotel');
        console.log('📋 Funcionalidades de sincronização multi-dispositivo:');
        console.log('   - Sincronização centralizada via Google Sheets');
        console.log('   - Filtros avançados de data');
        console.log('   - Cache local inteligente');
        
    } catch (error) {
        console.error('Erro na inicialização:', error);
        showStatus('Erro ao inicializar sistema', 'error');
    }
});

        function initializeAutocomplete() {
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                try {
                    const origemInput = document.getElementById('origem');
                    const origemAutocomplete = new google.maps.places.Autocomplete(origemInput, {
                        types: ['establishment', 'geocode'],
                        componentRestrictions: { country: 'pt' }
                    });

                    const destinoInput = document.getElementById('destino');
                    const destinoAutocomplete = new google.maps.places.Autocomplete(destinoInput, {
                        types: ['establishment', 'geocode'],
                        componentRestrictions: { country: 'pt' }
                    });

                    origemInput.addEventListener('input', function() {
                        document.querySelectorAll('.origem-btn').forEach(btn => btn.classList.remove('active'));
                    });

                    destinoInput.addEventListener('input', function() {
                        document.querySelectorAll('.destino-btn').forEach(btn => btn.classList.remove('active'));
                    });
                    
                    console.log('📍 Google Maps Autocomplete inicializado');
                    
                } catch (error) {
                    console.error('Erro ao inicializar Google Maps:', error);
                }
            } else {
                setTimeout(initializeAutocomplete, 2000);
            }
        }

        // =====================================================
        // EVENT LISTENERS E UTILITÁRIOS
        // =====================================================
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.type === 'button') {
                e.preventDefault();
            }
        });

        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                const submitBtn = document.getElementById('submitBtn');
                if (!submitBtn.disabled) {
                    submitBtn.click();
                }
            }
            
            if (e.key === 'Escape') {
                clearForm();
            }
        });

        let autoSaveTimeout;
        function scheduleAutoSave() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                saveData();
            }, 1000);
        }

        window.addEventListener('beforeunload', function(e) {
            saveData();
        });

// Função de debug para desenvolvimento
        function debugInfo() {
            console.log('=== DEBUG INFO SISTEMA UNIFICADO ===');
            console.log('Services:', services.length);
            console.log('Connected:', isConnected);
            console.log('Editing ID:', editingId);
            console.log('Phone Input:', phoneInput);
            console.log('Saved URL:', localStorage.getItem('webappUrl'));
            console.log('Spreadsheet ID:', SPREADSHEET_ID);
            console.log('WEBAPP URL:', WEBAPP_URL);
            console.log('Email de Teste:', TEST_EMAIL);
            console.log('Service Type:', currentServiceType);
            console.log('Admin Mode:', isAdminMode);
            console.log('===================================');
        }

        /**
         * Função de debug para verificar dados de sincronização
         */
        function debugSyncData() {
          console.log('=== 🐛 DEBUG COMPLETO DOS DADOS ===');
          console.log('📊 Services locais:', services.length);
          console.log('📊 Server data:', serverData.length);
          console.log('📊 Filtered data:', filteredData.length);
          
          if (services.length > 0) {
            console.log('📋 Primeiro service local:', services[0]);
          }
          
          if (serverData.length > 0) {
            console.log('📋 Primeiro server data:', serverData[0]);
            console.log('📋 Headers do servidor:', Object.keys(serverData[0]));
          }
          
          // Testar conversão
          if (serverData.length > 0) {
            console.log('🧪 TESTE DE CONVERSÃO:');
            const original = serverData[0];
            const convertido = convertServerDataToLocal(original);
            console.log('📥 Original:', original);
            console.log('📤 Convertido:', convertido);
          }
          
          // Verificar estado dos filtros
          console.log('🔍 Estado dos filtros:', activeFilters);
          console.log('🔍 Próximo ID disponível:', nextAvailableId);
          console.log('🔍 Última sincronização:', lastSyncTime);
          console.log('=====================================');
        }

        window.debugInfo = debugInfo;

        console.log('🚐 Sistema de Transfers Empire Marques Hotel & HUB Transfer v2.0 UNIFICADO');
        console.log('📧 Email configurado para testes:', TEST_EMAIL);
        console.log('🔗 URL do WebApp atualizada e funcional');
        console.log('💡 Digite debugInfo() no console para informações de debug.');
        console.log('🔐 Senha admin: admin2025');
    </script>
</body>
</html>
