<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TESTE Sistema - HUB Transfer</title>
    
    <!-- Google Maps API -->
    <script>
        function initMap() {
            console.log('Google Maps carregado com sucesso!');
            if (typeof initializeAutocomplete === 'function') {
                initializeAutocomplete();
            }
        }
        
        window.gm_authFailure = function() {
            console.error('Erro de autentica√ß√£o do Google Maps');
            console.log('Usando sistema de sugest√µes local');
        };
    </script>
    
    <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBe4UwnVYRP5KAUOtHg3diD6kPTif3VN30&libraries=places&callback=initMap"
        onerror="console.warn('Erro ao carregar Google Maps - continuando sem autocomplete')">
    </script>
    
    <!-- Telefone internacional -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"
            onerror="console.warn('Biblioteca de telefone n√£o carregou - usando input simples')"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css" 
          onerror="console.warn('CSS do telefone n√£o carregou')">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .company-logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-top: 20px;
        }

        .company-logo {
            background: rgba(255,255,255,0.1);
            padding: 15px 25px;
            border-radius: 15px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 1001;
        }

        .config-section {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 25px;
            border: 3px solid #f39c12;
            border-radius: 15px;
            margin: 20px;
            display: none;
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        .config-section.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .config-title {
            color: #d35400;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.4rem;
            text-align: center;
        }

        .config-form {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .config-input {
            flex: 1;
            min-width: 300px;
        }

        .config-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #d35400;
            font-size: 1rem;
        }

        .config-input input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #f39c12;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .config-input input:focus {
            outline: none;
            border-color: #e67e22;
            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
        }

        .clear-data-section {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            padding: 25px;
            margin: 20px;
            border-radius: 15px;
            border: 3px solid #f44336;
            display: none;
        }

        .clear-data-section.show {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .clear-data-title {
            color: #c62828;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.4rem;
            text-align: center;
        }

        .clear-data-warning {
            background: #ffebee;
            border: 2px solid #f44336;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #c62828;
            font-weight: 600;
            text-align: center;
        }

        .clear-data-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .status-message {
            padding: 12px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .quick-add {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 30px;
            border-bottom: 3px solid #3498db;
        }

        .quick-add h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.8rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        input, select, textarea {
            padding: 14px 16px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .service-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .btn-service {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #495057;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-service:hover {
            border-color: #3498db;
            background: linear-gradient(135deg, #e7f3ff 0%, #cce5ff 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.25);
        }

        .btn-service.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-color: #2980b9;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
            transform: translateY(-1px);
            animation: emoji-bounce 0.6s ease-in-out;
        }

        .tour-selector {
            display: none;
            margin-bottom: 15px;
        }

        .tour-selector.show {
            display: block;
        }

        .price-calculation-box {
            background: linear-gradient(135deg, #e7f3ff 0%, #cce5ff 100%);
            border: 2px solid #3498db;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .price-calculation-box.show {
            display: block;
        }

        .calculation-header {
            color: #2c3e50;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .calculation-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .calculation-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .calculation-row:last-child {
            border-bottom: none;
        }

        .calculation-label {
            color: #6c757d;
            font-weight: 600;
        }

        .calculation-value {
            color: #2c3e50;
            font-weight: 700;
        }

        .calculation-total {
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .admin-fields {
            display: none;
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .admin-fields.show {
            display: block;
        }

        .admin-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #6c757d;
            color: white;
            padding: 10px 15px;
            border-radius: 50px;
            cursor: pointer;
            z-index: 1000;
            font-size: 0.9rem;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }

        .btn-export {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-export:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
        }

        .btn-clear {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
            color: white;
        }

        .btn-clear:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(149, 165, 166, 0.3);
        }

        .btn-config {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            font-size: 0.9rem;
            padding: 12px 20px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }

        .btn.loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: #ffffff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }

        .date-buttons, .time-buttons, .location-buttons, 
        .price-buttons, .payment-buttons, .payment-to-buttons, .obs-buttons,
        .people-buttons, .baggage-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .btn-people, .btn-baggage {
            min-width: 60px;
            font-size: 1.1rem;
            border-radius: 50%;
            height: 50px;
            width: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid #e9ecef;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            cursor: pointer;
        }

        .btn-people {
            border-color: #9b59b6;
            color: #9b59b6;
        }

        .btn-people:hover, .btn-people.active {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            border-color: #8e44ad;
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(155, 89, 182, 0.4);
            animation: emoji-bounce 0.6s ease-in-out;
        }

        .btn-baggage {
            border-color: #e67e22;
            color: #e67e22;
        }

        .btn-baggage:hover, .btn-baggage.active {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            color: white;
            border-color: #d35400;
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(230, 126, 34, 0.4);
            animation: emoji-bounce 0.6s ease-in-out;
        }

        .btn-date, .btn-time {
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #495057;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-date:hover, .btn-time:hover {
            border-color: #3498db;
            background: linear-gradient(135deg, #e7f3ff 0%, #cce5ff 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-date.active, .btn-time.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-color: #2980b9;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .btn-location {
            min-width: 180px;
            text-align: center;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #495057;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-location:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }

        .origem-btn {
            border-left: 4px solid #e74c3c;
        }

        .origem-btn:hover, .origem-btn.active {
            border-color: #e74c3c;
            background: linear-gradient(135deg, #ffe5e5 0%, #ffcccc 100%);
            color: #c0392b;
        }

        .destino-btn {
            border-left: 4px solid #27ae60;
        }

        .destino-btn:hover, .destino-btn.active {
            border-color: #27ae60;
            background: linear-gradient(135deg, #e8f5e8 0%, #d4eedb 100%);
            color: #1e8449;
        }

        .btn-price {
            font-weight: 700;
            color: #27ae60;
            border-color: #27ae60;
            background: linear-gradient(135deg, #ffffff 0%, #f0fff4 100%);
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 12px 16px;
            border-radius: 10px;
            transition: all 0.3s ease;
            border: 2px solid #27ae60;
            cursor: pointer;
        }

        .btn-price:hover, .btn-price.active {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
        }

        .btn-payment, .btn-payment-to {
            min-width: 140px;
            font-size: 1rem;
            padding: 12px 16px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #495057;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-payment:hover, .btn-payment-to:hover {
            border-color: #3498db;
            background: linear-gradient(135deg, #e7f3ff 0%, #cce5ff 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-payment.active, .btn-payment-to.active {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border-color: #2980b9;
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .btn-obs {
            font-size: 0.85rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 10px 14px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-obs:hover {
            border-color: #6c757d;
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            color: #495057;
            transform: translateY(-1px);
        }

        .btn-obs.active {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
            border-color: #5a6268;
        }

        .summary-section {
            padding: 30px;
            background: #f8f9fa;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #3498db;
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .summary-label {
            color: #7f8c8d;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .financial-summary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
        }

        .financial-item {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 15px;
        }

        .financial-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .financial-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .services-section {
            padding: 30px;
        }

        .services-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .services-title {
            color: #2c3e50;
            font-size: 2rem;
            font-weight: 700;
        }

        .filters {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 140px;
        }

        .filter-group label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        .filter-indicator {
            background: #007bff;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 0;
            text-align: center;
            display: none;
        }

        .services-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: relative;
        }

        .table-container {
            overflow-x: auto;
            position: relative;
            scroll-behavior: smooth;
        }

        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .scroll-indicator {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 30px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.9) 100%);
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .scroll-indicator::after {
            content: 'üëâ';
            font-size: 16px;
            animation: bounce-horizontal 2s infinite;
        }

        @keyframes bounce-horizontal {
            0%, 20%, 50%, 80%, 100% {
                transform: translateX(0);
            }
            40% {
                transform: translateX(-5px);
            }
            60% {
                transform: translateX(-2px);
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 18px 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 16px 15px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.95rem;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status {
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .status:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .status-solicitado {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmado {
            background: #d4edda;
            color: #155724;
        }

        .status-finalizado {
            background: #cce5ff;
            color: #004085;
        }

        .status-cancelado {
            background: #f8d7da;
            color: #721c24;
        }

        .payment-method {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .payment-cash {
            background: #d4edda;
            color: #155724;
        }

        .payment-card {
            background: #cce5ff;
            color: #004085;
        }

        .payment-transfer {
            background: #fff3cd;
            color: #856404;
        }

        .action-buttons {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 0.75rem;
            border-radius: 6px;
            min-width: 30px;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .action-buttons .btn-small::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transition: all 0.6s ease;
            transform: translate(-50%, -50%);
        }

        .action-buttons .btn-small:hover::before {
            width: 100px;
            height: 100px;
        }

        .btn-sheets {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border: none;
        }

        .btn-sheets:hover {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
        }

        .btn-sheets:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .client-info {
            font-weight: 600;
            color: #2c3e50;
        }

        .value-highlight {
            font-weight: 700;
            color: #27ae60;
            font-size: 1.1rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #7f8c8d;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .pago-para {
            font-weight: 600;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .pago-recepcao {
            background: #e7f3ff;
            color: #004085;
        }

        .pago-motorista {
            background: #d4edda;
            color: #155724;
        }

        .phone-link {
            color: #25D366;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .phone-link:hover {
            color: #128C7E;
            transform: scale(1.05);
        }

        .phone-link:active {
            animation: pulse 0.3s ease-in-out;
        }

        .flight-link {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .flight-link:hover {
            color: #2980b9;
            transform: scale(1.05);
        }

        .flight-link:active {
            animation: pulse 0.3s ease-in-out;
        }

        .pac-container {
            z-index: 9999;
        }

        .phone-container {
            position: relative;
        }

        .iti {
            width: 100%;
        }

        .iti__country-list {
            z-index: 9999;
        }

        .iti__selected-flag {
            padding: 14px 12px;
        }

        .iti__flag-container {
            padding: 0;
        }

        #contacto {
            padding-left: 60px;
        }

        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .pagination-info {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
        }

        .pagination-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-pagination {
            padding: 8px 16px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            color: #3498db;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-pagination:hover:not(:disabled) {
            background: #3498db;
            color: white;
        }

        .btn-pagination:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .page-size-selector {
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .tour-row {
            background-color: #fff8e1 !important;
        }

        .tour-row:hover {
            background-color: #fff3c4 !important;
        }

        .airport-to-hotel-row {
            background-color: #e3f2fd !important;
        }

        .airport-to-hotel-row:hover {
            background-color: #bbdefb !important;
        }

        .table-loading {
            position: relative;
        }

        .table-loading::after {
            content: '‚è≥ Carregando transfers...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 10px;
            font-weight: 600;
            color: #3498db;
            z-index: 100;
        }

        @keyframes emoji-bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .financial-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .services-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .company-logos {
                flex-direction: column;
                gap: 15px;
            }

            .config-form {
                flex-direction: column;
            }

            .config-input {
                min-width: 100%;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .btn-service, .btn-people, .btn-baggage, 
            .btn-date, .btn-time, .btn-location,
            .btn-price, .btn-payment, .btn-payment-to {
                font-size: 0.85rem;
                padding: 10px 12px;
            }
            
            .people-buttons, .baggage-buttons {
                gap: 6px;
            }
            
            .btn-people, .btn-baggage {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
            
            .time-buttons {
                gap: 6px;
            }
            
            .btn-time {
                font-size: 0.8rem;
                padding: 8px 10px;
            }
            
            .scroll-indicator {
                width: 25px;
            }
            
            .scroll-indicator::after {
                font-size: 14px;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .btn-danger.pulse {
            animation: pulse 1s infinite;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>TESTE Sistema</h1>
            <p>TESTE Sistema - Gest√£o de Transfers</p>
            <div class="company-logos">
    <div class="company-logo">üß™ TESTE Sistema</div>
    <div class="company-logo">üöó HUB Transfer</div>
</div>
        </div>

        <!-- Indicador de Sincroniza√ß√£o -->
        <div class="sync-indicator" id="syncIndicator">üîÑ Sincronizando...</div>

        <!-- Se√ß√£o de Configura√ß√£o -->
        <div class="config-section" id="configSection">
            <div class="config-title">‚öôÔ∏è Configura√ß√£o do Google Sheets</div>
            <div class="config-form">
                <div class="config-input">
                    <label for="webappUrl">URL do Google Apps Script:</label>
                    <input type="url" id="webappUrl" 
       value="https://script.google.com/macros/s/AKfycbzVi4OAhQmh6A9O4B55iJZ0TXjgg6SDPgnXFbfiK3HUEyLXOmhJVW3pcEcr-MDcaYFWTw/exec" 
       placeholder="https://script.google.com/macros/s/...">
                </div>
                <button type="button" class="btn btn-success" onclick="testConnection()" id="testBtn">
                    ‚úÖ Testar Conex√£o
                </button>
                <button type="button" class="btn btn-export" onclick="toggleConfig()">
                    ‚ùå Fechar
                </button>
            </div>
            <div id="connectionStatus" class="status-message"></div>
        </div>

        <!-- Se√ß√£o de Limpeza de Dados -->
        <div class="clear-data-section" id="clearDataSection">
            <div class="clear-data-title">üßπ Limpeza de Dados</div>
            <div class="clear-data-warning">
                ‚ö†Ô∏è ATEN√á√ÉO: Esta opera√ß√£o ir√° remover PERMANENTEMENTE todos os registros de transfers do sistema!
                <br>Esta a√ß√£o n√£o pode ser desfeita.
            </div>
            <div class="clear-data-actions">
                <button type="button" class="btn btn-danger" onclick="clearAllData()" id="clearDataBtn">
                    üóëÔ∏è Limpar Todos os Dados
                </button>
                <button type="button" class="btn btn-warning" onclick="clearTestData()" id="clearTestBtn">
                    üß™ Limpar Apenas Testes
                </button>
                <button type="button" class="btn btn-clear" onclick="toggleClearData()">
                    ‚ùå Fechar
                </button>
            </div>
        </div>

        <div class="quick-add">
            <h2>üìù Solicitar Novo Transfer</h2>
            
            <form id="transferForm">
                <div class="form-grid">
                    <div class="form-group">
    <label for="nomeCliente">üë§ Nome do Cliente *</label>
    <input type="text" id="nomeCliente" required placeholder="Ex: Jo√£o Silva">
</div>

<div class="form-group">
    <label for="referencia">üìã Refer√™ncia da Reserva</label>
    <input type="text" id="referencia" maxlength="100" placeholder="Ex: Booking.com, Expedia, etc.">
</div>
                    
                    <div class="form-group">
                        <label for="tipoServico">üöó Tipo de Servi√ßo</label>
                        <div class="service-buttons">
                            <button type="button" class="btn-service active" onclick="setServiceType('transfer')">
                                üöó Transfer
                            </button>
                            <button type="button" class="btn-service" onclick="setServiceType('tour')">
                                üåü Tour Regular
                            </button>
                            <button type="button" class="btn-service" onclick="setServiceType('private')">
                                üëë Private Tour
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group tour-selector" id="tourSelector">
                        <label for="tourSelecionado">üéØ Selecione o Tour</label>
                        <select id="tourSelecionado" onchange="updateTourPrice()">
                            <option value="">Escolha o tour...</option>
                            <optgroup label="üåü Tours Regulares (Por Pessoa)">
                                <option value="tour-sintra-cascais" data-price="67" data-type="regular">
                                    üè∞ Sintra e Cascais (8h) - ‚Ç¨67/pessoa
                                </option>
                                <option value="tour-fatima-obidos" data-price="83" data-type="regular">
                                    ‚õ™ F√°tima e √ìbidos (8h) - ‚Ç¨83/pessoa
                                </option>
                                <option value="tour-combo-2dias" data-price="138" data-type="regular">
                                    üé´ Combo 2 Dias (16h) - ‚Ç¨138/pessoa
                                </option>
                            </optgroup>
                            <optgroup label="üëë Private Tours (Por Grupo)">
                                <option value="private-sintra-palaces" data-price-small="347" data-price-large="492" data-type="private">
                                    üè∞ Palaces of Sintra - ‚Ç¨347 (1-3) / ‚Ç¨492 (4-8)
                                </option>
                                <option value="private-evora" data-price-small="347" data-price-large="492" data-type="private">
                                    üèõÔ∏è √âvora City - ‚Ç¨347 (1-3) / ‚Ç¨492 (4-8)
                                </option>
                                <option value="private-templars" data-price-small="347" data-price-large="492" data-type="private">
                                    ‚öîÔ∏è Templars - ‚Ç¨347 (1-3) / ‚Ç¨492 (4-8)
                                </option>
                                <option value="private-arrabida" data-price-small="347" data-price-large="492" data-type="private">
                                    üåä Arr√°bida - ‚Ç¨347 (1-3) / ‚Ç¨492 (4-8)
                                </option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="numeroPessoas">üë• N√∫mero de Pessoas *</label>
                        <div class="people-buttons">
                            <button type="button" class="btn-people" onclick="setPeople(1)" title="1 pessoa">üë§</button>
                            <button type="button" class="btn-people" onclick="setPeople(2)" title="2 pessoas">üë•</button>
                            <button type="button" class="btn-people" onclick="setPeople(3)" title="3 pessoas">3</button>
                            <button type="button" class="btn-people" onclick="setPeople(4)" title="4 pessoas">4</button>
                            <button type="button" class="btn-people" onclick="setPeople(5)" title="5 pessoas">5</button>
                            <button type="button" class="btn-people" onclick="setPeople(6)" title="6 pessoas">6</button>
                            <button type="button" class="btn-people" onclick="setPeople(7)" title="7 pessoas">7</button>
                            <button type="button" class="btn-people" onclick="setPeople(8)" title="8+ pessoas">8+</button>
                        </div>
                        <input type="number" id="numeroPessoas" min="1" max="20" required style="display: none;" onchange="updateCalculation()">
                    </div>
                    
                    <div class="form-group">
                        <label for="numeroBagagens">üß≥ N√∫mero de Bagagens</label>
                        <div class="baggage-buttons">
                            <button type="button" class="btn-baggage" onclick="setBaggage(0)" title="Sem bagagem">üéí</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(1)" title="1 bagagem">üß≥</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(2)" title="2 bagagens">2</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(3)" title="3 bagagens">3</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(4)" title="4 bagagens">4</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(5)" title="5 bagagens">5</button>
                            <button type="button" class="btn-baggage" onclick="setBaggage(6)" title="6+ bagagens">6+</button>
                        </div>
                        <input type="number" id="numeroBagagens" min="0" max="20" value="0" style="display: none;">
                    </div>
                    
                    <div class="form-group">
                        <label for="data">üìÖ Data do Transfer *</label>
                        <div class="date-buttons">
                            <button type="button" class="btn-date" onclick="setDate('today')">üìÖ Hoje</button>
                            <button type="button" class="btn-date" onclick="setDate('tomorrow')">üóìÔ∏è Amanh√£</button>
                        </div>
                        <input type="date" id="data" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="horaPickup">üïê Hora de Pick-up *</label>
                        <div class="time-buttons">
                            <button type="button" class="btn-time" onclick="setTime('06:00')">üïï 06:00</button>
                            <button type="button" class="btn-time" onclick="setTime('07:00')">üïñ 07:00</button>
                            <button type="button" class="btn-time" onclick="setTime('08:00')">üïó 08:00</button>
                            <button type="button" class="btn-time" onclick="setTime('09:00')">üïò 09:00</button>
                            <button type="button" class="btn-time" onclick="setTime('10:00')">üïô 10:00</button>
                            <button type="button" class="btn-time" onclick="setTime('11:00')">üïö 11:00</button>
                        </div>
                        <div class="time-buttons" style="margin-top: 10px;">
                            <button type="button" class="btn-time" onclick="setTime('12:00')">üïõ 12:00</button>
                            <button type="button" class="btn-time" onclick="setTime('13:00')">üïê 13:00</button>
                            <button type="button" class="btn-time" onclick="setTime('14:00')">üïë 14:00</button>
                            <button type="button" class="btn-time" onclick="setTime('15:00')">üïí 15:00</button>
                            <button type="button" class="btn-time" onclick="setTime('16:00')">üïì 16:00</button>
                            <button type="button" class="btn-time" onclick="setTime('17:00')">üïî 17:00</button>
                        </div>
                        <div class="time-buttons" style="margin-top: 10px;">
                            <button type="button" class="btn-time" onclick="setTime('18:00')">üïï 18:00</button>
                            <button type="button" class="btn-time" onclick="setTime('19:00')">üïñ 19:00</button>
                            <button type="button" class="btn-time" onclick="setTime('20:00')">üïó 20:00</button>
                            <button type="button" class="btn-time" onclick="setTime('21:00')">üïò 21:00</button>
                            <button type="button" class="btn-time" onclick="setTime('22:00')">üïô 22:00</button>
                            <button type="button" class="btn-time" onclick="setTime('23:00')">üïö 23:00</button>
                        </div>
                        <input type="time" id="horaPickup" required>
                        <small style="color: #666; display: block; margin-top: 5px;">
                            ‚è∞ Formato: HH:MM (ex: 09:30)
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="contacto">üì± Contacto do Cliente *</label>
                        <div class="phone-container">
                            <input type="tel" id="contacto" required placeholder="Digite o n√∫mero...">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="numeroVoo">‚úàÔ∏è N√∫mero do Voo</label>
                        <input type="text" id="numeroVoo" placeholder="Ex: TP1234">
                    </div>
                    
                    <div class="form-group">
                        <label for="origem">üìç Local de Origem *</label>
                        <div class="location-buttons">
                            <button type="button" class="btn-location origem-btn" onclick="setOrigin('Aeroporto de Lisboa')">
                                ‚úàÔ∏è Aeroporto de Lisboa
                            </button>
                            <button type="button" class="btn-location origem-btn" onclick="setOrigin('Hotel Principal')">
    üè® Hotel Principal
</button>
                        </div>
                        <input type="text" id="origem" required placeholder="Digite ou escolha o endere√ßo...">
                    </div>
                    
                    <div class="form-group">
                        <label for="destino">üéØ Local de Destino *</label>
                        <div class="location-buttons">
                            <button type="button" class="btn-location destino-btn" onclick="setDestination('Hotel Principal')">
    üè® Hotel Principal
</button>
                            <button type="button" class="btn-location destino-btn" onclick="setDestination('Aeroporto de Lisboa')">
                                ‚úàÔ∏è Aeroporto de Lisboa
                            </button>
                        </div>
                        <input type="text" id="destino" required placeholder="Digite ou escolha o endere√ßo...">
                    </div>
                    
                    <div class="form-group">
                        <label for="valorTotal">üí∞ Valor do Servi√ßo (‚Ç¨) *</label>
                        <div class="price-buttons">
                            <button type="button" class="btn-price" onclick="setPrice(25)">üí∞ ‚Ç¨25</button>
                            <button type="button" class="btn-price" onclick="setPrice(35)">üí∞ ‚Ç¨35</button>
                            <button type="button" class="btn-price" onclick="setPrice(45)">üí∞ ‚Ç¨45</button>
                            <button type="button" class="btn-price" onclick="setPrice(60)">üí∞ ‚Ç¨60</button>
                            <button type="button" class="btn-price" onclick="setPrice(75)">üí∞ ‚Ç¨75</button>
                            <button type="button" class="btn-price" onclick="setPrice(100)">üí∞ ‚Ç¨100</button>
                        </div>
                        <input type="number" id="valorTotal" step="0.01" required placeholder="Ou digite valor...">
                    </div>
                    
                    <div class="form-group">
                        <label for="modoPagamento">üí≥ Forma de Pagamento *</label>
                        <div class="payment-buttons">
                            <button type="button" class="btn-payment" onclick="setPayment('Dinheiro')">
                                üíµ Dinheiro
                            </button>
                            <button type="button" class="btn-payment" onclick="setPayment('Cart√£o')">
                                üí≥ Cart√£o
                            </button>
                            <button type="button" class="btn-payment" onclick="setPayment('Transfer√™ncia')">
                                üè¶ Transfer√™ncia
                            </button>
                        </div>
                        <select id="modoPagamento" required style="display: none;">
                            <option value="">Selecionar...</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Cart√£o">Cart√£o</option>
                            <option value="Transfer√™ncia">Transfer√™ncia Banc√°ria</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="pagoParaQuem">üë®‚Äçüíº Pago Para *</label>
                        <div class="payment-to-buttons">
                            <button type="button" class="btn-payment-to" onclick="setPaymentTo('Recep√ß√£o')">
                                üë®‚Äçüíº Recep√ß√£o
                            </button>
                            <button type="button" class="btn-payment-to" onclick="setPaymentTo('Motorista')">
                                üöó Motorista
                            </button>
                        </div>
                        <select id="pagoParaQuem" required style="display: none;">
                            <option value="">Selecionar...</option>
                            <option value="Recep√ß√£o">Recep√ß√£o</option>
                            <option value="Motorista">Motorista</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="observacoes">üìù Observa√ß√µes</label>
                        <div class="obs-buttons">
                            <button type="button" class="btn-obs" onclick="addObservation('Bagagem extra')">üß≥ Bagagem Extra</button>
                            <button type="button" class="btn-obs" onclick="addObservation('Transfer urgente')">‚ö° Urgente</button>
                            <button type="button" class="btn-obs" onclick="addObservation('Cliente VIP')">‚≠ê VIP</button>
                            <button type="button" class="btn-obs" onclick="addObservation('Com crian√ßa')">üë∂ Com Crian√ßa</button>
                        </div>
                        <textarea id="observacoes" rows="3" placeholder="Informa√ß√µes adicionais..."></textarea>
                    </div>
                </div>

                <!-- Box de C√°lculo de Pre√ßo -->
                <div class="price-calculation-box" id="priceCalculationBox">
                    <div class="calculation-header">üíπ C√°lculo do Valor Total</div>
                    <div class="calculation-details">
                        <div class="calculation-row">
                            <span class="calculation-label">Tipo de Servi√ßo:</span>
                            <span class="calculation-value" id="calcTipoServico">-</span>
                        </div>
                        <div class="calculation-row">
                            <span class="calculation-label">Pre√ßo Unit√°rio:</span>
                            <span class="calculation-value" id="calcPrecoUnitario">‚Ç¨0</span>
                        </div>
                        <div class="calculation-row">
                            <span class="calculation-label">Quantidade de Pessoas:</span>
                            <span class="calculation-value" id="calcPessoas">0</span>
                        </div>
                    </div>
                    <div class="calculation-total">
                        üí∞ VALOR TOTAL: ‚Ç¨<span id="calcTotal">0</span>
                    </div>
                    <!-- Campos Admin -->
                    <div class="admin-fields" id="adminFields">
                        <div class="calculation-row">
                            <span class="calculation-label">üè® Valor Hotel (30%):</span>
                            <span class="calculation-value" id="calcHotel">‚Ç¨0</span>
                        </div>
                        <div class="calculation-row">
                            <span class="calculation-label">üöó Valor HUB Transfer:</span>
                            <span class="calculation-value" id="calcHUB">‚Ç¨0</span>
                        </div>
                        <div class="calculation-row">
                            <span class="calculation-label">üë®‚Äçüíº Comiss√£o Recep√ß√£o:</span>
                            <span class="calculation-value" id="calcRecepcao">‚Ç¨0</span>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">üìã Solicitar Transfer</button>
                    <button type="button" class="btn btn-clear" onclick="clearForm()">üßπ Limpar</button>
                    <button type="button" class="btn btn-export" onclick="exportToCSV()">üìä Exportar CSV</button>
                    <button type="button" class="btn btn-success" onclick="syncWithServer()" id="syncBtn">üîÑ Atualizar Dados</button>
                    <button type="button" class="btn btn-config" onclick="toggleConfig()">‚öôÔ∏è Configurar</button>
                    <button type="button" class="btn btn-danger" onclick="toggleClearData()">üóëÔ∏è Limpar Dados</button>
                </div>
            </form>
        </div>

        <div class="summary-section">
            <!-- Indicador de Filtros -->
            <div class="filter-indicator" id="filterIndicator"></div>

            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-number" id="totalServices">0</div>
                    <div class="summary-label">üìä Total de Servi√ßos</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="pendingServices">0</div>
                    <div class="summary-label">‚è≥ Solicitados</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="confirmedServices">0</div>
                    <div class="summary-label">‚úÖ Confirmados</div>
                </div>
                <div class="summary-card">
                    <div class="summary-number" id="completedServices">0</div>
                    <div class="summary-label">üèÅ Finalizados</div>
                </div>
            </div>

            <div class="financial-summary">
                <h3 style="text-align: center; margin-bottom: 25px; font-size: 1.8rem;">üí∞ Resumo Financeiro</h3>
                <div class="financial-grid">
                    <div class="financial-item">
                        <div class="financial-value" id="totalRevenue">‚Ç¨0.00</div>
                        <div class="financial-label">üíµ Receita Total</div>
                    </div>
                    <div class="financial-item">
                        <div class="financial-value" id="pendingRevenue">‚Ç¨0.00</div>
                        <div class="financial-label">‚è≥ Valor Pendente</div>
                    </div>
                    <div class="financial-item">
                        <div class="financial-value" id="confirmedRevenue">‚Ç¨0.00</div>
                        <div class="financial-label">‚úÖ Valor Confirmado</div>
                    </div>
                    <div class="financial-item">
                        <div class="financial-value" id="completedRevenue">‚Ç¨0.00</div>
                        <div class="financial-label">üèÅ Valor Finalizado</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="services-section">
            <div class="services-header">
                <h2 class="services-title">üöó Servi√ßos de Transfer</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filterDateStart">üìÖ Data In√≠cio:</label>
                        <input type="date" id="filterDateStart" onchange="updateDateFilter()">
                    </div>
                    <div class="filter-group">
                        <label for="filterDateEnd">üìÖ Data Fim:</label>
                        <input type="date" id="filterDateEnd" onchange="updateDateFilter()">
                    </div>
                    <div class="filter-group">
                        <label>‚ö° Per√≠odos R√°pidos:</label>
                        <select id="quickPeriodSelect" onchange="applyQuickPeriod()">
                            <option value="">Personalizado</option>
                            <option value="today">üìÖ Hoje</option>
                            <option value="yesterday">üìÖ Ontem</option>
                            <option value="thisWeek">üìÜ Esta Semana</option>
                            <option value="lastWeek">üìÜ Semana Passada</option>
                            <option value="thisMonth">üóìÔ∏è Este M√™s</option>
                            <option value="lastMonth">üóìÔ∏è M√™s Passado</option>
                            <option value="last7days">üìä √öltimos 7 Dias</option>
                            <option value="last30days">üìä √öltimos 30 Dias</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filterStatus">üè∑Ô∏è Status:</label>
                        <select id="filterStatus" onchange="updateStatusFilter()">
                            <option value="">Todos</option>
                            <option value="Solicitado">‚è≥ Solicitado</option>
                            <option value="Confirmado">‚úÖ Confirmado</option>
                            <option value="Finalizado">üèÅ Finalizado</option>
                            <option value="Cancelado">‚ùå Cancelado</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="searchClient">üîç Cliente:</label>
                        <input type="text" id="searchClient" placeholder="Buscar..." onkeyup="updateClientFilter()">
                    </div>
                    <div class="filter-group">
                        <label for="filterTipoServico">üöó Tipo Servi√ßo:</label>
                        <select id="filterTipoServico" onchange="updateServiceTypeFilter()">
                            <option value="">Todos</option>
                            <option value="Transfer">üöó Transfer</option>
                            <option value="Tour Regular">üåü Tour Regular</option>
                            <option value="Private Tour">üëë Private Tour</option>
                        </select>
                    </div>
                </div>
                
                <div class="filter-actions" style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-primary" onclick="applyAllFilters()">
                        üîç Aplicar Filtros
                    </button>
                    <button type="button" class="btn btn-clear" onclick="clearAllFilters()">
                        üßπ Limpar Filtros
                    </button>
                    <button type="button" class="btn btn-success" onclick="loadTransfersFromSheets()">
                        üì• Carregar Transfers
                    </button>
                    <button type="button" class="btn btn-warning" onclick="testBasicConnectivity()">
                        üîó Testar Conex√£o
                    </button>
                    <span id="lastSyncDisplay" style="font-size: 12px; color: #666; margin-left: 10px;"></span>
                </div>
            </div>
            
            <div class="services-table">
                <div class="table-container" id="tableContainer">
                    <table id="servicesTable">
                        <thead>
                            <tr>
                                <th>üÜî ID</th>
                                <th>üìã Ref</th>
                                <th>üë§ Cliente</th>
                                <th>üöó Tipo</th>
                                <th>üë• Pessoas</th>
                                <th>üß≥ Bagagens</th>
                                <th>üìÖ Data</th>
                                <th>üïê Hora Pick-up</th>
                                <th>üì± Contacto</th>
                                <th>‚úàÔ∏è Voo</th>
                                <th>üó∫Ô∏è Rota</th>
                                <th>üí∞ Valor Total</th>
                                <th class="admin-column" style="display: none;">üè® Valor Hotel</th>
                                <th class="admin-column" style="display: none;">üöó Valor HUB</th>
                                <th class="admin-column" style="display: none;">üë®‚Äçüíº Comiss√£o Recep√ß√£o</th>
                                <th>üí≥ Pagamento</th>
                                <th>üë®‚Äçüíº Pago Para</th>
                                <th>üè∑Ô∏è Status</th>
                                <th>‚öôÔ∏è A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="servicesTableBody">
                            <tr>
                                <td colspan="19" class="empty-state">
                                    <h3>üì≠ Nenhum servi√ßo cadastrado</h3>
                                    <p>Use o bot√£o "üì• Carregar Transfers" para sincronizar com o Google Sheets</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="scroll-indicator" id="scrollIndicator" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√£o Admin -->
    <div class="admin-toggle" onclick="toggleAdminMode()">üë®‚Äçüíª Admin</div>

    <script>
    /**
     * Garante que hor√°rio esteja no formato HH:MM
     */
    function formatarHorarioParaTexto(horario) {
        if (!horario) return '';
        
        // Se j√° est√° no formato correto, retorna
        if (/^\d{2}:\d{2}$/.test(horario)) {
            return horario;
        }
        
        // Tenta extrair HH:MM
        const match = horario.toString().match(/(\d{1,2}):(\d{2})/);
        if (match) {
            const h = match[1].padStart(2, '0');
            const m = match[2];
            return `${h}:${m}`;
        }
        
        return '';
    }
        
        // =====================================================
        // VARI√ÅVEIS GLOBAIS
        // =====================================================
        let services = [];
        let editingId = null;
        let phoneInput = null;
        let isConnected = false;
        let isAdminMode = false;
        let currentServiceType = 'transfer';
        let precoUnitarioAtual = 0;
        let syncInProgress = false;
        let lastSyncTime = null;
        let serverData = [];
        let nextAvailableId = 1;
        
        let activeFilters = {
            dateStart: null,
            dateEnd: null,
            status: '',
            cliente: '',
            quickPeriod: '',
            tipoServico: ''
        };
        
        let filteredData = [];
        let isFiltering = false;

        // Vari√°veis de pagina√ß√£o
        let currentPage = 1;
        let itemsPerPage = 10;
        let totalPages = 1;

        // CONFIGURA√á√ïES
const WEBAPP_URL = 'https://script.google.com/macros/s/AKfycbzVi4OAhQmh6A9O4B55iJZ0TXjgg6SDPgnXFbfiK3HUEyLXOmhJVW3pcEcr-MDcaYFWTw/exec';
const TEST_EMAIL = 'juniorgutierezbega@gmail.com';
const SPREADSHEET_ID = '15zfdrXZaR49HrVsHzpszLLbqFKCenvMn11IvMkYSMHI';
        
        // TOURS E PRE√áOS
        const TOURS_DATA = {
            'tour-sintra-cascais': { name: 'Sintra e Cascais (8h)', price: 67, type: 'regular' },
            'tour-fatima-obidos': { name: 'F√°tima e √ìbidos (8h)', price: 83, type: 'regular' },
            'tour-combo-2dias': { name: 'Combo 2 Dias (16h)', price: 138, type: 'regular' },
            'private-sintra-palaces': { name: 'Private Palaces of Sintra', priceSmall: 347, priceLarge: 492, type: 'private' },
            'private-evora': { name: 'Private √âvora City', priceSmall: 347, priceLarge: 492, type: 'private' },
            'private-templars': { name: 'Private Templars', priceSmall: 347, priceLarge: 492, type: 'private' },
            'private-arrabida': { name: 'Private Arr√°bida', priceSmall: 347, priceLarge: 492, type: 'private' }
        };

        // =====================================================
        // FUN√á√ïES DE PAGINA√á√ÉO
        // =====================================================
        function updatePagination() {
            const totalItems = services.length;
            totalPages = Math.ceil(totalItems / itemsPerPage);
            
            let paginationContainer = document.getElementById('paginationContainer');
            if (!paginationContainer) {
                paginationContainer = document.createElement('div');
                paginationContainer.id = 'paginationContainer';
                paginationContainer.className = 'pagination-container';
                
                const servicesTable = document.querySelector('.services-table');
                servicesTable.parentNode.insertBefore(paginationContainer, servicesTable.nextSibling);
            }
            
            paginationContainer.innerHTML = `
                <div class="pagination-info">
                    üìä Mostrando ${Math.min(((currentPage - 1) * itemsPerPage) + 1, totalItems)} a ${Math.min(currentPage * itemsPerPage, totalItems)} de ${totalItems} transfers
                </div>
                <div class="pagination-controls">
                    <button class="btn-pagination" onclick="changePage(1)" ${currentPage === 1 ? 'disabled' : ''}>
                        ‚è™ ¬´¬´
                    </button>
                    <button class="btn-pagination" onclick="changePage(currentPage - 1)" ${currentPage === 1 ? 'disabled' : ''}>
                        ‚¨ÖÔ∏è Anterior
                    </button>
                    <span style="margin: 0 15px; font-weight: 600;">
                        üìÑ P√°gina ${currentPage} de ${totalPages}
                    </span>
                    <button class="btn-pagination" onclick="changePage(currentPage + 1)" ${currentPage === totalPages ? 'disabled' : ''}>
                        Pr√≥xima ‚û°Ô∏è
                    </button>
                    <button class="btn-pagination" onclick="changePage(totalPages)" ${currentPage === totalPages ? 'disabled' : ''}>
                        ¬ª¬ª ‚è©
                    </button>
                </div>
                <select class="page-size-selector" onchange="changePageSize(this.value)">
                    <option value="10" ${itemsPerPage === 10 ? 'selected' : ''}>üìÑ 10 por p√°gina</option>
                    <option value="25" ${itemsPerPage === 25 ? 'selected' : ''}>üìÑ 25 por p√°gina</option>
                    <option value="50" ${itemsPerPage === 50 ? 'selected' : ''}>üìÑ 50 por p√°gina</option>
                </select>
            `;
        }

        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTable();
        }

        function changePageSize(size) {
            itemsPerPage = parseInt(size);
            currentPage = 1;
            renderTable();
        }

        function getPaginatedServices() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            return services.slice(startIndex, endIndex);
        }

        // =====================================================
        // FUN√á√ïES DE CONFIGURA√á√ÉO E STATUS
        // =====================================================
        function toggleConfig() {
            const configSection = document.getElementById('configSection');
            if (configSection) {
                configSection.classList.toggle('show');
            }
            console.log('toggleConfig executada');
        }

        function toggleClearData() {
            const clearSection = document.getElementById('clearDataSection');
            if (clearSection) {
                clearSection.classList.toggle('show');
            }
        }

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('connectionStatus');
            if (!statusDiv) {
                console.warn('Elemento connectionStatus n√£o encontrado');
                return;
            }
            
            statusDiv.className = `status-message status-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            console.log(`Status: ${type} - ${message}`);
            
            setTimeout(() => {
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
            }, 5000);
        }

        function setButtonLoading(buttonId, loading = true) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            if (loading) {
                button.disabled = true;
                button.classList.add('loading');
                const originalText = button.textContent;
                button.setAttribute('data-original-text', originalText);
                button.textContent = '‚è≥ Carregando...';
            } else {
                button.disabled = false;
                button.classList.remove('loading');
                const originalText = button.getAttribute('data-original-text');
                if (originalText) {
                    button.textContent = originalText;
                } else {
                    if (buttonId === 'testBtn') button.textContent = '‚úÖ Testar Conex√£o';
                    else if (buttonId === 'submitBtn') button.textContent = 'üìã Solicitar Transfer';
                    else if (buttonId === 'syncBtn') button.textContent = 'üîÑ Atualizar Dados';
                    else if (buttonId === 'clearDataBtn') button.textContent = 'üóëÔ∏è Limpar Todos os Dados';
                    else if (buttonId === 'clearTestBtn') button.textContent = 'üß™ Limpar Apenas Testes';
                }
            }
        }

        // =====================================================
        // FUN√á√ïES DE CONEX√ÉO E TESTE
        // =====================================================
        async function testConnection() {
            const url = document.getElementById('webappUrl').value.trim() || WEBAPP_URL;
            
            if (!url) {
                showStatus('Por favor, insira a URL do Google Apps Script!', 'error');
                return;
            }
            
            setButtonLoading('testBtn', true);
            
            try {
                const response = await fetch(url + '?action=test', {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    isConnected = true;
                    showStatus('‚úÖ Conex√£o funcionando perfeitamente!', 'success');
                    saveWebappUrl();
                    document.getElementById('syncBtn').style.display = 'inline-block';
                } else {
                    throw new Error('Resposta n√£o OK');
                }
                
            } catch (error) {
                try {
                    await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify({ action: 'test' }),
                        mode: 'no-cors'
                    });
                    
                    isConnected = true;
                    showStatus('‚úÖ Conex√£o estabelecida (modo limitado)', 'success');
                    saveWebappUrl();
                    document.getElementById('syncBtn').style.display = 'inline-block';
                    
                } catch (fallbackError) {
                    showStatus('‚ùå Erro ao conectar. Verifique a URL e o deploy', 'error');
                    isConnected = false;
                }
            } finally {
                setButtonLoading('testBtn', false);
            }
        }

        function saveWebappUrl() {
            const url = document.getElementById('webappUrl').value.trim() || WEBAPP_URL;
            if (url) {
                localStorage.setItem('webappUrl', url);
                document.getElementById('syncBtn').style.display = 'inline-block';
                isConnected = true;
            }
        }

        function getWebAppUrl() {
            const inputUrl = document.getElementById('webappUrl');
            if (inputUrl && inputUrl.value && inputUrl.value.trim() !== '') {
                return inputUrl.value.trim();
            }
            
            const savedUrl = localStorage.getItem('webappUrl');
            if (savedUrl && savedUrl.trim() !== '') {
                return savedUrl.trim();
            }
            
            return WEBAPP_URL;
        }

        async function testBasicConnectivity() {
            console.log('üîó Testando conectividade b√°sica...');
            
            const webappUrl = getWebAppUrl();
            
            try {
                const pingResponse = await fetch(webappUrl + '?ping=true', {
                    method: 'GET',
                    mode: 'no-cors'
                });
                
                console.log('üì° Ping enviado');
                showStatus('üì° Teste de conectividade enviado', 'success');
                
                const testData = {
                    action: 'test',
                    message: 'TESTE Sistema funcionando',
                    timestamp: new Date().toISOString()
                };
                
                await fetch(webappUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: JSON.stringify(testData),
                    mode: 'no-cors'
                });
                
                console.log('‚úÖ Teste de conectividade completo');
                showStatus('‚úÖ Conectividade OK - Sistema funcionando', 'success');
                
            } catch (error) {
                console.error('‚ùå Erro no teste de conectividade:', error);
                showStatus('‚ùå Erro de conectividade: ' + error.message, 'error');
            }
        }

        // =====================================================
        // FUN√á√ïES DE EMOJI PARA INTERFACE
        // =====================================================
        function getTimeEmoji(time) {
            if (!time) return 'üïê';
            
            const hour = parseInt(time.split(':')[0]);
            const emojis = ['üïõ', 'üïê', 'üïë', 'üïí', 'üïì', 'üïî', 'üïï', 'üïñ', 'üïó', 'üïò', 'üïô', 'üïö'];
            
            if (hour >= 0 && hour <= 11) {
                return emojis[hour];
            } else if (hour >= 12 && hour <= 23) {
                return emojis[hour - 12];
            }
            
            return 'üïê';
        }

        function getLocationEmoji(location) {
            if (!location) return 'üìç';
            
            const locationLower = location.toLowerCase();
            
            if (locationLower.includes('aeroporto') || locationLower.includes('airport')) {
                return '‚úàÔ∏è';
            } else if (locationLower.includes('hotel')) {
                return 'üè®';
            } else if (locationLower.includes('esta√ß√£o') || locationLower.includes('train')) {
                return 'üöÇ';
            } else if (locationLower.includes('porto') || locationLower.includes('port')) {
                return 'üö¢';
            }
            
            return 'üìç';
        }

        function getPeopleEmoji(count) {
            if (count === 1) return 'üë§';
            if (count === 2) return 'üë•';
            if (count <= 4) return 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
            if (count <= 8) return 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶üë®‚Äçüë©‚Äçüëß‚Äçüë¶';
            return 'üéâ';
        }

        function getBaggageEmoji(count) {
            if (count === 0) return 'üéí';
            if (count === 1) return 'üß≥';
            if (count <= 3) return 'üß≥üß≥';
            return 'üß≥üß≥üß≥';
        }

        function createWhatsAppLink(phoneNumber) {
            if (!phoneNumber || phoneNumber === 'Sem contacto') return phoneNumber;
            
            const cleanNumber = phoneNumber.replace(/[^\d+]/g, '');
            
            return `<a href="https://wa.me/${cleanNumber}" target="_blank" class="phone-link" title="Abrir WhatsApp">
                <span>üì±</span> ${phoneNumber}
            </a>`;
        }

        function createFlightLink(flightNumber) {
            if (!flightNumber || flightNumber === '-' || flightNumber === '') return '-';
            
            return `<a href="https://www.google.com/search?q=flight+${encodeURIComponent(flightNumber)}" target="_blank" class="flight-link" title="Rastrear voo">
                <span>‚úàÔ∏è</span> ${flightNumber}
            </a>`;
        }

// =====================================================
// FUN√á√ÉO DE CARREGAMENTO DE DADOS DO GOOGLE SHEETS - V2.0
// SUBSTITUI√á√ÉO COMPLETA (N√ÉO FAZ MERGE)
// =====================================================

/**
 * CARREGAR TRANSFERS DO GOOGLE SHEETS - VERS√ÉO CORRIGIDA V2
 * Sincroniza√ß√£o manual for√ßada com tratamento robusto de erros
 */
async function loadTransfersFromSheets() {
    console.log('üîÑ Iniciando carregamento de transfers do Google Sheets...');
    
    // Desabilitar bot√£o durante sincroniza√ß√£o
    const btnAtualizar = document.querySelector('button[onclick="loadTransfersFromSheets()"]');
    if (btnAtualizar) {
        btnAtualizar.disabled = true;
        btnAtualizar.textContent = '‚è≥ Sincronizando...';
    }
    
    try {
        // Verificar se WEBAPP_URL est√° configurado
        if (!WEBAPP_URL || WEBAPP_URL === 'SUA_URL_WEBAPP_AQUI') {
            console.error('‚ùå WEBAPP_URL n√£o configurado');
            showStatus('Configure a URL do WebApp primeiro', 'error');
            return;
        }
        
        console.log('üì° URL do WebApp:', WEBAPP_URL);
        
        // Fazer requisi√ß√£o com timeout e retry
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 segundos timeout
        
        const response = await fetch(WEBAPP_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'getTransfers'
            }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        console.log('üì• Resposta recebida:', response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('üì¶ Dados recebidos:', data);
        
        // Validar estrutura da resposta
        if (!data || typeof data !== 'object') {
            throw new Error('Resposta inv√°lida do servidor (n√£o √© objeto)');
        }
        
        // Verificar diferentes formatos de resposta poss√≠veis
        let transfersData = [];
        
        if (data.success && Array.isArray(data.data)) {
            transfersData = data.data;
        } else if (data.sucesso && Array.isArray(data.dados)) {
            transfersData = data.dados;
        } else if (Array.isArray(data.transfers)) {
            transfersData = data.transfers;
        } else if (Array.isArray(data)) {
            transfersData = data;
        } else {
            console.error('‚ùå Formato de dados n√£o reconhecido:', data);
            throw new Error('Formato de resposta inv√°lido');
        }
        
        console.log(`üìä ${transfersData.length} transfers recebidos do servidor`);
        
        // Converter dados do formato Sheets para formato do sistema
        const transfersConvertidos = transfersData.map(row => {
            // row √© um array: [ID, Cliente, TipoServico, Pessoas, ...]
            return {
                id: row[0] || '',
                cliente: row[1] || '',
                tipoServico: row[2] || 'Transfer',
                pessoas: parseInt(row[3]) || 1,
                bagagens: parseInt(row[4]) || 0,
                data: row[5] || '',
                contacto: row[6] || '',
                voo: row[7] || '',
                origem: row[8] || '',
                destino: row[9] || '',
                horaPickup: row[10] || '', // ‚úÖ J√Å VEM FORMATADO DO BACKEND
                precoCliente: parseFloat(row[11]) || 0,
                valorHotel: parseFloat(row[12]) || 0,
                valorHUB: parseFloat(row[13]) || 0,
                comissaoRecepcao: parseFloat(row[14]) || 0,
                formaPagamento: row[15] || 'Dinheiro',
                pagoPara: row[16] || 'HUB',
                status: row[17] || 'Solicitado',
                observacoes: row[18] || '',
                dataCriacao: row[19] || new Date().toISOString(),
                referencia: row[20] || ''
            };
        });
        
        // Atualizar array global
        services = transfersConvertidos;
        
        // Salvar localmente
        saveData();
        
        // Atualizar interface
        renderTable();
        updateSummary();
        
        // Atualizar timestamp de sincroniza√ß√£o
        lastSyncTime = new Date().toLocaleString('pt-PT');
        
        console.log('‚úÖ Sincroniza√ß√£o conclu√≠da com sucesso!');
        console.log('üìä Total de transfers carregados:', services.length);
        
        showStatus(`‚úÖ ${services.length} transfers sincronizados com sucesso!`, 'success');
        
    } catch (error) {
        console.error('‚ùå Erro detalhado na sincroniza√ß√£o:', error);
        
        let mensagemErro = 'Erro ao sincronizar com Google Sheets';
        
        if (error.name === 'AbortError') {
            mensagemErro = 'Timeout: Servidor demorou muito para responder';
        } else if (error.message.includes('Failed to fetch')) {
            mensagemErro = 'Erro de conex√£o: Verifique a URL do WebApp e suas permiss√µes';
        } else if (error.message.includes('HTTP')) {
            mensagemErro = `Erro do servidor: ${error.message}`;
        } else {
            mensagemErro = error.message;
        }
        
        showStatus(mensagemErro, 'error');
        
        // Se n√£o h√° dados locais, manter interface vazia
        if (services.length === 0) {
            console.log('‚ÑπÔ∏è Nenhum dado local dispon√≠vel, mantendo tabela vazia');
        }
        
    } finally {
        // Reabilitar bot√£o
        if (btnAtualizar) {
            btnAtualizar.disabled = false;
            btnAtualizar.textContent = 'üîÑ ATUALIZAR DADOS';
        }
    }
}
        
        function isValidResponse(result) {
            if (result.status === 'success') return true;
            if (result.message && result.message.includes('funcionando')) return true;
            if (result.data && Array.isArray(result.data)) return true;
            if (Array.isArray(result)) return true;
            if (result.success === true) return true;
            return false;
        }

        function convertServerDataToLocal(serverItem, index) {
            if (!serverItem || typeof serverItem !== 'object') {
                console.warn('Item inv√°lido do servidor:', serverItem);
                return null;
            }
            
            try {
                if (index === 0) {
                    console.log('Exemplo de item do servidor:', Object.keys(serverItem));
                }
                
                const getValue = (item, keys, defaultValue = '') => {
                    for (const key of keys) {
                        if (item[key] !== undefined && item[key] !== null && item[key] !== '') {
                            return item[key];
                        }
                    }
                    return defaultValue;
                };
                
                const getNumericValue = (item, keys, defaultValue = 0) => {
                    const value = getValue(item, keys, defaultValue);
                    const parsed = parseFloat(value);
                    return isNaN(parsed) ? defaultValue : parsed;
                };
                
                const getIntegerValue = (item, keys, defaultValue = 0) => {
                    const value = getValue(item, keys, defaultValue);
                    const parsed = parseInt(value);
                    return isNaN(parsed) ? defaultValue : parsed;
                };
                
                const formatPickupTime = (timeValue) => {
                    if (!timeValue) return '00:00';
                    
                    console.log('Valor da hora recebido:', timeValue, typeof timeValue);
                    
                    if (typeof timeValue === 'string' && /^\d{2}:\d{2}$/.test(timeValue)) {
                        return timeValue;
                    }
                    
                    if (typeof timeValue === 'string') {
                        const timeMatch = timeValue.match(/(\d{2}):(\d{2}):(\d{2})/);
                        if (timeMatch) {
                            return `${timeMatch[1]}:${timeMatch[2]}`;
                        }
                        
                        const shortTimeMatch = timeValue.match(/(\d{2}):(\d{2})/);
                        if (shortTimeMatch) {
                            return `${shortTimeMatch[1]}:${shortTimeMatch[2]}`;
                        }
                    }
                    
                    if (timeValue && typeof timeValue === 'object') {
                        try {
                            const timeStr = timeValue.toString();
                            console.log('String da hora:', timeStr);
                            
                            const timeMatch = timeStr.match(/(\d{2}):(\d{2}):(\d{2})/);
                            if (timeMatch) {
                                return `${timeMatch[1]}:${timeMatch[2]}`;
                            }
                            
                            if (timeValue.getHours && timeValue.getMinutes) {
                                const hours = timeValue.getHours().toString().padStart(2, '0');
                                const minutes = timeValue.getMinutes().toString().padStart(2, '0');
                                return `${hours}:${minutes}`;
                            }
                        } catch (e) {
                            console.error('Erro ao processar objeto de hora:', e);
                        }
                    }
                    
                    console.warn('N√£o foi poss√≠vel formatar a hora:', timeValue);
                    return '00:00';
                };

                const convertedData = {
                    id: getIntegerValue(serverItem, ['ID', 'id', 'Id'], Date.now() + index),
                    nomeCliente: getValue(serverItem, ['Cliente', 'Nome', 'Nome Cliente', 'cliente'], 'Cliente n√£o informado'),
                    referencia: getValue(serverItem, ['Refer√™ncia', 'Referencia', 'Ref', 'referencia', 'Coluna U'], ''),
                    tipoServico: getValue(serverItem, ['Tipo Servi√ßo', 'Tipo_Servico', 'TipoServico', 'Tipo'], 'Transfer'),
                    tourSelecionado: getValue(serverItem, ['Tour', 'Tour Selecionado', 'tour'], ''),
                    numeroPessoas: getIntegerValue(serverItem, ['Pessoas', 'Num Pessoas', 'NumPessoas', 'pessoas'], 1),
                    numeroBagagens: getIntegerValue(serverItem, ['Bagagens', 'Num Bagagens', 'NumBagagens', 'bagagens'], 0),
                    data: formatDateFromServer(getValue(serverItem, ['Data', 'Data Transfer', 'DataTransfer', 'data'])),
                    contacto: getValue(serverItem, ['Contacto', 'Contato', 'Telefone', 'contacto'], 'Sem contacto'),
                    numeroVoo: getValue(serverItem, ['Voo', 'Numero Voo', 'NumeroVoo', 'Flight', 'voo'], ''),
                    origem: getValue(serverItem, ['Origem', 'Local Origem', 'LocalOrigem', 'From', 'origem'], 'Origem n√£o informada'),
                    destino: getValue(serverItem, ['Destino', 'Local Destino', 'LocalDestino', 'To', 'destino'], 'Destino n√£o informado'),
                    horaPickup: formatPickupTime(serverItem['Hora Pick-up'] || serverItem.Hora_Pickup || serverItem.HoraPickup),
                    valorTotal: getNumericValue(serverItem, [
                        'Valor Total', 'Valor_Total', 'ValorTotal', 'Pre√ßo Cliente (‚Ç¨)', 
                        'Preco Cliente', 'Total', 'valor_total'
                    ], 0),
                    valorHotel: getNumericValue(serverItem, [
                        'Valor Hotel (30%)', 'Valor_Hotel', 'ValorHotel', 'Valor Hotel (‚Ç¨)',
                        'Valor Hotel', 'valor_hotel'
                    ], 0),
                    valorHUB: getNumericValue(serverItem, [
                        'Valor HUB', 'Valor_HUB', 'ValorHUB', 'Valor HUB Transfer (‚Ç¨)',
                        'HUB Transfer', 'valor_hub'
                    ], 0),
                    comissaoRecepcao: getNumericValue(serverItem, [
                        'Comiss√£o Recep√ß√£o', 'Comissao_Recepcao', 'ComissaoRecepcao', 'Comiss√£o Recep√ß√£o (‚Ç¨)',
                        'Comissao', 'comissao'
                    ], 0),
                    modoPagamento: getValue(serverItem, [
                        'Pagamento', 'Forma Pagamento', 'FormaPagamento', 'Modo Pagamento', 
                        'ModoPagamento', 'Payment'
                    ], 'N√£o informado'),
                    pagoParaQuem: getValue(serverItem, [
                        'Pago Para', 'Pago_Para', 'PagoPara', 'Paid To', 'pago_para'
                    ], 'N√£o informado'),
                    status: getValue(serverItem, ['Status', 'Estado', 'State', 'status'], 'Solicitado'),
                    observacoes: getValue(serverItem, [
                        'Observa√ß√µes', 'Observacoes', 'Obs', 'Notes', 'Comentarios', 'observacoes'
                    ], ''),
                    created: getValue(serverItem, [
                        'Data Cria√ß√£o', 'Data_Criacao', 'DataCriacao', 'Created', 'Timestamp'
                    ], new Date().toISOString())
                };
                
                if (!convertedData.nomeCliente || convertedData.nomeCliente === 'Cliente n√£o informado') {
                    console.warn(`Item ${index}: Cliente n√£o informado ou vazio`);
                }
                
                if (!convertedData.data) {
                    console.warn(`Item ${index}: Data inv√°lida ou vazia`);
                }
                
                if (convertedData.valorTotal > 0) {
                    if (convertedData.valorHotel === 0) {
                        convertedData.valorHotel = convertedData.valorTotal * 0.30;
                    }
                    
                    if (convertedData.comissaoRecepcao === 0) {
                        convertedData.comissaoRecepcao = convertedData.tipoServico.includes('Tour') ? 5.00 : 2.00;
                    }
                    
                    if (convertedData.valorHUB === 0) {
                        convertedData.valorHUB = convertedData.valorTotal - convertedData.valorHotel - convertedData.comissaoRecepcao;
                    }
                }
                
                return convertedData;
                
            } catch (error) {
                console.error('Erro ao converter dados do servidor:', error);
                console.error('Item problem√°tico:', serverItem);
                console.error('Index:', index);
                return null;
            }
        }

        function formatDateFromServer(dateStr) {
            if (!dateStr) return '';
            
            try {
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    return dateStr;
                }
                
                if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                    const [day, month, year] = dateStr.split('/');
                    return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                }
                
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                
                return dateStr;
                
            } catch (error) {
                console.error('Erro ao formatar data do servidor:', dateStr, error);
                return dateStr;
            }
        }

// =====================================================
// SISTEMA DE SINCRONIZA√á√ÉO COM GOOGLE SHEETS - V2.0
// VERS√ÉO FOR√áADA COM LIMPEZA DE CACHE
// =====================================================

/**
 * Sincroniza dados com Google Sheets - VERS√ÉO FOR√áADA
 * Garante que busca dados FRESCOS, n√£o cache
 * Esta fun√ß√£o √© chamada quando o usu√°rio clica em "üîÑ Atualizar Dados"
 */
async function syncWithServer(showLoading = true) {
    console.log('üîÑ Sincroniza√ß√£o FOR√áADA iniciada pelo usu√°rio...');
    console.log('‚è∞ Timestamp da requisi√ß√£o:', new Date().toISOString());
    
    // Verificar se j√° tem sincroniza√ß√£o em andamento
    if (syncInProgress) {
        console.log('‚ö†Ô∏è Sincroniza√ß√£o j√° em andamento, aguarde...');
        showStatus('Sincroniza√ß√£o j√° em andamento, aguarde...', 'warning');
        return false;
    }
    
    // Marcar que sincroniza√ß√£o est√° em progresso
    syncInProgress = true;
    
    // Mostrar indicador visual de loading
    if (showLoading) {
        showSyncLoading(true);
    }
    
    try {
        // üî• PASSO 1: LIMPAR CACHE LOCAL
        console.log('üßπ Limpando cache local antes da sincroniza√ß√£o...');
        console.log(`üìä Estado atual: ${services.length} transfers em mem√≥ria`);
        
        // üî• PASSO 2: BUSCAR DADOS FRESCOS DO SERVIDOR
        console.log('üì° Iniciando busca de dados FRESCOS do Google Sheets...');
        const result = await loadTransfersFromSheets();
        
        // üî• PASSO 3: VERIFICAR RESULTADO
        if (result) {
            console.log(`‚úÖ Sincroniza√ß√£o conclu√≠da com sucesso!`);
            console.log(`üìä Estado ap√≥s sync: ${services.length} transfers carregados`);
            
            // üî• PASSO 4: FOR√áAR RENDERIZA√á√ÉO COMPLETA DA INTERFACE
            console.log('üé® For√ßando re-renderiza√ß√£o completa da tabela...');
            renderTable();
            updateSummary();
            
            // üî• PASSO 5: ATUALIZAR TIMESTAMP DA √öLTIMA SINCRONIZA√á√ÉO
            lastSyncTime = new Date();
            localStorage.setItem('lastSyncTime', lastSyncTime.toISOString());
            
            // Mostrar mensagem de sucesso
            showSyncSuccess(services.length);
            
            return true;
        } else {
            console.error('‚ùå Falha na sincroniza√ß√£o - resultado inv√°lido');
            showSyncError('Falha ao carregar dados do Google Sheets');
            return false;
        }
        
    } catch (error) {
        console.error('‚ùå Erro cr√≠tico na sincroniza√ß√£o:', error);
        console.error('Stack trace:', error.stack);
        showSyncError(error.message || 'Erro desconhecido ao sincronizar');
        return false;
        
    } finally {
        // Sempre limpar o flag de sincroniza√ß√£o em progresso
        syncInProgress = false;
        
        // Remover indicador visual de loading
        if (showLoading) {
            showSyncLoading(false);
        }
        
        console.log('üèÅ Processo de sincroniza√ß√£o finalizado');
    }
}

/**
 * Mostra/esconde indicador visual de loading durante sincroniza√ß√£o
 */
function showSyncLoading(show) {
    const button = document.getElementById('syncBtn');
    
    if (button) {
        if (show) {
            // Estado: Sincronizando
            button.textContent = '‚è≥ Sincronizando...';
            button.disabled = true;
            button.classList.add('loading');
            button.style.opacity = '0.7';
            button.style.cursor = 'not-allowed';
        } else {
            // Estado: Normal
            button.textContent = 'üîÑ Atualizar Dados';
            button.disabled = false;
            button.classList.remove('loading');
            button.style.opacity = '1';
            button.style.cursor = 'pointer';
        }
    }
    
    // Mostrar/esconder indicador adicional se existir
    const indicator = document.getElementById('syncIndicator');
    if (indicator) {
        indicator.style.display = show ? 'block' : 'none';
    }
    
    // Atualizar indicador global de sincroniza√ß√£o
    const globalIndicator = document.querySelector('.sync-indicator');
    if (globalIndicator) {
        globalIndicator.style.display = show ? 'block' : 'none';
        if (show) {
            globalIndicator.textContent = '‚è≥ Sincronizando...';
            globalIndicator.style.background = '#ffc107';
        }
    }
}

/**
 * Mostra mensagem de sucesso ap√≥s sincroniza√ß√£o
 */
function showSyncSuccess(count) {
    console.log(`‚úÖ Sincroniza√ß√£o bem-sucedida: ${count} transfers`);
    
    // Mensagem de status
    showStatus(`‚úÖ ${count} transfers sincronizados com sucesso!`, 'success');
    
    // Atualizar display de √∫ltima sincroniza√ß√£o
    updateLastSyncDisplay();
    
    // Atualizar indicador global
    const globalIndicator = document.querySelector('.sync-indicator');
    if (globalIndicator) {
        globalIndicator.textContent = '‚úÖ Sincronizado';
        globalIndicator.style.background = '#28a745';
        globalIndicator.style.display = 'block';
        
        // Esconder ap√≥s 3 segundos
        setTimeout(() => {
            globalIndicator.style.display = 'none';
        }, 3000);
    }
}

/**
 * Mostra mensagem de erro durante sincroniza√ß√£o
 */
function showSyncError(message) {
    console.error(`‚ùå Erro na sincroniza√ß√£o: ${message}`);
    
    // Mensagem de status
    showStatus(`‚ùå Erro na sincroniza√ß√£o: ${message}`, 'error');
    
    // Atualizar indicador global
    const globalIndicator = document.querySelector('.sync-indicator');
    if (globalIndicator) {
        globalIndicator.textContent = '‚ùå Erro na sincroniza√ß√£o';
        globalIndicator.style.background = '#dc3545';
        globalIndicator.style.display = 'block';
        
        // Esconder ap√≥s 5 segundos
        setTimeout(() => {
            globalIndicator.style.display = 'none';
        }, 5000);
    }
}

/**
 * Atualiza o display mostrando quando foi a √∫ltima sincroniza√ß√£o
 */
function updateLastSyncDisplay() {
    const display = document.getElementById('lastSyncDisplay');
    
    if (display && lastSyncTime) {
        const timeStr = lastSyncTime.toLocaleString('pt-PT', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
        
        display.textContent = `üïê √öltima sincroniza√ß√£o: ${timeStr}`;
        display.style.color = '#28a745';
        display.style.fontWeight = '600';
        
        console.log(`üìÖ √öltima sincroniza√ß√£o atualizada: ${timeStr}`);
    }
}

/**
 * FUN√á√ÉO AUXILIAR: Sincroniza√ß√£o autom√°tica em background
 * Pode ser chamada periodicamente se necess√°rio (mas recomenda-se manual)
 */
function autoSyncBackground() {
    console.log('üîÑ Auto-sincroniza√ß√£o em background...');
    
    // Verificar se j√° passou tempo suficiente desde √∫ltima sync
    if (lastSyncTime) {
        const agora = new Date();
        const diffMinutos = (agora - lastSyncTime) / 1000 / 60;
        
        if (diffMinutos < 5) {
            console.log(`‚è∞ √öltima sync foi h√° ${diffMinutos.toFixed(1)} minutos. Aguardando...`);
            return;
        }
    }
    
    // Executar sincroniza√ß√£o silenciosa (sem loading visual)
    syncWithServer(false);
}

/**
 * FUN√á√ÉO DE DEBUG: For√ßar reset completo
 */
function forcarResetCompleto() {
    console.log('üîÑ FOR√áANDO RESET COMPLETO DO SISTEMA...');
    
    if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nEsta a√ß√£o ir√°:\n\n‚Ä¢ Limpar TODOS os dados locais\n‚Ä¢ For√ßar nova sincroniza√ß√£o\n‚Ä¢ Recarregar a p√°gina\n\nContinuar?')) {
        return;
    }
    
    // Limpar localStorage
    localStorage.removeItem('partnershipTransferData');
    localStorage.removeItem('lastSyncTime');
    
    // Limpar arrays
    services = [];
    serverData = [];
    filteredData = [];
    
    console.log('‚úÖ Cache limpo! Recarregando p√°gina...');
    
    // Recarregar p√°gina
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Expor fun√ß√µes para console (debug)
window.syncWithServer = syncWithServer;
window.forcarResetCompleto = forcarResetCompleto;
window.autoSyncBackground = autoSyncBackground;

console.log('‚úÖ Sistema de sincroniza√ß√£o V2.0 carregado!');
console.log('üí° Fun√ß√µes dispon√≠veis no console:');
console.log('   - syncWithServer() - Sincroniza√ß√£o manual');
console.log('   - forcarResetCompleto() - Reset total do sistema');
console.log('   - autoSyncBackground() - Sync autom√°tica em background');

        // =====================================================
        // ENVIO PARA GOOGLE SHEETS
        // =====================================================
        async function sendToSheets(serviceData) {
            const url = getWebAppUrl();
            
            if (!url) {
                console.log('URL n√£o configurada');
                return false;
            }
            
            if (isConnected) {
                console.log('Tentando enviar para Google Sheets:', serviceData);
                try {
                    const dataWithEmail = {
                        ...serviceData,
                        emailDestino: TEST_EMAIL,
                        action: 'addTransfer'
                    };
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'text/plain',
                        },
                        body: JSON.stringify(dataWithEmail),
                        mode: 'no-cors'
                    });
                    
                    console.log('Transfer enviado para Google Sheets com sucesso!');
                    showStatus('Transfer enviado para Google Sheets e email enviado!', 'success');
                    console.log('Requisi√ß√£o enviada para:', TEST_EMAIL);
                    return true;
                    
                } catch (error) {
                    console.error('Erro ao enviar para Sheets:', error);
                    showStatus('Erro no envio: ' + error.message, 'error');
                    return false;
                }
            } else {
                showStatus('N√£o conectado ao Google Sheets. Transfer salvo apenas localmente.', 'warning');
                return false;
            }
        }

        // =====================================================
        // GERENCIAMENTO DE DADOS LOCAL
        // =====================================================
        function loadData() {
            const savedData = localStorage.getItem('partnershipTransferData');
            const savedUrl = localStorage.getItem('webappUrl');
            
            if (savedData) {
                try {
                    services = JSON.parse(savedData);
                    console.log(`${services.length} transfers carregados do localStorage`);
                    renderTable();
                    updateSummary();
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    services = [];
                }
            }
            
            if (savedUrl) {
                document.getElementById('webappUrl').value = savedUrl;
                document.getElementById('syncBtn').style.display = 'inline-block';
                isConnected = true;
            } else {
                document.getElementById('webappUrl').value = WEBAPP_URL;
                localStorage.setItem('webappUrl', WEBAPP_URL);
                document.getElementById('syncBtn').style.display = 'inline-block';
                isConnected = true;
            }
            
            const lastSync = localStorage.getItem('lastSyncTime');
            if (lastSync) {
                lastSyncTime = new Date(lastSync);
                updateLastSyncDisplay();
            }
        }

        function saveData() {
            try {
                localStorage.setItem('partnershipTransferData', JSON.stringify(services));
                console.log('Dados salvos no localStorage');
            } catch (error) {
                console.error('Erro ao salvar dados:', error);
                showStatus('Erro ao salvar dados localmente', 'error');
            }
        }

        // =====================================================
        // SISTEMA DE LIMPEZA DE DADOS
        // =====================================================
        async function clearAllData() {
            const confirmText = prompt('ATEN√á√ÉO: Esta a√ß√£o ir√° apagar TODOS os dados!\n\nDigite "CONFIRMAR" para continuar:');
            
            if (confirmText !== 'CONFIRMAR') {
                showStatus('Opera√ß√£o cancelada pelo usu√°rio.', 'warning');
                return;
            }

            setButtonLoading('clearDataBtn', true);
            
            try {
                const url = getWebAppUrl();
                if (url) {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'clearAllData',
                            timestamp: new Date().toISOString()
                        }),
                        mode: 'cors'
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        showStatus('Dados limpos no Google Sheets com sucesso!', 'success');
                    } else {
                        showStatus('Erro ao limpar dados no Google Sheets: ' + result.message, 'warning');
                    }
                } else {
                    showStatus('URL n√£o configurada - apenas dados locais ser√£o limpos', 'warning');
                }
                
                services = [];
                localStorage.removeItem('partnershipTransferData');
                renderTable();
                updateSummary();
                
                showStatus('Todos os dados foram limpos com sucesso!', 'success');
                
                setTimeout(() => {
                    toggleClearData();
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao limpar dados:', error);
                
                services = [];
                localStorage.removeItem('partnershipTransferData');
                renderTable();
                updateSummary();
                
                showStatus('Dados locais limpos. Erro ao conectar com Google Sheets.', 'warning');
            } finally {
                setButtonLoading('clearDataBtn', false);
            }
        }

        async function clearTestData() {
            const confirmText = prompt('Limpar apenas registros de teste?\n\nDigite "TESTE" para confirmar:');
            
            if (confirmText !== 'TESTE') {
                showStatus('Opera√ß√£o cancelada pelo usu√°rio.', 'warning');
                return;
            }

            setButtonLoading('clearTestBtn', true);
            
            try {
                const url = getWebAppUrl();
                
                if (url) {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'clearTestData',
                            timestamp: new Date().toISOString()
                        }),
                        mode: 'cors'
                    });
                    
                    const result = await response.json();
                    if (result.status === 'success') {
                        showStatus('Dados de teste limpos no Google Sheets!', 'success');
                    } else {
                        showStatus('Erro ao limpar dados de teste no Google Sheets: ' + result.message, 'warning');
                    }
                }
                
                const originalLength = services.length;
                services = services.filter(service => 
                    !service.nomeCliente.toUpperCase().includes('TESTE') &&
                    !service.nomeCliente.toUpperCase().includes('TEST')
                );
                
                const removedCount = originalLength - services.length;
                
                if (removedCount > 0) {
                    saveData();
                    renderTable();
                    updateSummary();
                    showStatus(`${removedCount} registros de teste removidos!`, 'success');
                } else {
                    showStatus('Nenhum registro de teste encontrado.', 'warning');
                }
                
                setTimeout(() => {
                    toggleClearData();
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao limpar dados de teste:', error);
                showStatus('Erro ao limpar dados de teste: ' + error.message, 'error');
            } finally {
                setButtonLoading('clearTestBtn', false);
            }
        }

        // =====================================================
        // FUN√á√ïES DE SERVI√áO E C√ÅLCULO
        // =====================================================
        function setServiceType(type) {
            currentServiceType = type;
            
            document.querySelectorAll('.btn-service').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const tourSelector = document.getElementById('tourSelector');
            if (type === 'tour' || type === 'private') {
                tourSelector.classList.add('show');
            } else {
                tourSelector.classList.remove('show');
                document.getElementById('tourSelecionado').value = '';
            }
            
            updateCalculation();
        }

        function updateTourPrice() {
            const tourSelect = document.getElementById('tourSelecionado');
            const selectedOption = tourSelect.options[tourSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                precoUnitarioAtual = 0;
                updateCalculation();
                return;
            }
            
            const tourData = TOURS_DATA[selectedOption.value];
            const pessoas = parseInt(document.getElementById('numeroPessoas').value) || 1;
            
            if (tourData.type === 'regular') {
                precoUnitarioAtual = tourData.price;
                const valorTotal = precoUnitarioAtual * pessoas;
                document.getElementById('valorTotal').value = valorTotal.toFixed(2);
            } else if (tourData.type === 'private') {
                precoUnitarioAtual = pessoas <= 3 ? tourData.priceSmall : tourData.priceLarge;
                document.getElementById('valorTotal').value = precoUnitarioAtual.toFixed(2);
            }
            
            updateCalculation();
        }

        function updateCalculation() {
            const pessoas = parseInt(document.getElementById('numeroPessoas').value) || 0;
            let valorTotal = 0;
            let valorHotel = 0;
            let valorHUB = 0;
            let comissaoRecepcao = 0;
            
            const calcBox = document.getElementById('priceCalculationBox');
            if (currentServiceType === 'tour' || currentServiceType === 'private') {
                calcBox.classList.add('show');
                
                document.getElementById('calcTipoServico').textContent = 
                    currentServiceType === 'tour' ? 'Tour Regular' : 'Private Tour';
                document.getElementById('calcPrecoUnitario').textContent = `‚Ç¨${precoUnitarioAtual}`;
                document.getElementById('calcPessoas').textContent = pessoas;
                
                if (currentServiceType === 'tour') {
                    valorTotal = precoUnitarioAtual * pessoas;
                    valorHotel = valorTotal * 0.30;
                    comissaoRecepcao = 5.00;
                } else if (currentServiceType === 'private') {
                    valorTotal = precoUnitarioAtual;
                    valorHotel = valorTotal * 0.30;
                    comissaoRecepcao = 5.00;
                }
            } else {
                calcBox.classList.remove('show');
                valorTotal = parseFloat(document.getElementById('valorTotal').value) || 0;
                valorHotel = valorTotal * 0.30;
                comissaoRecepcao = 2.00;
            }
            
            valorHUB = valorTotal - valorHotel - comissaoRecepcao;
            
            document.getElementById('calcTotal').textContent = valorTotal.toFixed(2);
            document.getElementById('calcHotel').textContent = `‚Ç¨${valorHotel.toFixed(2)}`;
            document.getElementById('calcHUB').textContent = `‚Ç¨${valorHUB.toFixed(2)}`;
            document.getElementById('calcRecepcao').textContent = `‚Ç¨${comissaoRecepcao.toFixed(2)}`;
            
            if (currentServiceType !== 'transfer') {
                document.getElementById('valorTotal').value = valorTotal.toFixed(2);
            }
        }

        function toggleAdminMode() {
            const senha = prompt('Digite a senha de administrador:');
            if (senha === 'admin2025') {
                isAdminMode = !isAdminMode;
                
                document.getElementById('adminFields').classList.toggle('show');
                
                document.querySelectorAll('.admin-column').forEach(col => {
                    col.style.display = isAdminMode ? 'table-cell' : 'none';
                });
                
                alert(isAdminMode ? 'Modo Admin Ativado' : 'Modo Admin Desativado');
            } else if (senha !== null) {
                alert('Senha incorreta!');
            }
        }

        // =====================================================
        // FUN√á√ïES DOS BOT√ïES R√ÅPIDOS
        // =====================================================
        function setPeople(number) {
            document.getElementById('numeroPessoas').value = number;
            document.querySelectorAll('.btn-people').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateCalculation();
            updatePriceFromTour();
        }

        function updatePriceFromTour() {
            const tourSelect = document.getElementById('tourSelecionado');
            const selectedOption = tourSelect.options[tourSelect.selectedIndex];
            const pessoas = parseInt(document.getElementById('numeroPessoas').value) || 0;
            
            if (currentServiceType === 'tour' && selectedOption && selectedOption.value) {
                const tourData = TOURS_DATA[selectedOption.value];
                if (tourData && tourData.type === 'regular' && pessoas > 0) {
                    const valorTotal = tourData.price * pessoas;
                    document.getElementById('valorTotal').value = valorTotal.toFixed(2);
                    document.querySelectorAll('.btn-price').forEach(btn => btn.classList.remove('active'));
                }
            } else if (currentServiceType === 'private' && selectedOption && selectedOption.value) {
                const tourData = TOURS_DATA[selectedOption.value];
                if (tourData && tourData.type === 'private' && pessoas > 0) {
                    const valorTotal = pessoas <= 3 ? tourData.priceSmall : tourData.priceLarge;
                    document.getElementById('valorTotal').value = valorTotal.toFixed(2);
                    document.querySelectorAll('.btn-price').forEach(btn => btn.classList.remove('active'));
                }
            }
        }

        function setBaggage(number) {
            document.getElementById('numeroBagagens').value = number;
            document.querySelectorAll('.btn-baggage').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setDate(option) {
            const dateInput = document.getElementById('data');
            const today = new Date();
            
            document.querySelectorAll('.btn-date').forEach(btn => btn.classList.remove('active'));
            
            if (option === 'today') {
                dateInput.valueAsDate = today;
                event.target.classList.add('active');
            } else if (option === 'tomorrow') {
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                dateInput.valueAsDate = tomorrow;
                event.target.classList.add('active');
            }
        }

        function setTime(time) {
            document.getElementById('horaPickup').value = time;
            document.querySelectorAll('.btn-time').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setOrigin(location) {
            document.getElementById('origem').value = location;
            document.querySelectorAll('.origem-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setDestination(location) {
            document.getElementById('destino').value = location;
            document.querySelectorAll('.destino-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setPrice(price) {
            document.getElementById('valorTotal').value = price;
            document.querySelectorAll('.btn-price').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateCalculation();
        }

        function setPayment(method) {
            document.getElementById('modoPagamento').value = method;
            document.querySelectorAll('.btn-payment').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function setPaymentTo(recipient) {
            document.getElementById('pagoParaQuem').value = recipient;
            document.querySelectorAll('.btn-payment-to').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function addObservation(text) {
            const obsInput = document.getElementById('observacoes');
            const currentText = obsInput.value;
            
            if (currentText === '') {
                obsInput.value = text;
            } else {
                obsInput.value = currentText + '; ' + text;
            }
            
            event.target.classList.add('active');
            setTimeout(() => {
                event.target.classList.remove('active');
            }, 1000);
        }

// =====================================================
        // FUN√á√ïES DO TELEFONE INTERNACIONAL
        // =====================================================
        function initializePhoneInput() {
            const phoneInputElement = document.getElementById('contacto');
            
            if (window.intlTelInput && phoneInputElement) {
                try {
                    phoneInput = window.intlTelInput(phoneInputElement, {
                        initialCountry: "pt",
                        preferredCountries: ["pt", "es", "fr", "de", "br", "us", "gb"],
                        separateDialCode: true,
                        autoHideDialCode: false,
                        nationalMode: false,
                        formatOnDisplay: true,
                        utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"
                    });

                    phoneInputElement.addEventListener('input', function() {
                        const number = phoneInputElement.value;
                        if (number.startsWith('+')) {
                            const countryCode = detectCountryFromNumber(number);
                            if (countryCode) {
                                phoneInput.setCountry(countryCode);
                            }
                        }
                    });

                    phoneInputElement.addEventListener('blur', function() {
                        try {
                            if (phoneInput.isValidNumber()) {
                                phoneInputElement.value = phoneInput.getNumber();
                            }
                        } catch (e) {
                            console.warn('Erro na valida√ß√£o do telefone:', e);
                        }
                    });
                    
                    console.log('Campo de telefone internacional inicializado');
                } catch (error) {
                    console.warn('Erro ao inicializar telefone internacional:', error);
                    console.log('Usando campo de telefone simples');
                }
            } else {
                console.log('Biblioteca de telefone n√£o dispon√≠vel - usando input simples');
            }
        }

        function detectCountryFromNumber(number) {
            const countryCodesMap = {
                '+351': 'pt', '+34': 'es', '+33': 'fr', '+49': 'de', '+55': 'br',
                '+1': 'us', '+44': 'gb', '+39': 'it', '+31': 'nl', '+32': 'be',
                '+41': 'ch', '+43': 'at', '+45': 'dk', '+46': 'se', '+47': 'no'
            };

            for (let i = 4; i >= 2; i--) {
                const code = number.substring(0, i);
                if (countryCodesMap[code]) {
                    return countryCodesMap[code];
                }
            }
            return null;
        }

        function getFormattedPhoneNumber() {
            if (phoneInput && phoneInput.isValidNumber()) {
                return phoneInput.getNumber();
            }
            return document.getElementById('contacto').value;
        }

        // =====================================================
        // RENDERIZA√á√ÉO DA TABELA PRINCIPAL
        // =====================================================
        function renderTable() {
            const tbody = document.getElementById('servicesTableBody');
            tbody.innerHTML = '';

            if (services.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="19" class="empty-state">
                            <h3>üì≠ Nenhum servi√ßo cadastrado</h3>
                            <p>Use o bot√£o "üì• Carregar Transfers" para sincronizar com o Google Sheets</p>
                        </td>
                    </tr>
                `;
                updateScrollIndicator();
                return;
            }

            const paginatedServices = getPaginatedServices();

            paginatedServices.forEach(service => {
                const row = document.createElement('tr');
                
                let rowBackgroundClass = '';
                if (service.tipoServico && (service.tipoServico.includes('Tour') || service.tipoServico === 'tour')) {
                    rowBackgroundClass = 'tour-row';
                } else if (service.origem && service.origem.toLowerCase().includes('aeroporto') && 
           service.destino && service.destino.toLowerCase().includes('hotel')) {
                    rowBackgroundClass = 'airport-to-hotel-row';
                }
                
                if (rowBackgroundClass) {
                    row.classList.add(rowBackgroundClass);
                }
                
                const modoPagamento = service.modoPagamento || 'N√£o informado';
                const paymentClass = modoPagamento.toLowerCase().includes('dinheiro') ? 'payment-cash' :
                                    modoPagamento.toLowerCase().includes('cart√£o') ? 'payment-card' : 'payment-transfer';
                
                const tipoServico = service.tipoServico || 'Transfer';
                const tipoLabel = tipoServico === 'Tour Regular' || tipoServico === 'tour' ? 'üåü Tour' : 
                                 tipoServico === 'Private Tour' || tipoServico === 'private' ? 'üëë Private' : 
                                 'üöó Transfer';
                
                const phoneLink = createWhatsAppLink(service.contacto);
                const flightLink = createFlightLink(service.numeroVoo);
                
                const peopleDisplay = `${getPeopleEmoji(service.numeroPessoas)} ${service.numeroPessoas}`;
                const baggageDisplay = `${getBaggageEmoji(service.numeroBagagens)} ${service.numeroBagagens}`;
                const timeDisplay = `${getTimeEmoji(service.horaPickup)} ${service.horaPickup}`;
                
                const origemEmoji = getLocationEmoji(service.origem);
                const destinoEmoji = getLocationEmoji(service.destino);
                
                const paymentEmoji = modoPagamento.toLowerCase().includes('dinheiro') ? 'üíµ' :
                                    modoPagamento.toLowerCase().includes('cart√£o') ? 'üí≥' : 'üè¶';
                
                const statusEmoji = service.status === 'Solicitado' ? '‚è≥' :
                                   service.status === 'Confirmado' ? '‚úÖ' :
                                   service.status === 'Finalizado' ? 'üèÅ' : '‚ùå';
                
                const referenciaDisplay = service.referencia && typeof service.referencia === 'string' && service.referencia.trim() !== '' ? 
    `<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${service.referencia.trim()}</span>` : 
    '<span style="color: #adb5bd; font-size: 0.75rem;">N/A</span>';
row.innerHTML = `
    <td><strong>#${service.id}</strong></td>
    <td>
        <div style="text-align: center;">${referenciaDisplay}</div>
    </td>
    <td>
        <div class="client-info">${service.nomeCliente}</div>
        <div style="font-size: 0.8rem; color: #7f8c8d;">${phoneLink}</div>
    </td>
                    <td>${tipoLabel}</td>
                    <td>
                        <span style="background: #9b59b6; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                            ${peopleDisplay}
                        </span>
                    </td>
                    <td>
                        <span style="background: #e67e22; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                            ${baggageDisplay}
                        </span>
                    </td>
                    <td><strong>üìÖ ${formatDate(service.data)}</strong></td>
                    <td>
                        <div style="font-weight: 600; color: #2c3e50; font-size: 1.1rem; display: flex; align-items: center; gap: 4px;">
                            ${timeDisplay}
                        </div>
                    </td>
                    <td>${phoneLink}</td>
                    <td>${flightLink}</td>
                    <td>
                        <div style="font-size: 0.9rem;">
                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
                                <strong>De:</strong> ${origemEmoji} ${service.origem}
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <strong>Para:</strong> ${destinoEmoji} ${service.destino}
                            </div>
                        </div>
                    </td>
                    <td><span class="value-highlight">üí∞ ‚Ç¨${service.valorTotal.toFixed(2)}</span></td>
                    <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                        ‚Ç¨${(service.valorHotel || 0).toFixed(2)}
                    </td>
                    <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                        ‚Ç¨${(service.valorHUB || 0).toFixed(2)}
                    </td>
                    <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                        ‚Ç¨${(service.comissaoRecepcao || 0).toFixed(2)}
                    </td>
                    <td>
                        <span class="payment-method ${paymentClass}" style="display: inline-flex; align-items: center; gap: 4px;">
                            ${paymentEmoji} ${service.modoPagamento}
                        </span>
                    </td>
                    <td>
                        <span class="pago-para ${service.pagoParaQuem === 'Recep√ß√£o' ? 'pago-recepcao' : 'pago-motorista'}" style="display: inline-flex; align-items: center; gap: 4px;">
                            ${service.pagoParaQuem === 'Recep√ß√£o' ? 'üë®‚Äçüíº' : 'üöó'} ${service.pagoParaQuem}
                        </span>
                    </td>
                    <td>
                        <span class="status status-${service.status.toLowerCase()}" style="display: inline-flex; align-items: center; gap: 4px;" onclick="changeStatus(${service.id})" title="Clique para alterar status">
                            ${statusEmoji} ${service.status}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-small btn-primary" onclick="editService(${service.id})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-success" onclick="changeStatus(${service.id})" title="Alterar Status">üîÑ</button>
                            <button class="btn btn-small btn-export" onclick="deleteService(${service.id})" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
            updateScrollIndicator();
        }

        function updateSummary() {
            const total = services.length;
            const pending = services.filter(s => s.status === 'Solicitado').length;
            const confirmed = services.filter(s => s.status === 'Confirmado').length;
            const completed = services.filter(s => s.status === 'Finalizado').length;

            const totalRevenue = services.reduce((sum, s) => sum + (s.valorTotal || 0), 0);
            const pendingRevenue = services.filter(s => s.status === 'Solicitado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);
            const confirmedRevenue = services.filter(s => s.status === 'Confirmado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);
            const completedRevenue = services.filter(s => s.status === 'Finalizado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);

            document.getElementById('totalServices').textContent = total;
            document.getElementById('pendingServices').textContent = pending;
            document.getElementById('confirmedServices').textContent = confirmed;
            document.getElementById('completedServices').textContent = completed;

            document.getElementById('totalRevenue').textContent = `‚Ç¨${totalRevenue.toFixed(2)}`;
            document.getElementById('pendingRevenue').textContent = `‚Ç¨${pendingRevenue.toFixed(2)}`;
            document.getElementById('confirmedRevenue').textContent = `‚Ç¨${confirmedRevenue.toFixed(2)}`;
            document.getElementById('completedRevenue').textContent = `‚Ç¨${completedRevenue.toFixed(2)}`;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-PT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function updateScrollIndicator() {
            const tableContainer = document.getElementById('tableContainer');
            const scrollIndicator = document.getElementById('scrollIndicator');
            
            if (!tableContainer || !scrollIndicator) return;
            
            const hasHorizontalScroll = tableContainer.scrollWidth > tableContainer.clientWidth;
            
            if (hasHorizontalScroll) {
                scrollIndicator.style.display = 'flex';
                
                tableContainer.addEventListener('scroll', function() {
                    const scrollLeft = tableContainer.scrollLeft;
                    const maxScroll = tableContainer.scrollWidth - tableContainer.clientWidth;
                    
                    if (scrollLeft >= maxScroll - 20) {
                        scrollIndicator.style.opacity = '0';
                    } else {
                        scrollIndicator.style.opacity = '1';
                    }
                });
            } else {
                scrollIndicator.style.display = 'none';
            }
        }

        function scrollTableLeft() {
            const tableContainer = document.getElementById('tableContainer');
            if (tableContainer) {
                tableContainer.scrollBy({
                    left: -200,
                    behavior: 'smooth'
                });
            }
        }

        function scrollTableRight() {
            const tableContainer = document.getElementById('tableContainer');
            if (tableContainer) {
                tableContainer.scrollBy({
                    left: 200,
                    behavior: 'smooth'
                });
            }
        }

        // =====================================================
        // SISTEMA DE FILTROS AVAN√áADOS
        // =====================================================
        function applyQuickPeriod() {
            const select = document.getElementById('quickPeriodSelect');
            const period = select.value;
            
            if (!period) return;
            
            const today = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'today':
                    startDate = endDate = today;
                    break;
                    
                case 'yesterday':
                    startDate = endDate = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    break;
                    
                case 'thisWeek':
                    const dayOfWeek = today.getDay();
                    const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    startDate = new Date(today.setDate(diff));
                    endDate = new Date();
                    break;
                    
                case 'lastWeek':
                    const lastWeekStart = new Date();
                    lastWeekStart.setDate(today.getDate() - today.getDay() - 6);
                    const lastWeekEnd = new Date();
                    lastWeekEnd.setDate(today.getDate() - today.getDay());
                    startDate = lastWeekStart;
                    endDate = lastWeekEnd;
                    break;
                    
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date();
                    break;
                    
                case 'lastMonth':
                    const lastMonth = new Date();
                    lastMonth.setMonth(today.getMonth() - 1);
                    startDate = new Date(lastMonth.getFullYear(), lastMonth.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                    break;
                    
                case 'last7days':
                    startDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    endDate = new Date();
                    break;
                    
                case 'last30days':
                    startDate = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    endDate = new Date();
                    break;
            }
            
            if (startDate && endDate) {
                document.getElementById('filterDateStart').value = formatDateForInput(startDate);
                document.getElementById('filterDateEnd').value = formatDateForInput(endDate);
                updateDateFilter();
            }
        }

        function updateDateFilter() {
            const startDate = document.getElementById('filterDateStart').value;
            const endDate = document.getElementById('filterDateEnd').value;
            
            activeFilters.dateStart = startDate;
            activeFilters.dateEnd = endDate;
            
            const quickSelect = document.getElementById('quickPeriodSelect');
            if (quickSelect && (startDate || endDate)) {
                quickSelect.value = '';
            }
            
            saveFilters();
            applyCurrentFilters();
        }

        function updateStatusFilter() {
            const statusFilter = document.getElementById('filterStatus');
            activeFilters.status = statusFilter ? statusFilter.value : '';
            
            saveFilters();
            applyCurrentFilters();
        }

        function updateClientFilter() {
            const clientFilter = document.getElementById('searchClient');
            activeFilters.cliente = clientFilter ? clientFilter.value : '';
            
            saveFilters();
            applyCurrentFilters();
        }

        function updateServiceTypeFilter() {
            const typeFilter = document.getElementById('filterTipoServico');
            activeFilters.tipoServico = typeFilter ? typeFilter.value : '';
            
            saveFilters();
            applyCurrentFilters();
        }

        function applyAllFilters() {
            console.log('Aplicando todos os filtros:', activeFilters);
            applyCurrentFilters();
        }

        function applyCurrentFilters() {
            if (isFiltering) return;
            
            isFiltering = true;
            
            try {
                let filtered = [...services];
                
                if (activeFilters.dateStart || activeFilters.dateEnd) {
                    filtered = filtered.filter(service => {
                        const serviceDate = parseServiceDate(service.data);
                        if (!serviceDate) return true;
                        
                        let include = true;
                        
                        if (activeFilters.dateStart) {
                            const startDate = new Date(activeFilters.dateStart);
                            include = include && serviceDate >= startDate;
                        }
                        
                        if (activeFilters.dateEnd) {
                            const endDate = new Date(activeFilters.dateEnd);
                            endDate.setHours(23, 59, 59, 999);
                            include = include && serviceDate <= endDate;
                        }
                        
                        return include;
                    });
                }
                
                if (activeFilters.status) {
                    filtered = filtered.filter(service => 
                        service.status === activeFilters.status
                    );
                }
                
                if (activeFilters.cliente) {
                    const searchTerm = activeFilters.cliente.toLowerCase();
                    filtered = filtered.filter(service =>
                        service.nomeCliente.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (activeFilters.tipoServico) {
                    filtered = filtered.filter(service =>
                        service.tipoServico === activeFilters.tipoServico
                    );
                }
                
                filteredData = filtered;
                renderFilteredTable(filtered);
                updateFilteredSummary(filtered);
                
                console.log(`Filtros aplicados: ${filtered.length} de ${services.length} transfers`);
                
            } finally {
                isFiltering = false;
            }
        }

        function renderFilteredTable(filteredServices) {
            const sortedServices = filteredServices.sort((a, b) => b.id - a.id);
            
            const tbody = document.getElementById('servicesTableBody');
            tbody.innerHTML = '';

            if (sortedServices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="19" class="empty-state">
                            <h3>üîç Nenhum transfer encontrado</h3>
                            <p>Tente ajustar os filtros ou carregar dados do Google Sheets</p>
                            <button class="btn btn-primary" onclick="clearAllFilters()">üóëÔ∏è Limpar Filtros</button>
                        </td>
                    </tr>
                `;
                updateScrollIndicator();
                return;
            }

            sortedServices.forEach(service => {
                const row = document.createElement('tr');
                
                const modoPagamento = service.modoPagamento || 'N√£o informado';
                const paymentClass = modoPagamento.toLowerCase().includes('dinheiro') ? 'payment-cash' :
                                    modoPagamento.toLowerCase().includes('cart√£o') ? 'payment-card' : 'payment-transfer';
                
                const tipoServico = service.tipoServico || 'Transfer';
                const tipoLabel = tipoServico === 'Tour Regular' || tipoServico === 'tour' ? 'üåü Tour' : 
                                 tipoServico === 'Private Tour' || tipoServico === 'private' ? 'üëë Private' : 
                                 'üöó Transfer';
                
                const dataFormatada = service.data ? (service.data.includes('/') ? service.data : formatDate(service.data)) : 'Data n√£o informada';
                
                const phoneLink = createWhatsAppLink(service.contacto);
                const flightLink = createFlightLink(service.numeroVoo);
                
                const peopleDisplay = `${getPeopleEmoji(service.numeroPessoas || 0)} ${service.numeroPessoas || 0}`;
                const baggageDisplay = `${getBaggageEmoji(service.numeroBagagens || 0)} ${service.numeroBagagens || 0}`;
                const timeDisplay = `${getTimeEmoji(service.horaPickup)} ${service.horaPickup || 'Hora n√£o informada'}`;
                
                const origemEmoji = getLocationEmoji(service.origem);
                const destinoEmoji = getLocationEmoji(service.destino);
                
                const paymentEmoji = modoPagamento.toLowerCase().includes('dinheiro') ? 'üíµ' :
                                    modoPagamento.toLowerCase().includes('cart√£o') ? 'üí≥' : 'üè¶';
                
                const statusEmoji = service.status === 'Solicitado' ? '‚è≥' :
                                   service.status === 'Confirmado' ? '‚úÖ' :
                                   service.status === 'Finalizado' ? 'üèÅ' : '‚ùå';
                
                const referenciaDisplay = (service.referencia && typeof service.referencia === 'string' && service.referencia.trim() !== '') ? 
    `<span style="background: #6c757d; color: white; padding: 2px 6px; border-radius: 8px; font-size: 0.75rem; font-weight: 600;">${service.referencia.trim()}</span>` : 
    '<span style="color: #adb5bd; font-size: 0.75rem;">N/A</span>';

row.innerHTML = `
    <td><strong>#${service.id || 'N/A'}</strong></td>
    <td>
        <div style="text-align: center;">${referenciaDisplay}</div>
    </td>
    <td>
        <div class="client-info">${service.nomeCliente || 'Cliente n√£o informado'}</div>
        <div style="font-size: 0.8rem; color: #7f8c8d;">${phoneLink}</div>
    </td>
                    <td>${tipoLabel}</td>
                    <td>
                        <span style="background: #9b59b6; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                            ${peopleDisplay}
                        </span>
                    </td>
                    <td>
                        <span style="background: #e67e22; color: white; padding: 4px 8px; border-radius: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 4px;">
                            ${baggageDisplay}
                        </span>
                    </td>
                    <td><strong>üìÖ ${dataFormatada}</strong></td>
                    <td>
                        <div style="font-weight: 600; color: #2c3e50; font-size: 1.1rem; display: flex; align-items: center; gap: 4px;">
                            ${timeDisplay}
                        </div>
                    </td>
                    <td>${phoneLink}</td>
                    <td>${flightLink}</td>
                    <td>
                        <div style="font-size: 0.9rem;">
                            <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 2px;">
                                <strong>De:</strong> ${origemEmoji} ${service.origem || 'Origem n√£o informada'}
                            </div>
                            <div style="display: flex; align-items: center; gap: 4px;">
                                <strong>Para:</strong> ${destinoEmoji} ${service.destino || 'Destino n√£o informado'}
                            </div>
                        </div>
                    </td>
                    <td><span class="value-highlight">üí∞ ‚Ç¨${(service.valorTotal || 0).toFixed(2)}</span></td>
                    <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                        ‚Ç¨${(service.valorHotel || 0).toFixed(2)}
                    </td>
                    <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                        ‚Ç¨${(service.valorHUB || 0).toFixed(2)}
                    </td>
                    <td class="admin-column" style="display: ${isAdminMode ? 'table-cell' : 'none'};">
                        ‚Ç¨${(service.comissaoRecepcao || 0).toFixed(2)}
                    </td>
                    <td>
                        <span class="payment-method ${paymentClass}" style="display: inline-flex; align-items: center; gap: 4px;">
                            ${paymentEmoji} ${modoPagamento}
                        </span>
                    </td>
                    <td>
                        <span class="pago-para ${service.pagoParaQuem === 'Recep√ß√£o' ? 'pago-recepcao' : 'pago-motorista'}" style="display: inline-flex; align-items: center; gap: 4px;">
                            ${service.pagoParaQuem === 'Recep√ß√£o' ? 'üë®‚Äçüíº' : 'üöó'} ${service.pagoParaQuem || 'N√£o informado'}
                        </span>
                    </td>
                    <td>
                        <span class="status status-${(service.status || 'solicitado').toLowerCase()}" style="display: inline-flex; align-items: center; gap: 4px;" onclick="changeStatus(${service.id})" title="Clique para alterar status">
                            ${statusEmoji} ${service.status || 'Solicitado'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-small btn-primary" onclick="editService(${service.id})" title="Editar">‚úèÔ∏è</button>
                            <button class="btn btn-small btn-success" onclick="changeStatus(${service.id})" title="Alterar Status">üîÑ</button>
                            <button class="btn btn-small btn-export" onclick="deleteService(${service.id})" title="Excluir">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateScrollIndicator();
        }

        function updateFilteredSummary(filteredServices) {
            const total = filteredServices.length;
            const pending = filteredServices.filter(s => s.status === 'Solicitado').length;
            const confirmed = filteredServices.filter(s => s.status === 'Confirmado').length;
            const completed = filteredServices.filter(s => s.status === 'Finalizado').length;

            const totalRevenue = filteredServices.reduce((sum, s) => sum + (s.valorTotal || 0), 0);
            const pendingRevenue = filteredServices.filter(s => s.status === 'Solicitado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);
            const confirmedRevenue = filteredServices.filter(s => s.status === 'Confirmado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);
            const completedRevenue = filteredServices.filter(s => s.status === 'Finalizado').reduce((sum, s) => sum + (s.valorTotal || 0), 0);

            document.getElementById('totalServices').textContent = total;
            document.getElementById('pendingServices').textContent = pending;
            document.getElementById('confirmedServices').textContent = confirmed;
            document.getElementById('completedServices').textContent = completed;

            document.getElementById('totalRevenue').textContent = `‚Ç¨${totalRevenue.toFixed(2)}`;
            document.getElementById('pendingRevenue').textContent = `‚Ç¨${pendingRevenue.toFixed(2)}`;
            document.getElementById('confirmedRevenue').textContent = `‚Ç¨${confirmedRevenue.toFixed(2)}`;
            document.getElementById('completedRevenue').textContent = `‚Ç¨${completedRevenue.toFixed(2)}`;
            
            updateFilterIndicator(total, services.length);
        }

        function updateFilterIndicator(filteredCount, totalCount) {
            let indicator = document.getElementById('filterIndicator');
            
            if (filteredCount < totalCount) {
                indicator.textContent = `Mostrando ${filteredCount} de ${totalCount} transfers (filtros ativos)`;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        function clearAllFilters() {
            document.getElementById('filterDateStart').value = '';
            document.getElementById('filterDateEnd').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('searchClient').value = '';
            document.getElementById('filterTipoServico').value = '';
            document.getElementById('quickPeriodSelect').value = '';
            
            activeFilters = {
                dateStart: null,
                dateEnd: null,
                status: '',
                cliente: '',
                quickPeriod: '',
                tipoServico: ''
            };
            saveFilters();
            renderTable();
            updateSummary();
            
            console.log('Todos os filtros foram limpos');
        }

function parseServiceDate(dateStr) {
            if (!dateStr) return null;
            
            try {
                if (dateStr.includes('/')) {
                    const [day, month, year] = dateStr.split('/');
                    return new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                } else if (dateStr.includes('-')) {
                    return new Date(dateStr);
                } else {
                    return new Date(dateStr);
                }
            } catch (error) {
                console.error('Erro ao processar data:', dateStr, error);
                return null;
            }
        }

        function formatDateForInput(date) {
            if (!(date instanceof Date)) return '';
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        function saveFilters() {
            try {
                localStorage.setItem('activeFilters', JSON.stringify(activeFilters));
            } catch (error) {
                console.error('Erro ao salvar filtros:', error);
            }
        }

        function loadSavedFilters() {
            try {
                const savedFilters = localStorage.getItem('activeFilters');
                if (savedFilters) {
                    activeFilters = { ...activeFilters, ...JSON.parse(savedFilters) };
                    
                    if (activeFilters.dateStart) {
                        const startField = document.getElementById('filterDateStart');
                        if (startField) startField.value = activeFilters.dateStart;
                    }
                    
                    if (activeFilters.dateEnd) {
                        const endField = document.getElementById('filterDateEnd');
                        if (endField) endField.value = activeFilters.dateEnd;
                    }
                    
                    if (activeFilters.status) {
                        const statusField = document.getElementById('filterStatus');
                        if (statusField) statusField.value = activeFilters.status;
                    }
                    
                    if (activeFilters.cliente) {
                        const clientField = document.getElementById('searchClient');
                        if (clientField) clientField.value = activeFilters.cliente;
                    }
                    
                    if (activeFilters.tipoServico) {
                        const typeField = document.getElementById('filterTipoServico');
                        if (typeField) typeField.value = activeFilters.tipoServico;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar filtros salvos:', error);
            }
        }

        // =====================================================
        // SUBMISS√ÉO E VALIDA√á√ÉO DO FORMUL√ÅRIO
        // =====================================================
        document.getElementById('transferForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!validateForm()) {
                return;
            }

            setButtonLoading('submitBtn', true);

            const pessoas = parseInt(document.getElementById('numeroPessoas').value);
            let valorTotal = parseFloat(document.getElementById('valorTotal').value);
            let valorHotel, valorHUB, comissaoRecepcao;
            
            if (currentServiceType === 'tour' || currentServiceType === 'private') {
                valorHotel = valorTotal * 0.30;
                comissaoRecepcao = 5.00;
            } else {
                valorHotel = valorTotal * 0.30;
                comissaoRecepcao = 2.00;
            }
            
            valorHUB = valorTotal - valorHotel - comissaoRecepcao;

            const formData = {
    nomeCliente: document.getElementById('nomeCliente').value.trim(),
    referencia: document.getElementById('referencia').value.trim(),
    tipoServico: currentServiceType,
    tourSelecionado: document.getElementById('tourSelecionado').value,
    numeroPessoas: pessoas,
    numeroBagagens: parseInt(document.getElementById('numeroBagagens').value),
    data: document.getElementById('data').value,
    contacto: getFormattedPhoneNumber(),
    numeroVoo: document.getElementById('numeroVoo').value.trim(),
    origem: document.getElementById('origem').value.trim(),
    destino: document.getElementById('destino').value.trim(),
    horaPickup: formatarHorarioParaTexto(document.getElementById('horaPickup').value),
    valorTotal: valorTotal,
    valorHotel: valorHotel,
    valorHUB: valorHUB,
    comissaoRecepcao: comissaoRecepcao,
    modoPagamento: document.getElementById('modoPagamento').value,
    pagoParaQuem: document.getElementById('pagoParaQuem').value,
    observacoes: document.getElementById('observacoes').value.trim(),
    status: 'Solicitado'
};

            try {
                if (editingId) {
                    const index = services.findIndex(s => s.id === editingId);
                    if (index !== -1) {
                        services[index] = { ...services[index], ...formData };
                        
                        if (isConnected) {
                            await sendToSheets(services[index]);
                        }
                        
                        showStatus('Transfer atualizado com sucesso!', 'success');
                    }
                    editingId = null;
                } else {
                    const newId = getNextSyncedId();
                    const newService = {
                        id: newId,
                        ...formData,
                        created: new Date().toISOString()
                    };
                    
                    services.push(newService);
                    if (isConnected) {
                        const sheetSuccess = await sendToSheets(newService);
                        if (sheetSuccess) {
                            console.log('Transfer enviado para Google Sheets com sucesso!');
                            showStatus('Transfer adicionado com sucesso!', 'success');
                        } else {
                            showStatus('Transfer adicionado localmente. Erro ao enviar para Sheets.', 'warning');
                        }
                    } else {
                        showStatus('Transfer adicionado localmente. Configure o Google Sheets para sincronizar.', 'warning');
                    }
                }

                saveData();
                renderTable();
                updateSummary();
                clearForm();
                
                document.querySelector('.services-section').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
            } catch (error) {
                console.error('Erro ao processar transfer:', error);
                showStatus('Erro ao processar transfer: ' + error.message, 'error');
            } finally {
                setButtonLoading('submitBtn', false);
            }
        });

        function validateForm() {
            const requiredFields = [
                'nomeCliente', 'numeroPessoas', 'data', 'contacto', 
                'origem', 'destino', 'horaPickup', 'valorTotal', 
                'modoPagamento', 'pagoParaQuem'
            ];

            for (let field of requiredFields) {
                const element = document.getElementById(field);
                console.log(`Campo ${field}:`, element.value, 'Vis√≠vel:', element.style.display !== 'none');
                
                if (!element.value || element.value.trim() === '') {
                    element.focus();
                    showStatus(`Campo obrigat√≥rio n√£o preenchido: ${getFieldLabel(field)}`, 'error');
                    return false;
                }
            }

            const valor = parseFloat(document.getElementById('valorTotal').value);
            if (isNaN(valor) || valor <= 0) {
                document.getElementById('valorTotal').focus();
                showStatus('Valor deve ser um n√∫mero positivo', 'error');
                return false;
            }

            const pessoas = parseInt(document.getElementById('numeroPessoas').value);
            if (isNaN(pessoas) || pessoas < 1) {
                showStatus('N√∫mero de pessoas deve ser pelo menos 1', 'error');
                return false;
            }

            return true;
        }

        function getFieldLabel(fieldId) {
            const labels = {
                'nomeCliente': 'Nome do Cliente',
                'numeroPessoas': 'N√∫mero de Pessoas',
                'data': 'Data do Transfer',
                'contacto': 'Contacto do Cliente',
                'origem': 'Local de Origem',
                'destino': 'Local de Destino',
                'horaPickup': 'Hora de Pick-up',
                'valorTotal': 'Valor do Servi√ßo',
                'modoPagamento': 'Forma de Pagamento',
                'pagoParaQuem': 'Pago Para'
            };
            return labels[fieldId] || fieldId;
        }

        function clearForm() {
            try {
                document.getElementById('transferForm').reset();

                document.getElementById('referencia').value = '';
                document.getElementById('numeroPessoas').value = '';
                document.getElementById('numeroBagagens').value = '0';
                document.getElementById('modoPagamento').value = '';
                document.getElementById('pagoParaQuem').value = '';
                document.getElementById('observacoes').value = '';
                document.getElementById('tourSelecionado').value = '';
                
                currentServiceType = 'transfer';
                precoUnitarioAtual = 0;
                
                document.querySelectorAll('.btn-people, .btn-baggage, .btn-date, .btn-time, .origem-btn, .destino-btn, .btn-price, .btn-payment, .btn-payment-to, .btn-obs, .btn-service').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                document.getElementById('tourSelector').classList.remove('show');
                document.getElementById('priceCalculationBox').classList.remove('show');
                
                document.querySelector('.btn-service').classList.add('active');
                
                editingId = null;
                document.getElementById('submitBtn').textContent = 'Solicitar Transfer';
                
                if (phoneInput) {
                    phoneInput.setNumber('');
                }
                
                document.getElementById('data').valueAsDate = new Date();
                
                console.log('Formul√°rio limpo com sucesso');
                
            } catch (error) {
                console.error('Erro ao limpar formul√°rio:', error);
                showStatus('Erro ao limpar formul√°rio', 'error');
            }
        }

        function getNextSyncedId() {
            const localIds = services.map(s => parseInt(s.id)).filter(id => !isNaN(id));
            const maxLocalId = localIds.length > 0 ? Math.max(...localIds) : 0;
            
            const finalId = Math.max(nextAvailableId, maxLocalId + 1);
            nextAvailableId = finalId + 1;
            
            return finalId;
        }

        // =====================================================
        // EDI√á√ÉO E MANIPULA√á√ÉO DE SERVI√áOS
        // =====================================================
        function editService(id) {
            const service = services.find(s => s.id === id);
            if (!service) {
                showStatus('Servi√ßo n√£o encontrado', 'error');
                return;
            }

            try {
                document.getElementById('nomeCliente').value = service.nomeCliente;
                document.getElementById('referencia').value = service.referencia || '';
                document.getElementById('numeroPessoas').value = service.numeroPessoas;
                document.getElementById('numeroBagagens').value = service.numeroBagagens;
                document.getElementById('data').value = service.data;
                document.getElementById('numeroVoo').value = service.numeroVoo || '';
                document.getElementById('origem').value = service.origem;
                document.getElementById('destino').value = service.destino;
                document.getElementById('horaPickup').value = service.horaPickup;
                document.getElementById('valorTotal').value = service.valorTotal;
                document.getElementById('modoPagamento').value = service.modoPagamento;
                document.getElementById('pagoParaQuem').value = service.pagoParaQuem;
                document.getElementById('observacoes').value = service.observacoes || '';
                
                if (service.tipoServico) {
                    currentServiceType = service.tipoServico;
                    document.querySelectorAll('.btn-service').forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.onclick.toString().includes(service.tipoServico)) {
                            btn.classList.add('active');
                        }
                    });
                    
                    if (service.tourSelecionado) {
                        document.getElementById('tourSelector').classList.add('show');
                        document.getElementById('tourSelecionado').value = service.tourSelecionado;
                    }
                }
                
                if (phoneInput) {
                    phoneInput.setNumber(service.contacto);
                } else {
                    document.getElementById('contacto').value = service.contacto;
                }
                
                updateActiveButtons(service);
                updateCalculation();
                
                editingId = id;
                document.getElementById('submitBtn').textContent = 'Atualizar Transfer';
                
                document.querySelector('.quick-add').scrollIntoView({ 
                    behavior: 'smooth',
                    block: 'start'
                });
                
                showStatus('Editando transfer #' + id, 'success');
                
            } catch (error) {
                console.error('Erro ao editar servi√ßo:', error);
                showStatus('Erro ao carregar dados para edi√ß√£o', 'error');
            }
        }

        function updateActiveButtons(service) {
            document.querySelectorAll('.btn-people').forEach(btn => {
                if (btn.textContent.includes(service.numeroPessoas.toString())) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.btn-baggage').forEach(btn => {
                if (btn.textContent.includes(service.numeroBagagens.toString())) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.btn-price').forEach(btn => {
                if (btn.textContent.includes(service.valorTotal.toString())) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.btn-payment').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(service.modoPagamento.toLowerCase())) {
                    btn.classList.add('active');
                }
            });
            
            document.querySelectorAll('.btn-payment-to').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(service.pagoParaQuem.toLowerCase())) {
                    btn.classList.add('active');
                }
            });
        }

        async function changeStatus(id) {
            const service = services.find(s => s.id === id);
            if (!service) {
                showStatus('Servi√ßo n√£o encontrado', 'error');
                return;
            }

            const statuses = ['Solicitado', 'Confirmado', 'Finalizado', 'Cancelado'];
            const currentIndex = statuses.indexOf(service.status);
            const nextIndex = (currentIndex + 1) % statuses.length;
            
            service.status = statuses[nextIndex];
            
            try {
                saveData();
                renderTable();
                updateSummary();
                
                if (isConnected) {
                    await sendToSheets(service);
                    showStatus(`Status alterado para: ${service.status}`, 'success');
                } else {
                    showStatus(`Status alterado para: ${service.status} (apenas local)`, 'warning');
                }
                
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                showStatus('Erro ao alterar status', 'error');
            }
        }

        function deleteService(id) {
            if (!confirm('Tem certeza que deseja deletar este servi√ßo?')) {
                return;
            }

            try {
                const originalLength = services.length;
                services = services.filter(s => s.id !== id);
                
                if (services.length < originalLength) {
                    saveData();
                    renderTable();
                    updateSummary();
                    showStatus('Transfer deletado com sucesso', 'success');
                } else {
                    showStatus('Transfer n√£o encontrado', 'error');
                }
                
            } catch (error) {
                console.error('Erro ao deletar servi√ßo:', error);
                showStatus('Erro ao deletar transfer', 'error');
            }
        }

        // =====================================================
        // EXPORTA√á√ÉO CSV
        // =====================================================
        function exportToCSV() {
            if (services.length === 0) {
                showStatus('N√£o h√° dados para exportar!', 'warning');
                return;
            }

            try {
                const headers = [
    'ID', 'Cliente', 'Refer√™ncia', 'Tipo Servi√ßo', 'Tour Selecionado', 'Pessoas', 'Bagagens', 
                    'Data', 'Contacto', 'Voo', 'Origem', 'Destino', 'Hora Pick-up', 'Valor Total', 
                    'Valor Hotel', 'Valor HUB', 'Comiss√£o Recep√ß√£o', 'Pagamento', 'Pago Para', 
                    'Status', 'Observa√ß√µes', 'Data Cria√ß√£o'
                ];
                
                let csvContent = headers.join(',') + '\n';
                
                services.forEach(service => {
                    const row = [
    service.id,
    `"${service.nomeCliente}"`,
    `"${service.referencia || ''}"`,
    `"${service.tipoServico || 'Transfer'}"`,
                        `"${service.tourSelecionado || ''}"`,
                        service.numeroPessoas,
                        service.numeroBagagens,
                        service.data,
                        `"${service.contacto}"`,
                        `"${service.numeroVoo || ''}"`,
                        `"${service.origem}"`,
                        `"${service.destino}"`,
                        service.horaPickup,
                        service.valorTotal,
                        service.valorHotel || 0,
                        service.valorHUB || 0,
                        service.comissaoRecepcao || 0,
                        `"${service.modoPagamento}"`,
                        `"${service.pagoParaQuem}"`,
                        service.status,
                        `"${service.observacoes || ''}"`,
                        `"${service.created || ''}"`
                    ];
                    csvContent += row.join(',') + '\n';
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `transfers_TESTE_sistema_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatus(`${services.length} transfers exportados com sucesso!`, 'success');
                
            } catch (error) {
                console.error('Erro ao exportar CSV:', error);
                showStatus('Erro ao exportar dados', 'error');
            }
        }

        // =====================================================
        // INICIALIZA√á√ÉO DO GOOGLE MAPS
        // =====================================================
        function initializeAutocomplete() {
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                try {
                    const origemInput = document.getElementById('origem');
                    const destinoInput = document.getElementById('destino');
                    
                    if (origemInput && destinoInput) {
                        const origemAutocomplete = new google.maps.places.Autocomplete(origemInput, {
                            types: ['establishment', 'geocode'],
                            componentRestrictions: { country: 'pt' }
                        });

                        const destinoAutocomplete = new google.maps.places.Autocomplete(destinoInput, {
                            types: ['establishment', 'geocode'],
                            componentRestrictions: { country: 'pt' }
                        });

                        origemInput.addEventListener('input', function() {
                            document.querySelectorAll('.origem-btn').forEach(btn => btn.classList.remove('active'));
                        });

                        destinoInput.addEventListener('input', function() {
                            document.querySelectorAll('.destino-btn').forEach(btn => btn.classList.remove('active'));
                        });
                        
                        console.log('Google Maps Autocomplete inicializado com sucesso');
                    }
                    
                } catch (error) {
                    console.warn('Erro ao inicializar Google Maps Autocomplete:', error);
                }
            } else {
                if (typeof google === 'undefined') {
                    console.log('Google Maps ainda n√£o carregou, tentando novamente em 2s...');
                    setTimeout(initializeAutocomplete, 2000);
                }
            }
        }

        // =====================================================
        // FUN√á√ïES UTILIT√ÅRIAS E EVENT LISTENERS
        // =====================================================
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const debouncedClientFilter = debounce(updateClientFilter, 500);

        // =====================================================
        // INICIALIZA√á√ÉO PRINCIPAL DO SISTEMA
        // =====================================================
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('Inicializando TESTE Sistema de Transfers v9.0...');
                
                loadData();
                loadSavedFilters();
                
                document.getElementById('data').valueAsDate = new Date();
                
                initializeAutocomplete();
                setTimeout(initializePhoneInput, 1000);
                
                const searchClient = document.getElementById('searchClient');
                if (searchClient) {
                    searchClient.addEventListener('input', debouncedClientFilter);
                }
                
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && e.target.type === 'button') {
                        e.preventDefault();
                    }
                });

                document.addEventListener('keydown', function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        const submitBtn = document.getElementById('submitBtn');
                        if (!submitBtn.disabled) {
                            submitBtn.click();
                        }
                    }
                    
                    if (e.key === 'Escape') {
                        clearForm();
                    }
                });

                window.addEventListener('beforeunload', function(e) {
                    saveData();
                });
                
                setTimeout(async () => {
                    if (services.length === 0) {
                        console.log('Nenhum dado local encontrado, tentando carregar do Google Sheets...');
                        await loadTransfersFromSheets();
                    } else {
                        console.log('Dados locais carregados, renderizando tabela...');
                        renderTable();
                        updateSummary();
                    }
                }, 2000);

                console.log('Sistema inicializado completamente');
                
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                showStatus('Erro na inicializa√ß√£o do sistema', 'error');
            }
        });

        // =====================================================
        // FUN√á√ïES DE DEBUG E DESENVOLVIMENTO
        // =====================================================
        function debugInfo() {
            console.log('=== DEBUG INFO SISTEMA v9.0 ===');
            console.log('Services:', services.length);
            console.log('Connected:', isConnected);
            console.log('Editing ID:', editingId);
            console.log('Phone Input:', phoneInput);
            console.log('Saved URL:', localStorage.getItem('webappUrl'));
            console.log('WEBAPP URL:', WEBAPP_URL);
            console.log('Email de Teste:', TEST_EMAIL);
            console.log('Service Type:', currentServiceType);
            console.log('Admin Mode:', isAdminMode);
            console.log('Active Filters:', activeFilters);
            console.log('Filtered Data:', filteredData.length);
            console.log('Sync In Progress:', syncInProgress);
            console.log('Last Sync Time:', lastSyncTime);
            console.log('Server Data:', serverData.length);
            console.log('Next Available ID:', nextAvailableId);
            console.log('=====================================');
        }

        function resetSystem() {
            if (confirm('ATEN√á√ÉO: Esta a√ß√£o ir√° resetar COMPLETAMENTE o sistema!\n\nTodos os dados locais ser√£o perdidos. Continuar?')) {
                localStorage.clear();
                services = [];
                activeFilters = {
                    dateStart: null,
                    dateEnd: null,
                    status: '',
                    cliente: '',
                    quickPeriod: '',
                    tipoServico: ''
                };
                filteredData = [];
                serverData = [];
                lastSyncTime = null;
                nextAvailableId = 1;
                
                renderTable();
                updateSummary();
                clearForm();
                
                console.log('Sistema resetado completamente');
                showStatus('Sistema resetado com sucesso!', 'success');
            }
        }

        // Exposi√ß√£o das fun√ß√µes de debug para o console
        window.debugInfo = debugInfo;
        window.resetSystem = resetSystem;
        window.syncWithServer = syncWithServer;
        window.testConnection = testConnection;
        window.loadTransfersFromSheets = loadTransfersFromSheets;
        window.testBasicConnectivity = testBasicConnectivity;

        // Garantir que as fun√ß√µes est√£o no escopo global
        window.toggleConfig = toggleConfig;
        window.loadTransfersFromSheets = loadTransfersFromSheets;
        window.testBasicConnectivity = testBasicConnectivity;
        window.clearAllData = clearAllData;
        window.clearTestData = clearTestData;
        window.toggleClearData = toggleClearData;

        // Log final de inicializa√ß√£o
        console.log('TESTE Sistema de Transfers HUB Transfer v9.0');
        console.log('Email configurado para testes:', TEST_EMAIL);
        console.log('URL do WebApp:', WEBAPP_URL);
        console.log('Senha admin: admin2025');
        console.log('Funcionalidades dispon√≠veis no console:');
        console.log('   - debugInfo() - Informa√ß√µes de debug');
        console.log('   - resetSystem() - Reset completo do sistema');
        console.log('   - syncWithServer() - Sincroniza√ß√£o manual');
        console.log('   - testConnection() - Teste de conex√£o');
        console.log('   - loadTransfersFromSheets() - Carregar transfers do Google Sheets');
                
    </script>
</body>
</html>
